---
ms.openlocfilehash: 8b804d23247b95381f3ff83bc12c32215a420fb6
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/01/2020
ms.locfileid: "85614961"
---
### <a name="wpf-appdomain-shutdown-handling-may-now-call-dispatcherinvoke-in-cleanup-of-weak-events"></a><span data-ttu-id="cc36d-101">WPF での AppDomain のシャットダウン処理により、弱いイベントのクリーンアップで Dispatcher.Invoke が呼び出される可能性がある</span><span class="sxs-lookup"><span data-stu-id="cc36d-101">WPF AppDomain Shutdown Handling May Now Call Dispatcher.Invoke in Cleanup of Weak Events</span></span>

#### <a name="details"></a><span data-ttu-id="cc36d-102">説明</span><span class="sxs-lookup"><span data-stu-id="cc36d-102">Details</span></span>

<span data-ttu-id="cc36d-103">.NET Framework 4.7.1 以前のバージョンでは、WPF は AppDomain のシャットダウン中に .NET ファイナライザー スレッドで <xref:System.Windows.Threading.Dispatcher?displayProperty=nameWithType> を作成する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="cc36d-103">In .NET Framework 4.7.1 and earlier versions, WPF potentially creates a <xref:System.Windows.Threading.Dispatcher?displayProperty=nameWithType> on the .NET finalizer thread during AppDomain shutdown.</span></span>  <span data-ttu-id="cc36d-104">これは、.NET Framework 4.7.2 以降のバージョンでは、弱いイベントのクリーンアップをスレッド対応にすることによって修正されました。</span><span class="sxs-lookup"><span data-stu-id="cc36d-104">This was fixed in .NET Framework 4.7.2 and later versions by making the cleanup of weak events thread-aware.</span></span>  <span data-ttu-id="cc36d-105">このため、WPF は <xref:System.Windows.Threading.Dispatcher.Invoke%2A?displayProperty=nameWithType> を呼び出してクリーンアップ プロセスを完了することがあります。特定のアプリケーションでは、このファイナライザーのタイミングの変更により、AppDomain またはプロセスのシャットダウン中に例外が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="cc36d-105">Due to this, WPF may call <xref:System.Windows.Threading.Dispatcher.Invoke%2A?displayProperty=nameWithType> to complete the cleanup process.In certain applications, this change in finalizer timing can potentially cause exceptions during AppDomain or process shutdown.</span></span>  <span data-ttu-id="cc36d-106">これは、プロセスまたは AppDomain のシャットダウン前にワーカー スレッドで実行されているディスパッチャーを正しくシャットダウンしないアプリケーションで一般的に見られます。</span><span class="sxs-lookup"><span data-stu-id="cc36d-106">This is generally seen in applications that do not correctly shut down dispatchers running on worker threads prior to process or AppDomain shutdown.</span></span>  <span data-ttu-id="cc36d-107">そのようなアプリケーションは、ディスパッチャーの有効期間を適切に管理するように注意する必要があります。</span><span class="sxs-lookup"><span data-stu-id="cc36d-107">Such applications should take care to properly manage the lifetime of dispatchers.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="cc36d-108">提案される解決策</span><span class="sxs-lookup"><span data-stu-id="cc36d-108">Suggestion</span></span>

<span data-ttu-id="cc36d-109">.NET Framework 4.7.2 以降のバージョンでは、開発者は、クリーンアップの変更によって発生する可能性のあるタイミングの問題を軽減する (ただし、排除ではない) ために、この修正を無効にすることができます。クリーンアップの変更を無効にするには、次の AppContext フラグを使用します。</span><span class="sxs-lookup"><span data-stu-id="cc36d-109">In .NET Framework 4.7.2 and later versions, developers can disable this fix in order to help alleviate (but not eliminate) timing issues that may occur due to the cleanup change.To disable the change in cleanup, use the following AppContext flag.</span></span><pre><code class="lang-xml">&lt;configuration&gt;&#13;&#10;&lt;runtime&gt;&#13;&#10;&lt;AppContextSwitchOverrides value=&quot;Switch.MS.Internal.DoNotInvokeInWeakEventTableShutdownListener=true&quot;/&gt;&#13;&#10;&lt;/runtime&gt;&#13;&#10;&lt;/configuration&gt;&#13;&#10;</code></pre>

| <span data-ttu-id="cc36d-110">名前</span><span class="sxs-lookup"><span data-stu-id="cc36d-110">Name</span></span>    | <span data-ttu-id="cc36d-111">[値]</span><span class="sxs-lookup"><span data-stu-id="cc36d-111">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="cc36d-112">スコープ</span><span class="sxs-lookup"><span data-stu-id="cc36d-112">Scope</span></span>   | <span data-ttu-id="cc36d-113">エッジ</span><span class="sxs-lookup"><span data-stu-id="cc36d-113">Edge</span></span>        |
| <span data-ttu-id="cc36d-114">バージョン</span><span class="sxs-lookup"><span data-stu-id="cc36d-114">Version</span></span> | <span data-ttu-id="cc36d-115">4.7.2</span><span class="sxs-lookup"><span data-stu-id="cc36d-115">4.7.2</span></span>       |
| <span data-ttu-id="cc36d-116">種類</span><span class="sxs-lookup"><span data-stu-id="cc36d-116">Type</span></span>    | <span data-ttu-id="cc36d-117">再ターゲット中</span><span class="sxs-lookup"><span data-stu-id="cc36d-117">Retargeting</span></span> |
