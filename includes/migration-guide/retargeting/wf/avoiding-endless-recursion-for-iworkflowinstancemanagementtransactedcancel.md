---
ms.openlocfilehash: daf09748e69e70ad982bcee14461b66579f3bb87
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.contentlocale: ja-JP
ms.lasthandoff: 07/01/2020
ms.locfileid: "85614863"
---
### <a name="avoiding-endless-recursion-for-iworkflowinstancemanagementtransactedcancel-and-iworkflowinstancemanagementtransactedterminate"></a><span data-ttu-id="f115c-101">IWorkflowInstanceManagement.TransactedCancel および IWorkflowInstanceManagement.TransactedTerminate の無限再帰の回避</span><span class="sxs-lookup"><span data-stu-id="f115c-101">Avoiding endless recursion for IWorkflowInstanceManagement.TransactedCancel and IWorkflowInstanceManagement.TransactedTerminate</span></span>

#### <a name="details"></a><span data-ttu-id="f115c-102">説明</span><span class="sxs-lookup"><span data-stu-id="f115c-102">Details</span></span>

<span data-ttu-id="f115c-103"><xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> または <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> API を使用してワークフロー サービス インスタンスを取り消すか終了するとき、状況によっては、`Workflow` ランタイムが要求の処理の一部としてサービス インスタンスの永続化を試みるときの無限再帰のために、ワークフロー インスタンスでスタック オーバーフローが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f115c-103">Under some circumstances when using <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedCancel%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement.TransactedTerminate%2A?displayProperty=nameWithType> APIs to cancel or terminate a worklow service instance, the workflow instance may encounter a stack overflow due to endless recursion when the `Workflow` runtime attempts to persist the service instance as part of processing the request.</span></span> <span data-ttu-id="f115c-104">問題は、別のサービスに対する他の未処理 WCF 要求が完了するのをワークフロー インスタンスが待機している状態の場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="f115c-104">The problem occurs if the workflow instance is in a state where it is waiting for some other outstanding WCF request to another service to complete.</span></span> <span data-ttu-id="f115c-105">`TransactedCancel` および `TransactedTerminate` 操作により、ワークフロー サービス インスタンスのキューに登録される作業項目が作成されます。</span><span class="sxs-lookup"><span data-stu-id="f115c-105">The `TransactedCancel` and `TransactedTerminate` operations create work items that are queued for the workflow service instance.</span></span> <span data-ttu-id="f115c-106">これらの作業項目は、`TransactedCancel/TransactedTerminate` 要求の処理の一部としては実行されません。</span><span class="sxs-lookup"><span data-stu-id="f115c-106">These work items are not executed as part of the processing of the `TransactedCancel/TransactedTerminate` request.</span></span> <span data-ttu-id="f115c-107">ワークフロー サービス インスタンスは他の未処理 WCF 要求が完了するのを待ってビジー状態であるため、作成された作業項目はキューに残ります。</span><span class="sxs-lookup"><span data-stu-id="f115c-107">Because the workflow service instance is busy waiting for the other outstanding WCF request to complete, the work item created remains queued.</span></span> <span data-ttu-id="f115c-108">`TransactedCancel/TransactedTerminate` 操作が完了して、クライアントに制御が返されます。</span><span class="sxs-lookup"><span data-stu-id="f115c-108">The `TransactedCancel/TransactedTerminate` operation completes and control is returned back to the client.</span></span> <span data-ttu-id="f115c-109">`TransactedCancel/TransactedTerminate` 操作に関連付けられているトランザクションは、コミットしようとした場合、ワークフロー サービス インスタンスの状態を永続化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f115c-109">When the transaction associated with the `TransactedCancel/TransactedTerminate` operation attempts to commit, it needs to persist the workflow serivce instance state.</span></span> <span data-ttu-id="f115c-110">しかし、インスタンスには未処理の `WCF` 要求があるため、ワークフロー ランタイムはワークフロー サービス インスタンスを永続化できず、無限再帰ループによってスタックがオーバーフローします。`TransactedCancel` と `TransactedTerminate` はメモリ内にのみ作業項目を作成するので、トランザクションが存在してもまったく影響ありません。</span><span class="sxs-lookup"><span data-stu-id="f115c-110">But because there is an outstanding `WCF` request for the instance, the Workflow runtime cannot persist the workflow service instance, and an endless recursion loop leads to the stack overflow.Because `TransactedCancel` and `TransactedTerminate` only create a work item in memory, the fact that a transaction exists doesn't have any effect.</span></span> <span data-ttu-id="f115c-111">トランザクションのロールバックは作業項目を破棄しません。この問題に対処するため、.NET Framework 4.7.2 以降では、ワークフロー サービスの `web.config/app.config` に追加できる `AppSetting` が導入されています。これは、`TransactedCancel` および `TransactedTerminate` のトランザクションを無視するようにサービスに指示します。</span><span class="sxs-lookup"><span data-stu-id="f115c-111">A rollback of the transaction does not discard the work item.To address this issue, starting in .NET Framework 4.7.2, we have introduced an `AppSetting` that can be added to the `web.config/app.config` of the workflow service that tells it to ignore transactions for `TransactedCancel` and `TransactedTerminate`.</span></span> <span data-ttu-id="f115c-112">これにより、ワークフロー インスタンスの永続化を待たずにトランザクションをコミットできます。</span><span class="sxs-lookup"><span data-stu-id="f115c-112">This allows the transaction to commit without waiting for the workflow instance to persist.</span></span> <span data-ttu-id="f115c-113">この機能の AppSetting には、`microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate` という名前が付けられています。</span><span class="sxs-lookup"><span data-stu-id="f115c-113">The AppSetting for this feature is named `microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate`.</span></span> <span data-ttu-id="f115c-114">値 `true` はトランザクションを無視することを示し、したがってスタック オーバーフローが回避されます。</span><span class="sxs-lookup"><span data-stu-id="f115c-114">A value of `true` indicates that the transaction should be ignored, thus avoiding the stack overflow.</span></span> <span data-ttu-id="f115c-115">この AppSetting の既定値は `false` なので、既存のワークフロー サービス インスタンスに影響はありません。</span><span class="sxs-lookup"><span data-stu-id="f115c-115">The default value of this AppSetting is `false`, so existing workflow service instances are not affected.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="f115c-116">提案される解決策</span><span class="sxs-lookup"><span data-stu-id="f115c-116">Suggestion</span></span>

<span data-ttu-id="f115c-117">AppFabric または別の <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> クライアントを使っていて、ワークフロー インスタンスを取り消すか終了しようとするとワークフロー サービス インスタンスでスタック オーバーフローが発生する場合は、ワークフロー サービスの web.config/app.config ファイルの `<appSettings>` セクションに以下を追加できます。</span><span class="sxs-lookup"><span data-stu-id="f115c-117">If you are using AppFabric or another <xref:System.ServiceModel.Activities.IWorkflowInstanceManagement> client and are encountering a stack overflow in the workflow serivce instance when trying to cancel or terminate a workflow instance, you can add the following to the `<appSettings>` section of the web.config/app.config file for the workflow service:</span></span>

<pre><code class="lang-xml">&lt;add key=&quot;microsoft:WorkflowServices:IgnoreTransactionsForTransactedCancelAndTransactedTerminate&quot; value=&quot;true&quot;/&gt;&#13;&#10;</code></pre>

<span data-ttu-id="f115c-118">この問題が発生しない場合は、これを行う必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f115c-118">If you are not encountering the problem, you do not need to do this.</span></span>

| <span data-ttu-id="f115c-119">名前</span><span class="sxs-lookup"><span data-stu-id="f115c-119">Name</span></span>    | <span data-ttu-id="f115c-120">[値]</span><span class="sxs-lookup"><span data-stu-id="f115c-120">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="f115c-121">スコープ</span><span class="sxs-lookup"><span data-stu-id="f115c-121">Scope</span></span>   | <span data-ttu-id="f115c-122">エッジ</span><span class="sxs-lookup"><span data-stu-id="f115c-122">Edge</span></span>        |
| <span data-ttu-id="f115c-123">バージョン</span><span class="sxs-lookup"><span data-stu-id="f115c-123">Version</span></span> | <span data-ttu-id="f115c-124">4.7.2</span><span class="sxs-lookup"><span data-stu-id="f115c-124">4.7.2</span></span>       |
| <span data-ttu-id="f115c-125">種類</span><span class="sxs-lookup"><span data-stu-id="f115c-125">Type</span></span>    | <span data-ttu-id="f115c-126">再ターゲット中</span><span class="sxs-lookup"><span data-stu-id="f115c-126">Retargeting</span></span> |
