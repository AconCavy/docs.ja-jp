---
title: '方法: MetadataLoadContext を使用してアセンブリの内容を検査する'
description: MetadataLoadContext を使用する方法について説明します。この API を使用すると、検査のために .NET アセンブリを読み込むことができます。
author: MSDN-WhiteKnight
ms.date: 03/10/2020
ms.technology: dotnet-standard
ms.openlocfilehash: d2589d51a6e0611504c0133d293d3fdfae32553c
ms.sourcegitcommit: 7980a91f90ae5eca859db7e6bfa03e23e76a1a50
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/13/2020
ms.locfileid: "81242661"
---
# <a name="how-to-inspect-assembly-contents-using-metadataloadcontext"></a><span data-ttu-id="2479a-103">方法: MetadataLoadContext を使用してアセンブリの内容を検査する</span><span class="sxs-lookup"><span data-stu-id="2479a-103">How to: Inspect assembly contents using MetadataLoadContext</span></span>

<span data-ttu-id="2479a-104">既定では、開発者は .NET のリフレクション API を使用して、メインの実行コンテキストに読み込まれたアセンブリの内容を検査することができます。</span><span class="sxs-lookup"><span data-stu-id="2479a-104">The reflection API in .NET by default enables developers to inspect the contents of assemblies loaded into the main execution context.</span></span> <span data-ttu-id="2479a-105">ただし、場合によってはアセンブリを実行コンテキストに読み込むことができないことがあります。その原因としては、それが別のプラットフォームやプロセッサ アーキテクチャ用にコンパイルされた場合や、[参照アセンブリ](reference-assemblies.md)である場合などが考えられます。</span><span class="sxs-lookup"><span data-stu-id="2479a-105">However, sometimes it isn't possible to load an assembly into the execution context, for example, because it was compiled for another platform or processor architecture, or it's a [reference assembly](reference-assemblies.md).</span></span> <span data-ttu-id="2479a-106"><xref:System.Reflection.MetadataLoadContext?displayProperty=fullName> API を使用すると、このようなアセンブリを読み込んで検査することができます。</span><span class="sxs-lookup"><span data-stu-id="2479a-106">The <xref:System.Reflection.MetadataLoadContext?displayProperty=fullName> API allows you to load and inspect such assemblies.</span></span> <span data-ttu-id="2479a-107"><xref:System.Reflection.MetadataLoadContext> に読み込まれたアセンブリは、メタデータとしてのみ扱われます。つまり、アセンブリ内の型を調べることはできますが、そこに含まれるコードを実行することはできません。</span><span class="sxs-lookup"><span data-stu-id="2479a-107">Assemblies loaded into the <xref:System.Reflection.MetadataLoadContext> are treated only as metadata, that is, you can examine types in the assembly, but you can't execute any code contained in it.</span></span> <span data-ttu-id="2479a-108">メインの実行コンテキストとは異なり、<xref:System.Reflection.MetadataLoadContext> によって現在のディレクトリから自動的に依存関係が読み込まれることはありません。代わりに、これに渡された <xref:System.Reflection.MetadataAssemblyResolver> によって指定されるカスタム バインド ロジックが使用されます。</span><span class="sxs-lookup"><span data-stu-id="2479a-108">Unlike the main execution context, the <xref:System.Reflection.MetadataLoadContext> doesn't automatically load dependencies from the current directory; instead it uses the custom binding logic provided by the <xref:System.Reflection.MetadataAssemblyResolver> passed to it.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="2479a-109">必須コンポーネント</span><span class="sxs-lookup"><span data-stu-id="2479a-109">Prerequisites</span></span>

<span data-ttu-id="2479a-110"><xref:System.Reflection.MetadataLoadContext> を使用するには、[System.Reflection.MetadataLoadContext](https://www.nuget.org/packages/System.Reflection.MetadataLoadContext) NuGet パッケージをインストールしてください。</span><span class="sxs-lookup"><span data-stu-id="2479a-110">To use <xref:System.Reflection.MetadataLoadContext>, install the [System.Reflection.MetadataLoadContext](https://www.nuget.org/packages/System.Reflection.MetadataLoadContext) NuGet package.</span></span> <span data-ttu-id="2479a-111">これは、.NET Standard 2.0 に準拠している任意のターゲット フレームワーク (たとえば、.NET Core 2.0 や .NET Framework 4.6.1) でサポートされています。</span><span class="sxs-lookup"><span data-stu-id="2479a-111">It is supported on any .NET Standard 2.0-compliant target framework, for example, .NET Core 2.0 or .NET Framework 4.6.1.</span></span>

## <a name="create-metadataassemblyresolver-for-metadataloadcontext"></a><span data-ttu-id="2479a-112">MetadataLoadContext 用の MetadataAssemblyResolver を作成する</span><span class="sxs-lookup"><span data-stu-id="2479a-112">Create MetadataAssemblyResolver for MetadataLoadContext</span></span>

<span data-ttu-id="2479a-113"><xref:System.Reflection.MetadataLoadContext> を作成するには、<xref:System.Reflection.MetadataAssemblyResolver> のインスタンスを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2479a-113">Creating the <xref:System.Reflection.MetadataLoadContext> requires providing the instance of the <xref:System.Reflection.MetadataAssemblyResolver>.</span></span> <span data-ttu-id="2479a-114">その 1 つを指定するための最も簡単な方法は、<xref:System.Reflection.PathAssemblyResolver> を使用することです。これを使うと、指定したアセンブリ パス文字列のコレクションからアセンブリが解決されます。</span><span class="sxs-lookup"><span data-stu-id="2479a-114">The simplest way to provide one is to use the <xref:System.Reflection.PathAssemblyResolver>, which resolves assemblies from the given collection of assembly path strings.</span></span> <span data-ttu-id="2479a-115">直接検査したいアセンブリだけでなく、このコレクションにも、必要な依存関係がすべて含まれている必要があります。</span><span class="sxs-lookup"><span data-stu-id="2479a-115">This collection, besides assemblies you want to inspect directly, should also include all needed dependencies.</span></span> <span data-ttu-id="2479a-116">たとえば、ある外部アセンブリに配置されているカスタム属性を読み取るには、そのアセンブリを含める必要があります。そうしないと、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="2479a-116">For example, to read the custom attribute located in an external assembly, you should include that assembly or an exception will be thrown.</span></span> <span data-ttu-id="2479a-117">ほとんどの場合は、少なくとも "*コア アセンブリ*"、つまり <xref:System.Object?displayProperty=nameWithType> などの組み込みのシステム型を含むアセンブリを含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="2479a-117">In most cases, you should include at least the *core assembly*, that is, the assembly containing built-in system types, such as <xref:System.Object?displayProperty=nameWithType>.</span></span> <span data-ttu-id="2479a-118">次のコードでは、検査されるアセンブリと、現在のランタイムのコア アセンブリで構成されるコレクションを使用して <xref:System.Reflection.PathAssemblyResolver> を作成する方法が示されています。</span><span class="sxs-lookup"><span data-stu-id="2479a-118">The following code shows how to create the <xref:System.Reflection.PathAssemblyResolver> using the collection consisting of the inspected assembly and the current runtime's core assembly:</span></span>

[!code-csharp[](snippets/inspect-contents-using-metadataloadcontext/MetadataLoadContextSnippets.cs#CoreAssembly)]

<span data-ttu-id="2479a-119">すべての BCL 型にアクセスする必要がある場合は、コレクションにすべてのランタイム アセンブリを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="2479a-119">If you need access to all BCL types, you can include all runtime assemblies in the collection.</span></span> <span data-ttu-id="2479a-120">次のコードでは、検査されるアセンブリと、現在のランタイムのすべてのアセンブリで構成されるコレクションを使用して <xref:System.Reflection.PathAssemblyResolver> を作成する方法が示されています。</span><span class="sxs-lookup"><span data-stu-id="2479a-120">The following code shows how to create the <xref:System.Reflection.PathAssemblyResolver> using the collection consisting of the inspected assembly and all assemblies of the current runtime:</span></span>

[!code-csharp[](snippets/inspect-contents-using-metadataloadcontext/MetadataLoadContextSnippets.cs#RuntimeAssemblies)]

## <a name="create-metadataloadcontext"></a><span data-ttu-id="2479a-121">MetadataLoadContext の作成</span><span class="sxs-lookup"><span data-stu-id="2479a-121">Create MetadataLoadContext</span></span>

<span data-ttu-id="2479a-122"><xref:System.Reflection.MetadataLoadContext> を作成するには、そのコンストラクター <xref:System.Reflection.MetadataLoadContext.%23ctor%28System.Reflection.MetadataAssemblyResolver%2CSystem.String%29> を呼び出します。その際、前に作成した <xref:System.Reflection.MetadataAssemblyResolver> を最初のパラメーターとして渡し、コア アセンブリの名前を 2 番目のパラメーターとして渡します。</span><span class="sxs-lookup"><span data-stu-id="2479a-122">To create the <xref:System.Reflection.MetadataLoadContext>, invoke its constructor <xref:System.Reflection.MetadataLoadContext.%23ctor%28System.Reflection.MetadataAssemblyResolver%2CSystem.String%29>, passing the previously created <xref:System.Reflection.MetadataAssemblyResolver> as the first parameter and the core assembly name as the second parameter.</span></span> <span data-ttu-id="2479a-123">コア アセンブリの名前は省略できます。そうした場合、コンストラクターでは、既定の名前 "mscorlib"、"System.Runtime"、または "netstandard" の使用が試みられます。</span><span class="sxs-lookup"><span data-stu-id="2479a-123">You can omit the core assembly name, in which case the constructor will attempt to use default names: "mscorlib", "System.Runtime", or "netstandard".</span></span>

<span data-ttu-id="2479a-124">コンテキストを作成したら、<xref:System.Reflection.MetadataLoadContext.LoadFromAssemblyPath%2A> などのメソッドを使用して、そのコンテキストにアセンブリを読み込むことができます。</span><span class="sxs-lookup"><span data-stu-id="2479a-124">After you've created the context, you can load assemblies into it using methods such as <xref:System.Reflection.MetadataLoadContext.LoadFromAssemblyPath%2A>.</span></span> <span data-ttu-id="2479a-125">コードの実行に関連するアセンブリを除き、読み込まれたアセンブリに対してすべてのリフレクション API を使用できます。</span><span class="sxs-lookup"><span data-stu-id="2479a-125">You can use all reflection APIs on loaded assemblies except ones that involve code execution.</span></span> <span data-ttu-id="2479a-126"><xref:System.Reflection.MemberInfo.GetCustomAttributes%2A> メソッドにはコンストラクターの実行が含まれているため、<xref:System.Reflection.MetadataLoadContext> でカスタム属性を調べる必要がある場合は、代わりに <xref:System.Reflection.MemberInfo.GetCustomAttributesData%2A> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="2479a-126">The <xref:System.Reflection.MemberInfo.GetCustomAttributes%2A> method does involve the execution of constructors, so use the <xref:System.Reflection.MemberInfo.GetCustomAttributesData%2A> method instead when you need to examine custom attributes in the <xref:System.Reflection.MetadataLoadContext>.</span></span>

<span data-ttu-id="2479a-127">次のコード サンプルでは、<xref:System.Reflection.MetadataLoadContext> が作成され、それにアセンブリが読み込まれ、コンソールにアセンブリ属性が出力されます。</span><span class="sxs-lookup"><span data-stu-id="2479a-127">The following code sample creates <xref:System.Reflection.MetadataLoadContext>, loads the assembly into it, and outputs assembly attributes into the console:</span></span>

[!code-csharp[](snippets/inspect-contents-using-metadataloadcontext/MetadataLoadContextSnippets.cs#CreateContext)]

## <a name="example"></a><span data-ttu-id="2479a-128">例</span><span class="sxs-lookup"><span data-stu-id="2479a-128">Example</span></span>

<span data-ttu-id="2479a-129">完全なコード例については、[MetadataLoadContext サンプルを使用したアセンブリ内容の検査](https://github.com/dotnet/samples/tree/master/core/assembly/MetadataLoadContext)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="2479a-129">For a complete code example, see the [Inspect assembly contents using MetadataLoadContext sample](https://github.com/dotnet/samples/tree/master/core/assembly/MetadataLoadContext).</span></span>
