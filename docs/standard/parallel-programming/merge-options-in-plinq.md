---
title: PLINQ のマージ オプション
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- PLINQ queries, merge options
ms.assetid: e8f7be3b-88de-4f33-ab14-dc008e76c1ba
ms.openlocfilehash: a2c238cb66c5018cd1dd4085c6541ef3c9371beb
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290643"
---
# <a name="merge-options-in-plinq"></a><span data-ttu-id="e7cf1-102">PLINQ のマージ オプション</span><span class="sxs-lookup"><span data-stu-id="e7cf1-102">Merge Options in PLINQ</span></span>
<span data-ttu-id="e7cf1-103">クエリが並列として実行される場合、PLINQ はソース シーケンスをパーティション分割し、複数のスレッドが同時に異なる部分 (通常は別個のスレッド) で動作できるようにします。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-103">When a query is executing as parallel, PLINQ partitions the source sequence so that multiple threads can work on different parts concurrently, typically on separate threads.</span></span> <span data-ttu-id="e7cf1-104">結果を 1 つのスレッドで、たとえば、`foreach` (Visual Basic では `For Each`) ループで使用する場合、すべてのスレッドからの結果を 1 つのシーケンスに再マージする必要があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-104">If the results are to be consumed on one thread, for example, in a `foreach` (`For Each` in Visual Basic) loop, then the results from every thread must be merged back into one sequence.</span></span> <span data-ttu-id="e7cf1-105">PLINQ で実行されるマージの種類は、クエリに存在する演算子によって異なります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-105">The kind of merge that PLINQ performs depends on the operators that are present in the query.</span></span> <span data-ttu-id="e7cf1-106">たとえば、結果に新しい順序を適用する演算子は、すべてのスレッドのすべての要素をバッファリングする必要があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-106">For example, operators that impose a new order on the results must buffer all elements from all threads.</span></span> <span data-ttu-id="e7cf1-107">消費スレッド (アプリケーション ユーザーのものでもある) 観点から、完全にバッファリングされたクエリは、最初の結果が生成される前に非常に長い期間実行される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-107">From the perspective of the consuming thread (which is also that of the application user) a fully buffered query might run for a noticeable period of time before it produces its first result.</span></span> <span data-ttu-id="e7cf1-108">既定では、その他の演算子は部分的にバッファリングされ、結果はバッチ単位で生成されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-108">Other operators, by default, are partially buffered; they yield their results in batches.</span></span> <span data-ttu-id="e7cf1-109">既定では、1 つの演算子 <xref:System.Linq.ParallelEnumerable.ForAll%2A> がバッファリングされることはありません。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-109">One operator, <xref:System.Linq.ParallelEnumerable.ForAll%2A> is not buffered by default.</span></span> <span data-ttu-id="e7cf1-110">すべてのスレッドのすべての要素はすぐに生成されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-110">It yields all elements from all threads immediately.</span></span>  
  
 <span data-ttu-id="e7cf1-111">以下の例に示すように、<xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> メソッドを使用することで、PLINQ に、実行するマージの種類を示すヒントを提供できます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-111">By using the <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> method, as shown in the following example, you can provide a hint to PLINQ that indicates what kind of merging to perform.</span></span>  
  
 [!code-csharp[PLINQ#26](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinqsamples.cs#26)]
 [!code-vb[PLINQ#26](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#26)]  
  
 <span data-ttu-id="e7cf1-112">コード例全体については、「[方法:PLINQ のマージ オプションを指定する](how-to-specify-merge-options-in-plinq.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-112">For the complete example, see [How to: Specify Merge Options in PLINQ](how-to-specify-merge-options-in-plinq.md).</span></span>  
  
 <span data-ttu-id="e7cf1-113">特定のクエリで要求されたオプションをサポートできない場合は、オプションが無視されるだけです。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-113">If the particular query cannot support the requested option, then the option will just be ignored.</span></span> <span data-ttu-id="e7cf1-114">ほとんどの場合、PLINQ クエリのマージ オプションを指定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-114">In most cases, you do not have to specify a merge option for a PLINQ query.</span></span> <span data-ttu-id="e7cf1-115">ただし、場合によっては、テストや測定を行うことで、クエリが既定以外のモードで最適に実行されることがわかることもあります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-115">However, in some cases you may find by testing and measurement that a query executes best in a non-default mode.</span></span> <span data-ttu-id="e7cf1-116">このオプションは、より応答性の高いユーザー インターフェイスを提供するために、チャンク マージ演算子で結果を強制的にストリーミングする場合に一般的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-116">A common use of this option is to force a chunk-merging operator to stream its results in order to provide a more responsive user interface.</span></span>  
  
## <a name="parallelmergeoptions"></a><span data-ttu-id="e7cf1-117">ParallelMergeOptions</span><span class="sxs-lookup"><span data-stu-id="e7cf1-117">ParallelMergeOptions</span></span>  
 <span data-ttu-id="e7cf1-118"><xref:System.Linq.ParallelMergeOptions> 列挙には、サポートされるクエリ形状について、結果が 1 つのスレッドで使用されるときにクエリの最終出力がどのように生成されるかを指定する以下のオプションが含まれます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-118">The <xref:System.Linq.ParallelMergeOptions> enumeration includes the following options that specify, for supported query shapes, how the final output of the query is yielded when the results are consumed on one thread:</span></span>  
  
- `Not Buffered`  
  
     <span data-ttu-id="e7cf1-119"><xref:System.Linq.ParallelMergeOptions.NotBuffered> オプションを指定すると、処理された各要素は、生成されるとすぐに各スレッドから返されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-119">The <xref:System.Linq.ParallelMergeOptions.NotBuffered> option causes each processed element to be returned from each thread as soon as it is produced.</span></span> <span data-ttu-id="e7cf1-120">この動作は、出力の "ストリーミング" に似ています。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-120">This behavior is analogous to "streaming" the output.</span></span> <span data-ttu-id="e7cf1-121"><xref:System.Linq.ParallelEnumerable.AsOrdered%2A> 演算子がクエリに存在する場合、`NotBuffered` ではソース要素の順序が保持されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-121">If the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator is present in the query, `NotBuffered` preserves the order of the source elements.</span></span> <span data-ttu-id="e7cf1-122">`NotBuffered` は使用可能になるとすぐに結果を生成し始めますが、それでも、すべての結果を生成するための合計時間は、他のマージ オプションのいずれかを使用する場合より長くなることがあります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-122">Although `NotBuffered` starts yielding results as soon as they're available, the total time to produce all the results might still be longer than using one of the other merge options.</span></span>  
  
- `Auto Buffered`  
  
     <span data-ttu-id="e7cf1-123"><xref:System.Linq.ParallelMergeOptions.AutoBuffered> オプションを指定すると、クエリで要素がバッファーに収集され、定期的にバッファー コンテンツがすべて一度に消費スレッドに譲渡されます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-123">The <xref:System.Linq.ParallelMergeOptions.AutoBuffered> option causes the query to collect elements into a buffer and then periodically yield the buffer contents all at once to the consuming thread.</span></span> <span data-ttu-id="e7cf1-124">これは、`NotBuffered` の "ストリーミング" 動作を使用する代わりに、"チャンク" 単位でソース データを生成する動作に似ています。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-124">This is analogous to yielding the source data in "chunks" instead of using the "streaming" behavior of `NotBuffered`.</span></span> <span data-ttu-id="e7cf1-125">消費スレッドで最初の要素が使用できるようになるまで、`NotBuffered` よりも `AutoBuffered` のほうが長くかかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-125">`AutoBuffered` may take longer than `NotBuffered` to make the first element available on the consuming thread.</span></span> <span data-ttu-id="e7cf1-126">バッファーのサイズと正確な生成動作を構成することはできず、これらはクエリに関するさまざまな要因によって異なる場合があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-126">The size of the buffer and the exact yielding behavior are not configurable and may vary, depending on various factors that relate to the query.</span></span>  
  
- `FullyBuffered`  
  
     <span data-ttu-id="e7cf1-127"><xref:System.Linq.ParallelMergeOptions.FullyBuffered> オプションを指定すると、要素が生成される前にクエリ全体の出力がバッファリングされます。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-127">The <xref:System.Linq.ParallelMergeOptions.FullyBuffered> option causes the output of the whole query to be buffered before any of the elements are yielded.</span></span> <span data-ttu-id="e7cf1-128">このオプションを使用すると、最初の要素が消費スレッドで使用可能になるまで時間がかかる場合がありますが、それでも他のオプションを使用する場合よりも速く完全な結果が生成される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-128">When you use this option, it can take longer before the first element is available on the consuming thread, but the complete results might still be produced faster than by using the other options.</span></span>  
  
## <a name="query-operators-that-support-merge-options"></a><span data-ttu-id="e7cf1-129">マージ オプションをサポートするクエリ演算子</span><span class="sxs-lookup"><span data-stu-id="e7cf1-129">Query Operators that Support Merge Options</span></span>  
 <span data-ttu-id="e7cf1-130">次の表に、指定された制約に従って、すべてのマージ オプション モードをサポートする演算子をリストします。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-130">The following table lists the operators that support all merge option modes, subject to the specified restrictions.</span></span>  
  
|<span data-ttu-id="e7cf1-131">演算子</span><span class="sxs-lookup"><span data-stu-id="e7cf1-131">Operator</span></span>|<span data-ttu-id="e7cf1-132">制約</span><span class="sxs-lookup"><span data-stu-id="e7cf1-132">Restrictions</span></span>|  
|--------------|------------------|  
|<xref:System.Linq.ParallelEnumerable.AsEnumerable%2A>|<span data-ttu-id="e7cf1-133">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-133">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Cast%2A>|<span data-ttu-id="e7cf1-134">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-134">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Concat%2A>|<span data-ttu-id="e7cf1-135">配列またはリスト ソースのみがある順序付けされていないクエリ。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-135">Non-ordered queries that have an Array or List source only.</span></span>|  
|<xref:System.Linq.ParallelEnumerable.DefaultIfEmpty%2A>|<span data-ttu-id="e7cf1-136">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-136">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.OfType%2A>|<span data-ttu-id="e7cf1-137">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-137">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Reverse%2A>|<span data-ttu-id="e7cf1-138">配列またはリスト ソースのみがある順序付けされていないクエリ。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-138">Non-ordered queries that have an Array or List source only.</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Select%2A>|<span data-ttu-id="e7cf1-139">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-139">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.SelectMany%2A>|<span data-ttu-id="e7cf1-140">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-140">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Skip%2A>|<span data-ttu-id="e7cf1-141">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-141">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Take%2A>|<span data-ttu-id="e7cf1-142">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-142">None</span></span>|  
|<xref:System.Linq.ParallelEnumerable.Where%2A>|<span data-ttu-id="e7cf1-143">None</span><span class="sxs-lookup"><span data-stu-id="e7cf1-143">None</span></span>|  
  
 <span data-ttu-id="e7cf1-144">他のすべての PLINQ クエリ演算子では、ユーザー指定のマージ オプションが無視される場合があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-144">All other PLINQ query operators might ignore user-provided merge options.</span></span> <span data-ttu-id="e7cf1-145">一部のクエリ演算子 (<xref:System.Linq.ParallelEnumerable.Reverse%2A> や <xref:System.Linq.ParallelEnumerable.OrderBy%2A> など) では、すべて生成されて並べ替えられるまで要素を譲渡できません。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-145">Some query operators, for example, <xref:System.Linq.ParallelEnumerable.Reverse%2A> and <xref:System.Linq.ParallelEnumerable.OrderBy%2A>, cannot yield any elements until all have been produced and reordered.</span></span> <span data-ttu-id="e7cf1-146">したがって、<xref:System.Linq.ParallelEnumerable.Reverse%2A> などの演算子も含むクエリで <xref:System.Linq.ParallelMergeOptions> を使用すると、演算子でその結果が生成されるまでクエリではマージ動作が適用されません。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-146">Therefore, when <xref:System.Linq.ParallelMergeOptions> is used in a query that also contains an operator such as <xref:System.Linq.ParallelEnumerable.Reverse%2A>, the merge behavior will not be applied in the query until after that operator has produced its results.</span></span>  
  
 <span data-ttu-id="e7cf1-147">マージ オプションを処理するいくつかの演算子の機能は、ソース シーケンスの種類と、<xref:System.Linq.ParallelEnumerable.AsOrdered%2A> 演算子がクエリで既に使用されているかどうかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-147">The ability of some operators to handle merge options depends on the type of the source sequence, and whether the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator was used earlier in the query.</span></span> <span data-ttu-id="e7cf1-148"><xref:System.Linq.ParallelEnumerable.ForAll%2A> は常に <xref:System.Linq.ParallelMergeOptions.NotBuffered> であり、その要素をすぐに生成します。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-148"><xref:System.Linq.ParallelEnumerable.ForAll%2A> is always <xref:System.Linq.ParallelMergeOptions.NotBuffered> ; it yields its elements immediately.</span></span> <span data-ttu-id="e7cf1-149"><xref:System.Linq.ParallelEnumerable.OrderBy%2A> は常に<xref:System.Linq.ParallelMergeOptions.FullyBuffered> であり、生成の前にリスト全体を並べ替える必要があります。</span><span class="sxs-lookup"><span data-stu-id="e7cf1-149"><xref:System.Linq.ParallelEnumerable.OrderBy%2A> is always <xref:System.Linq.ParallelMergeOptions.FullyBuffered>; it must sort the whole list before it yields.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e7cf1-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="e7cf1-150">See also</span></span>

- [<span data-ttu-id="e7cf1-151">Parallel LINQ (PLINQ)</span><span class="sxs-lookup"><span data-stu-id="e7cf1-151">Parallel LINQ (PLINQ)</span></span>](introduction-to-plinq.md)
- [<span data-ttu-id="e7cf1-152">方法: PLINQ のマージ オプションを指定する</span><span class="sxs-lookup"><span data-stu-id="e7cf1-152">How to: Specify Merge Options in PLINQ</span></span>](how-to-specify-merge-options-in-plinq.md)
