---
title: マネージド スレッド プール
description: バックグラウンド ワーカー スレッドを提供する .NET スレッド プールについて説明します
ms.date: 08/02/2018
helpviewer_keywords:
- thread pooling [.NET]
- thread pools [.NET]
- threading [.NET], thread pool
- threading [.NET], pooling
ms.assetid: 2be05b06-a42e-4c9d-a739-96c21d673927
ms.openlocfilehash: 9bc90acd6d7e1bef81e767ce8c257fed78322554
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/18/2020
ms.locfileid: "94826184"
---
# <a name="the-managed-thread-pool"></a><span data-ttu-id="affd4-103">マネージド スレッド プール</span><span class="sxs-lookup"><span data-stu-id="affd4-103">The managed thread pool</span></span>

<span data-ttu-id="affd4-104"><xref:System.Threading.ThreadPool?displayProperty=nameWithType> クラスを使用すると、システムによって管理されるワーカー スレッドのプールがアプリケーションに提供されます。これを利用すると、開発者は、スレッド管理ではなくアプリケーション タスクに注意を集中できるようになります。</span><span class="sxs-lookup"><span data-stu-id="affd4-104">The <xref:System.Threading.ThreadPool?displayProperty=nameWithType> class provides your application with a pool of worker threads that are managed by the system, allowing you to concentrate on application tasks rather than thread management.</span></span> <span data-ttu-id="affd4-105">バックグラウンド処理が必要な短いタスクがある場合、マネージド スレッド プールを使用すると、複数のスレッドを簡単に利用できます。</span><span class="sxs-lookup"><span data-stu-id="affd4-105">If you have short tasks that require background processing, the managed thread pool is an easy way to take advantage of multiple threads.</span></span> <span data-ttu-id="affd4-106">Framework 4 以降ではスレッド プールのスレッドで非同期タスクを実行する <xref:System.Threading.Tasks.Task> オブジェクトと <xref:System.Threading.Tasks.Task%601> オブジェクトを作成できるため、スレッド プールが飛躍的に使いやすくなっています。</span><span class="sxs-lookup"><span data-stu-id="affd4-106">Use of the thread pool is significantly easier in Framework 4 and later, since you can create <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> objects that perform asynchronous tasks on thread pool threads.</span></span>  
  
<span data-ttu-id="affd4-107">.NET では、[タスク並列ライブラリ (TPL)](../parallel-programming/task-parallel-library-tpl.md)の操作、非同期 I/O 完了、[タイマー](timers.md) コールバック、登録済みの待機操作、デリゲートを使用した非同期メソッド呼び出し、<xref:System.Net?displayProperty=nameWithType> ソケット接続などのさまざまな目的でスレッド プールのスレッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="affd4-107">.NET uses thread pool threads for many purposes, including [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) operations, asynchronous I/O completion, [timer](timers.md) callbacks, registered wait operations, asynchronous method calls using delegates, and <xref:System.Net?displayProperty=nameWithType> socket connections.</span></span>  

## <a name="thread-pool-characteristics"></a><span data-ttu-id="affd4-108">スレッド プールの特徴</span><span class="sxs-lookup"><span data-stu-id="affd4-108">Thread pool characteristics</span></span>

<span data-ttu-id="affd4-109">スレッド プールのスレッドは[バックグラウンド](foreground-and-background-threads.md) スレッドです。</span><span class="sxs-lookup"><span data-stu-id="affd4-109">Thread pool threads are [background](foreground-and-background-threads.md) threads.</span></span> <span data-ttu-id="affd4-110">各スレッドは、既定のスタック サイズを使用し、既定の優先順位で実行されます。また、各スレッドはマルチスレッド アパートメント内にあります。</span><span class="sxs-lookup"><span data-stu-id="affd4-110">Each thread uses the default stack size, runs at the default priority, and is in the multithreaded apartment.</span></span> <span data-ttu-id="affd4-111">タスクを完了したスレッド プール内のスレッドは待機スレッドのキューに戻ります。</span><span class="sxs-lookup"><span data-stu-id="affd4-111">Once a thread in the thread pool completes its task, it's returned to a queue of waiting threads.</span></span> <span data-ttu-id="affd4-112">再利用はこの時点から可能です。</span><span class="sxs-lookup"><span data-stu-id="affd4-112">From this moment it can be reused.</span></span> <span data-ttu-id="affd4-113">これにより、タスクごとに新しいスレッドを作成するという負荷がアプリケーションにかからなくなります。</span><span class="sxs-lookup"><span data-stu-id="affd4-113">This reuse enables applications to avoid the cost of creating a new thread for each task.</span></span>
  
<span data-ttu-id="affd4-114">プロセスごとにスレッド プールが 1 つだけあります。</span><span class="sxs-lookup"><span data-stu-id="affd4-114">There is only one thread pool per process.</span></span>  
  
### <a name="exceptions-in-thread-pool-threads"></a><span data-ttu-id="affd4-115">スレッド プールのスレッドでの例外</span><span class="sxs-lookup"><span data-stu-id="affd4-115">Exceptions in thread pool threads</span></span>

<span data-ttu-id="affd4-116">スレッド プールのスレッドで未処理の例外が発生すると、プロセスが終了します。</span><span class="sxs-lookup"><span data-stu-id="affd4-116">Unhandled exceptions in thread pool threads terminate the process.</span></span> <span data-ttu-id="affd4-117">このルールには次の 3 つの例外があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-117">There are three exceptions to this rule:</span></span>  
  
- <span data-ttu-id="affd4-118"><xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> が呼び出されたため、スレッド プールのスレッドに <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> がスローされる。</span><span class="sxs-lookup"><span data-stu-id="affd4-118">A <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> is thrown in a thread pool thread because <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> was called.</span></span>  
- <span data-ttu-id="affd4-119">アプリケーション ドメインがアンロードされるため、スレッド プールのスレッドに <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> がスローされる。</span><span class="sxs-lookup"><span data-stu-id="affd4-119">A <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> is thrown in a thread pool thread because the application domain is being unloaded.</span></span>  
- <span data-ttu-id="affd4-120">共通言語ランタイムまたはホスト プロセスがスレッドを終了する。</span><span class="sxs-lookup"><span data-stu-id="affd4-120">The common language runtime or a host process terminates the thread.</span></span>  
  
<span data-ttu-id="affd4-121">詳しくは、「[マネージド スレッドの例外](exceptions-in-managed-threads.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="affd4-121">For more information, see [Exceptions in Managed Threads](exceptions-in-managed-threads.md).</span></span>  
  
### <a name="maximum-number-of-thread-pool-threads"></a><span data-ttu-id="affd4-122">スレッド プールのスレッドの最大数</span><span class="sxs-lookup"><span data-stu-id="affd4-122">Maximum number of thread pool threads</span></span>

<span data-ttu-id="affd4-123">スレッド プールのキューに登録できる操作の数は、使用可能なメモリによってのみ制限されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-123">The number of operations that can be queued to the thread pool is limited only by available memory.</span></span> <span data-ttu-id="affd4-124">ただし、スレッド プールによって、プロセスで同時にアクティブにできるスレッドの数が制限されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-124">However, the thread pool limits the number of threads that can be active in the process simultaneously.</span></span> <span data-ttu-id="affd4-125">すべてのスレッド プールのスレッドがビジー状態の場合、追加の作業項目は、それらを実行するスレッドが空くまでキューに登録されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-125">If all thread pool threads are busy, additional work items are queued until threads to execute them become available.</span></span> <span data-ttu-id="affd4-126">プロセスのスレッド プールの既定のサイズは、仮想アドレス空間のサイズなど、いくつかの要素によって決まります。</span><span class="sxs-lookup"><span data-stu-id="affd4-126">The default size of the thread pool for a process depends on several factors, such as the size of the virtual address space.</span></span> <span data-ttu-id="affd4-127">スレッドの数は、プロセスで <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> メソッドを呼び出せば確認できます。</span><span class="sxs-lookup"><span data-stu-id="affd4-127">A process can call the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> method to determine the number of threads.</span></span>  
  
<span data-ttu-id="affd4-128">スレッドの最大数を制御するには、<xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> メソッドと <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="affd4-128">You can control the maximum number of threads by using the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType> methods.</span></span>  

> [!NOTE]
> <span data-ttu-id="affd4-129">共通言語ランタイムをホストするコードでは、[`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md) メソッドを使用してサイズを設定できます。</span><span class="sxs-lookup"><span data-stu-id="affd4-129">Code that hosts the common language runtime can set the size using the [`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md) method.</span></span>  
  
### <a name="thread-pool-minimums"></a><span data-ttu-id="affd4-130">スレッド プールの最小値</span><span class="sxs-lookup"><span data-stu-id="affd4-130">Thread pool minimums</span></span>

<span data-ttu-id="affd4-131">スレッド プールでは、カテゴリごとに指定された最小値に達するまで、要求に応じて新しいワーカー スレッドまたは I/O 完了スレッドが提供されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-131">The thread pool provides new worker threads or I/O completion threads on demand until it reaches a specified minimum for each category.</span></span> <span data-ttu-id="affd4-132">これらの最小値は、<xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType> メソッドを使用して取得できます。</span><span class="sxs-lookup"><span data-stu-id="affd4-132">You can use the <xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType> method to obtain these minimum values.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="affd4-133">要求が少ないときは、スレッド プールの実際のスレッド数が最小値を下回る場合があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-133">When demand is low, the actual number of thread pool threads can fall below the minimum values.</span></span>  
  
<span data-ttu-id="affd4-134">スレッド プールの最小値に達すると、追加のスレッドが作成されるか、いくつかのタスクが完了するまで待機状態になります。</span><span class="sxs-lookup"><span data-stu-id="affd4-134">When a minimum is reached, the thread pool can create additional threads or wait until some tasks complete.</span></span> <span data-ttu-id="affd4-135">スループットを最適化するために、スレッド プールでワーカー スレッドの作成と破棄が行われます。スループットは、タスクの単位時間あたりの完了数として定義されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-135">The thread pool creates and destroys worker threads in order to optimize throughput, which is defined as the number of tasks that complete per unit of time.</span></span> <span data-ttu-id="affd4-136">スレッドが少なすぎると使用可能なリソースが最適に使用されない可能性があり、スレッドが多すぎるとリソースの競合が増える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-136">Too few threads might not make optimal use of available resources, whereas too many threads could increase resource contention.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="affd4-137">アイドル スレッドの最小数は、<xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType> メソッドを使用して増やすことができます。</span><span class="sxs-lookup"><span data-stu-id="affd4-137">You can use the <xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType> method to increase the minimum number of idle threads.</span></span> <span data-ttu-id="affd4-138">ただし、これらの値を必要以上に大きくすると、パフォーマンスの問題が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-138">However, unnecessarily increasing these values can cause performance problems.</span></span> <span data-ttu-id="affd4-139">同時に開始するタスクの数が多すぎる場合は、すべてのタスクで処理速度が低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-139">If too many tasks start at the same time, all of them might appear to be slow.</span></span> <span data-ttu-id="affd4-140">ほとんどの場合、スレッドを割り当てるためのスレッド プール独自のアルゴリズムを使用することでスレッド プールのパフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="affd4-140">In most cases the thread pool will perform better with its own algorithm for allocating threads.</span></span>  

## <a name="using-the-thread-pool"></a><span data-ttu-id="affd4-141">スレッド プールの使用</span><span class="sxs-lookup"><span data-stu-id="affd4-141">Using the thread pool</span></span>

<span data-ttu-id="affd4-142">スレッド プールを使用する場合は、[タスク並列ライブラリ (TPL)](../parallel-programming/task-parallel-library-tpl.md) を使用すると最も簡単です。</span><span class="sxs-lookup"><span data-stu-id="affd4-142">The easiest way to use the thread pool is to use the [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md).</span></span> <span data-ttu-id="affd4-143"><xref:System.Threading.Tasks.Task> や <xref:System.Threading.Tasks.Task%601> などの TPL の型では、既定でスレッド プールのスレッドを使用してタスクが実行されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-143">By default, TPL types like <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> use thread pool threads to run tasks.</span></span>

<span data-ttu-id="affd4-144">また、マネージド コードから <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> (またはアンマネージド コードから [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md)) を呼び出し、タスクを実行するメソッドを表す <xref:System.Threading.WaitCallback?displayProperty=nameWithType> デリゲートを渡すことによってスレッド プールを使用することもできます。</span><span class="sxs-lookup"><span data-stu-id="affd4-144">You can also use the thread pool by calling <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> from managed code (or [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md) from unmanaged code) and passing a <xref:System.Threading.WaitCallback?displayProperty=nameWithType> delegate representing the method that performs the task.</span></span>

<span data-ttu-id="affd4-145">スレッド プールを使用するもう 1 つの方法として、待機操作の関連ワーク アイテムをキューに置く方法もあります。これには、<xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> メソッドを使用し、<xref:System.Threading.WaitHandle?displayProperty=nameWithType> を渡します。その WaitHandle がシグナル状態になるかタイムアウトになると、<xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType> デリゲートによって表されるメソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-145">Another way to use the thread pool is to queue work items that are related to a wait operation by using the <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> method and passing a <xref:System.Threading.WaitHandle?displayProperty=nameWithType> that, when signaled or when timed out, calls the method represented by the <xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType> delegate.</span></span> <span data-ttu-id="affd4-146">スレッド プールのスレッドを使用してコールバック メソッドが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="affd4-146">Thread pool threads are used to invoke callback methods.</span></span>  

<span data-ttu-id="affd4-147">参照先の API ページを例としてご確認ください。</span><span class="sxs-lookup"><span data-stu-id="affd4-147">For the examples, check the referenced API pages.</span></span>
  
## <a name="skipping-security-checks"></a><span data-ttu-id="affd4-148">セキュリティ チェックのスキップ</span><span class="sxs-lookup"><span data-stu-id="affd4-148">Skipping security checks</span></span>

<span data-ttu-id="affd4-149">スレッド プールでは、<xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> メソッドと <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType> メソッドも使用できます。</span><span class="sxs-lookup"><span data-stu-id="affd4-149">The thread pool also provides the <xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType> methods.</span></span> <span data-ttu-id="affd4-150">これらのメソッドは、呼び出し元のスタックが、キューに配置されているタスクの実行時に行われるセキュリティ チェックと無関係であることが確認できる場合にのみ使用します。</span><span class="sxs-lookup"><span data-stu-id="affd4-150">Use these methods only when you are certain that the caller's stack is irrelevant to any security checks performed during the execution of the queued task.</span></span> <span data-ttu-id="affd4-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> と <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> はどちらも呼び出し元のスタックを取り込みます。このスタックは、スレッドがタスクの実行を開始するときにスレッド プールのスレッドのスタックにマージされます。</span><span class="sxs-lookup"><span data-stu-id="affd4-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> both capture the caller's stack, which is merged into the stack of the thread pool thread when the thread begins to execute a task.</span></span> <span data-ttu-id="affd4-152">セキュリティ チェックが必要な場合は、そのスタック全体をチェックする必要があります。</span><span class="sxs-lookup"><span data-stu-id="affd4-152">If a security check is required, the entire stack must be checked.</span></span> <span data-ttu-id="affd4-153">チェックは安全性を提供しますが、パフォーマンスへの影響もあります。</span><span class="sxs-lookup"><span data-stu-id="affd4-153">Although the check provides safety, it also has a performance cost.</span></span>  

## <a name="when-not-to-use-thread-pool-threads"></a><span data-ttu-id="affd4-154">スレッド プールのスレッドを使用しない場合</span><span class="sxs-lookup"><span data-stu-id="affd4-154">When not to use thread pool threads</span></span>

<span data-ttu-id="affd4-155">次のような場合は、スレッド プールのスレッドを使用する代わりに独自のスレッドを作成して管理する方が適切です。</span><span class="sxs-lookup"><span data-stu-id="affd4-155">There are several scenarios in which it's appropriate to create and manage your own threads instead of using thread pool threads:</span></span>  
  
- <span data-ttu-id="affd4-156">フォア グラウンド スレッドが必要な場合。</span><span class="sxs-lookup"><span data-stu-id="affd4-156">You require a foreground thread.</span></span>  
- <span data-ttu-id="affd4-157">スレッドに特定の優先順位を設定する必要がある場合。</span><span class="sxs-lookup"><span data-stu-id="affd4-157">You require a thread to have a particular priority.</span></span>  
- <span data-ttu-id="affd4-158">スレッドを長時間にわたってブロックするタスクがある場合。</span><span class="sxs-lookup"><span data-stu-id="affd4-158">You have tasks that cause the thread to block for long periods of time.</span></span> <span data-ttu-id="affd4-159">スレッド プールには最大数のスレッドが存在するため、多数のスレッド プール スレッドがブロックされると、タスクを開始できなくなることがあります。</span><span class="sxs-lookup"><span data-stu-id="affd4-159">The thread pool has a maximum number of threads, so a large number of blocked thread pool threads might prevent tasks from starting.</span></span>  
- <span data-ttu-id="affd4-160">スレッドをシングルスレッド アパートメント内に配置する必要がある場合。</span><span class="sxs-lookup"><span data-stu-id="affd4-160">You need to place threads into a single-threaded apartment.</span></span> <span data-ttu-id="affd4-161"><xref:System.Threading.ThreadPool> スレッドはすべてマルチスレッド アパートメント内にあります。</span><span class="sxs-lookup"><span data-stu-id="affd4-161">All <xref:System.Threading.ThreadPool> threads are in the multithreaded apartment.</span></span>  
- <span data-ttu-id="affd4-162">安定した ID をスレッドに関連付ける必要がある場合、またはスレッドを特定のタスク専用にする必要がある場合。</span><span class="sxs-lookup"><span data-stu-id="affd4-162">You need to have a stable identity associated with the thread, or to dedicate a thread to a task.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="affd4-163">参照</span><span class="sxs-lookup"><span data-stu-id="affd4-163">See also</span></span>

- <xref:System.Threading.ThreadPool?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType>
- [<span data-ttu-id="affd4-164">タスク並列ライブラリ (TPL)</span><span class="sxs-lookup"><span data-stu-id="affd4-164">Task Parallel Library (TPL)</span></span>](../parallel-programming/task-parallel-library-tpl.md)
- [<span data-ttu-id="affd4-165">方法: タスクから値を返す</span><span class="sxs-lookup"><span data-stu-id="affd4-165">How to: Return a Value from a Task</span></span>](../parallel-programming/how-to-return-a-value-from-a-task.md)
- [<span data-ttu-id="affd4-166">スレッド処理オブジェクトと機能</span><span class="sxs-lookup"><span data-stu-id="affd4-166">Threading Objects and Features</span></span>](threading-objects-and-features.md)
- [<span data-ttu-id="affd4-167">スレッドおよびスレッド処理</span><span class="sxs-lookup"><span data-stu-id="affd4-167">Threads and Threading</span></span>](threads-and-threading.md)
- [<span data-ttu-id="affd4-168">非同期ファイル I/O</span><span class="sxs-lookup"><span data-stu-id="affd4-168">Asynchronous File I/O</span></span>](../io/asynchronous-file-i-o.md)
- [<span data-ttu-id="affd4-169">タイマー</span><span class="sxs-lookup"><span data-stu-id="affd4-169">Timers</span></span>](timers.md)
