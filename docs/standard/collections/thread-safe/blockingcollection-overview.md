---
title: BlockingCollection の概要
description: .NET でのスレッドセーフなコレクション クラスである BlockingCollection<T> について確認します。 このクラスには、多くのスレッドから項目を同時に追加したり取得したりすることができる機能が用意されています。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- BlockingCollection, overview
ms.assetid: 987ea3d7-0ad5-4238-8b64-331ce4eb3f0b
ms.openlocfilehash: 0378d038d6081c7ad04fc233ac151ab2bb223fa5
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/18/2020
ms.locfileid: "94818663"
---
# <a name="blockingcollection-overview"></a><span data-ttu-id="8ace7-104">BlockingCollection の概要</span><span class="sxs-lookup"><span data-stu-id="8ace7-104">BlockingCollection Overview</span></span>
<span data-ttu-id="8ace7-105"><xref:System.Collections.Concurrent.BlockingCollection%601> は、次の機能を提供するスレッド セーフなコレクション クラスです。</span><span class="sxs-lookup"><span data-stu-id="8ace7-105"><xref:System.Collections.Concurrent.BlockingCollection%601> is a thread-safe collection class that provides the following features:</span></span>  
  
- <span data-ttu-id="8ace7-106">Producer-Consumer パターンの実装。</span><span class="sxs-lookup"><span data-stu-id="8ace7-106">An implementation of the Producer-Consumer pattern.</span></span>  
  
- <span data-ttu-id="8ace7-107">複数のスレッドから同時に項目を追加し、取得する。</span><span class="sxs-lookup"><span data-stu-id="8ace7-107">Concurrent adding and taking of items from multiple threads.</span></span>  
  
- <span data-ttu-id="8ace7-108">最大容量 (オプション)。</span><span class="sxs-lookup"><span data-stu-id="8ace7-108">Optional maximum capacity.</span></span>  
  
- <span data-ttu-id="8ace7-109">コレクションが空またはいっぱいになったときにブロックする挿入操作と削除操作。</span><span class="sxs-lookup"><span data-stu-id="8ace7-109">Insertion and removal operations that block when collection is empty or full.</span></span>  
  
- <span data-ttu-id="8ace7-110">ブロックせずに実行されるか、指定された時間が経過するまでブロックする、挿入および削除の "試行" 操作。</span><span class="sxs-lookup"><span data-stu-id="8ace7-110">Insertion and removal "try" operations that do not block or that block up to a specified period of time.</span></span>  
  
- <span data-ttu-id="8ace7-111"><xref:System.Collections.Concurrent.IProducerConsumerCollection%601> を実装する任意のコレクション型のカプセル化。</span><span class="sxs-lookup"><span data-stu-id="8ace7-111">Encapsulates any collection type that implements <xref:System.Collections.Concurrent.IProducerConsumerCollection%601></span></span>  
  
- <span data-ttu-id="8ace7-112">キャンセル トークンを使用したキャンセル。</span><span class="sxs-lookup"><span data-stu-id="8ace7-112">Cancellation with cancellation tokens.</span></span>  
  
- <span data-ttu-id="8ace7-113">`foreach` を使用した 2 種類の列挙 (Visual Basic の場合は `For Each`)。</span><span class="sxs-lookup"><span data-stu-id="8ace7-113">Two kinds of enumeration with `foreach` (`For Each` in Visual Basic):</span></span>  
  
    1. <span data-ttu-id="8ace7-114">読み取り専用の列挙。</span><span class="sxs-lookup"><span data-stu-id="8ace7-114">Read-only enumeration.</span></span>  
  
    2. <span data-ttu-id="8ace7-115">列挙された項目を削除する列挙。</span><span class="sxs-lookup"><span data-stu-id="8ace7-115">Enumeration that removes items as they are enumerated.</span></span>  
  
## <a name="bounding-and-blocking-support"></a><span data-ttu-id="8ace7-116">境界とブロッキングのサポート</span><span class="sxs-lookup"><span data-stu-id="8ace7-116">Bounding and Blocking Support</span></span>  
 <span data-ttu-id="8ace7-117"><xref:System.Collections.Concurrent.BlockingCollection%601> はバインドとブロックに対応しています。</span><span class="sxs-lookup"><span data-stu-id="8ace7-117"><xref:System.Collections.Concurrent.BlockingCollection%601> supports bounding and blocking.</span></span> <span data-ttu-id="8ace7-118">境界は、コレクションの最大容量を設定できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-118">Bounding means you can set the maximum capacity of the collection.</span></span> <span data-ttu-id="8ace7-119">境界を使用すると、メモリ内のコレクションの最大サイズを制御し、producer スレッドが consumer スレッドよりも先に進行しすぎるのを防ぐことができます。これは、特定のシナリオで重要になります。</span><span class="sxs-lookup"><span data-stu-id="8ace7-119">Bounding is important in certain scenarios because it enables you to control the maximum size of the collection in memory, and it prevents the producing threads from moving too far ahead of the consuming threads.</span></span>  
  
 <span data-ttu-id="8ace7-120">コレクションには、複数のスレッドやタスクが同時に項目を追加できます。コレクションが指定された最大容量に達すると、producer スレッドは項目が削除されるまでブロックします。</span><span class="sxs-lookup"><span data-stu-id="8ace7-120">Multiple threads or tasks can add items to the collection concurrently, and if the collection reaches its specified maximum capacity, the producing threads will block until an item is removed.</span></span> <span data-ttu-id="8ace7-121">複数の cosumer が同時に項目を削除できます。コレクションが空になった場合、consumer スレッドは、producer が項目を追加するまでブロックします。</span><span class="sxs-lookup"><span data-stu-id="8ace7-121">Multiple consumers can remove items concurrently, and if the collection becomes empty, the consuming threads will block until a producer adds an item.</span></span> <span data-ttu-id="8ace7-122">producer スレッドでは、それ以上項目が追加されないことを示すために、<xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A> を呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-122">A producing thread can call <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A> to indicate that no more items will be added.</span></span> <span data-ttu-id="8ace7-123">consumer では、<xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> プロパティを監視して、コレクションが空になったときや、それ以上の項目は追加されないことになったときを把握できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-123">Consumers monitor the <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> property to know when the collection is empty and no more items will be added.</span></span> <span data-ttu-id="8ace7-124">次の例は、容量の上限が 100 に設定された単純な BlockingCollection を示しています。</span><span class="sxs-lookup"><span data-stu-id="8ace7-124">The following example shows a simple BlockingCollection with a bounded capacity of 100.</span></span> <span data-ttu-id="8ace7-125">いくつかの外部条件が true である間、producer タスクはコレクションに項目を追加し、<xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-125">A producer task adds items to the collection as long as some external condition is true, and then calls <xref:System.Collections.Concurrent.BlockingCollection%601.CompleteAdding%2A>.</span></span> <span data-ttu-id="8ace7-126">consumer タスクは、<xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> プロパティが true になるまで項目を取得します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-126">The consumer task takes items until the <xref:System.Collections.Concurrent.BlockingCollection%601.IsCompleted%2A> property is true.</span></span>  
  
 [!code-csharp[CDS_BlockingCollection#04](../../../../samples/snippets/csharp/VS_Snippets_Misc/cds_blockingcollection/cs/blockingcollection.cs#04)]
 [!code-vb[CDS_BlockingCollection#04](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/cds_blockingcollection/vb/introsnippetsbc.vb#04)]  
  
 <span data-ttu-id="8ace7-127">コード例全体については、「[方法: BlockingCollection の項目を個別に追加および取得する](how-to-add-and-take-items.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-127">For a complete example, see [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="timed-blocking-operations"></a><span data-ttu-id="8ace7-128">時間制限付きのブロッキング操作</span><span class="sxs-lookup"><span data-stu-id="8ace7-128">Timed Blocking Operations</span></span>  
 <span data-ttu-id="8ace7-129">境界のあるコレクションにおける時間制限付きの <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> 操作および <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> 操作では、メソッドは項目を追加または取得しようと試みます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-129">In timed blocking <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> and <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> operations on bounded collections, the method tries to add or take an item.</span></span> <span data-ttu-id="8ace7-130">項目を使用できる場合、その項目は参照渡しで渡された変数に格納され、メソッドは true を返します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-130">If an item is available it is placed into the variable that was passed in by reference, and the method returns true.</span></span> <span data-ttu-id="8ace7-131">指定されたタイムアウト期間を経過しても項目が取得されない場合、メソッドは false を返します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-131">If no item is retrieved after a specified time-out period the method returns false.</span></span> <span data-ttu-id="8ace7-132">その後、再びコレクションへのアクセスを試みる前に、他の必要な処理をスレッドで自由に実行できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-132">The thread is then free to do some other useful work before trying again to access the collection.</span></span> <span data-ttu-id="8ace7-133">時間制限付きアクセス ブロックの例については、「[方法: BlockingCollection の項目を個別に追加および取得する](how-to-add-and-take-items.md)」の 2 つ目の例を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-133">For an example of timed blocking access, see the second example in [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="cancelling-add-and-take-operations"></a><span data-ttu-id="8ace7-134">追加操作と取得操作の取り消し</span><span class="sxs-lookup"><span data-stu-id="8ace7-134">Cancelling Add and Take Operations</span></span>  
 <span data-ttu-id="8ace7-135">追加操作と取得操作は、通常、ループ内で実行されます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-135">Add and Take operations are typically performed in a loop.</span></span> <span data-ttu-id="8ace7-136"><xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> メソッドまたは <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> メソッドに <xref:System.Threading.CancellationToken> を渡し、各イテレーションでトークンの <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> プロパティの値を確認するようにすると、ループを取り消すことができます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-136">You can cancel a loop by passing in a <xref:System.Threading.CancellationToken> to the <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> or <xref:System.Collections.Concurrent.BlockingCollection%601.TryTake%2A> method, and then checking the value of the token's <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property on each iteration.</span></span> <span data-ttu-id="8ace7-137">値が true である場合は、キャンセル要求に応答するかどうかを決定できます。応答するには、リソースをクリーンアップし、ループを終了します。</span><span class="sxs-lookup"><span data-stu-id="8ace7-137">If the value is true, then it is up to you to respond the cancellation request by cleaning up any resources and exiting the loop.</span></span> <span data-ttu-id="8ace7-138">次の例は、キャンセル トークンを受け取る <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> のオーバーロードと、それを使用するコードを示しています。</span><span class="sxs-lookup"><span data-stu-id="8ace7-138">The following example shows an overload of <xref:System.Collections.Concurrent.BlockingCollection%601.TryAdd%2A> that takes a cancellation token, and the code that uses it:</span></span>  
  
 [!code-csharp[CDS_BlockingCollection#05](../../../../samples/snippets/csharp/VS_Snippets_Misc/cds_blockingcollection/cs/blockingcollection.cs#05)]
 [!code-vb[CDS_BlockingCollection#05](../../../../samples/snippets/visualbasic/VS_Snippets_Misc/cds_blockingcollection/vb/introsnippetsbc.vb#05)]  
  
 <span data-ttu-id="8ace7-139">キャンセル サポートを追加する方法の例については、「[方法: BlockingCollection の項目を個別に追加および取得する](how-to-add-and-take-items.md)」の 2 つ目の例を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-139">For an example of how to add cancellation support, see the second example in [How to: Add and Take Items Individually from a BlockingCollection](how-to-add-and-take-items.md).</span></span>  
  
## <a name="specifying-the-collection-type"></a><span data-ttu-id="8ace7-140">コレクションの型の指定</span><span class="sxs-lookup"><span data-stu-id="8ace7-140">Specifying the Collection Type</span></span>  
 <span data-ttu-id="8ace7-141"><xref:System.Collections.Concurrent.BlockingCollection%601> の作成時には、容量の上限だけでなく、使用するコレクションの型も指定できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-141">When you create a <xref:System.Collections.Concurrent.BlockingCollection%601>, you can specify not only the bounded capacity but also the type of collection to use.</span></span> <span data-ttu-id="8ace7-142">たとえば、先入れ先出し法 (FIFO) に <xref:System.Collections.Concurrent.ConcurrentQueue%601> を指定したり、後入れ先出し法 (LIFO) に <xref:System.Collections.Concurrent.ConcurrentStack%601> を指定したりできます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-142">For example, you could specify a <xref:System.Collections.Concurrent.ConcurrentQueue%601> for first in-first out (FIFO) behavior, or a <xref:System.Collections.Concurrent.ConcurrentStack%601> for last in-first out (LIFO) behavior.</span></span> <span data-ttu-id="8ace7-143"><xref:System.Collections.Concurrent.IProducerConsumerCollection%601> インターフェイスを実装する任意のコレクション クラスを使用できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-143">You can use any collection class that implements the <xref:System.Collections.Concurrent.IProducerConsumerCollection%601> interface.</span></span> <span data-ttu-id="8ace7-144"><xref:System.Collections.Concurrent.BlockingCollection%601> の既定のコレクション型は <xref:System.Collections.Concurrent.ConcurrentQueue%601> です。</span><span class="sxs-lookup"><span data-stu-id="8ace7-144">The default collection type for <xref:System.Collections.Concurrent.BlockingCollection%601> is <xref:System.Collections.Concurrent.ConcurrentQueue%601>.</span></span> <span data-ttu-id="8ace7-145">次のコード例は、1000 という容量を持ち、<xref:System.Collections.Concurrent.ConcurrentBag%601> を使用する文字列の <xref:System.Collections.Concurrent.BlockingCollection%601> を作成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="8ace7-145">The following code example shows how to create a <xref:System.Collections.Concurrent.BlockingCollection%601> of strings that has a capacity of 1000 and uses a <xref:System.Collections.Concurrent.ConcurrentBag%601>:</span></span>  
  
```vb  
Dim bc = New BlockingCollection(Of String)(New ConcurrentBag(Of String()), 1000)  
```  
  
```csharp  
BlockingCollection<string> bc = new BlockingCollection<string>(new ConcurrentBag<string>(), 1000 );  
```  
  
 <span data-ttu-id="8ace7-146">詳細については、「[方法:境界ブロッキング機能をコレクションに追加する](how-to-add-bounding-and-blocking.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-146">For more information, see [How to: Add Bounding and Blocking Functionality to a Collection](how-to-add-bounding-and-blocking.md).</span></span>  
  
## <a name="ienumerable-support"></a><span data-ttu-id="8ace7-147">IEnumerable のサポート</span><span class="sxs-lookup"><span data-stu-id="8ace7-147">IEnumerable Support</span></span>  
 <span data-ttu-id="8ace7-148"><xref:System.Collections.Concurrent.BlockingCollection%601> は <xref:System.Collections.Concurrent.BlockingCollection%601.GetConsumingEnumerable%2A> メソッドを提供します。これにより、コンシューマーは `foreach` (Visual Basic では `For Each`) を使用し、コレクションが完了するまで (コレクションが空になり、それ以上項目が追加されなくなるまで)、項目を削除できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-148"><xref:System.Collections.Concurrent.BlockingCollection%601> provides a <xref:System.Collections.Concurrent.BlockingCollection%601.GetConsumingEnumerable%2A> method that enables consumers to use `foreach` (`For Each` in Visual Basic) to remove items until the collection is completed, which means it is empty and no more items will be added.</span></span> <span data-ttu-id="8ace7-149">詳細については、「[方法:ForEach を使用して BlockingCollection 内の項目を削除する](how-to-use-foreach-to-remove.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-149">For more information, see [How to: Use ForEach to Remove Items in a BlockingCollection](how-to-use-foreach-to-remove.md).</span></span>  
  
## <a name="using-many-blockingcollections-as-one"></a><span data-ttu-id="8ace7-150">多数の BlockingCollection を 1 つとして使用する</span><span class="sxs-lookup"><span data-stu-id="8ace7-150">Using Many BlockingCollections As One</span></span>  
 <span data-ttu-id="8ace7-151">consumer が複数のコレクションから同時に項目を取得する必要のあるシナリオでは、<xref:System.Collections.Concurrent.BlockingCollection%601> の配列を作成し、<xref:System.Collections.Concurrent.BlockingCollection%601.TakeFromAny%2A> や <xref:System.Collections.Concurrent.BlockingCollection%601.AddToAny%2A> などの静的メソッドを使用できます。これらのメソッドでは、配列内の任意のコレクションを対象に追加または取得の操作を実行できます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-151">For scenarios in which a consumer needs to take items from multiple collections simultaneously, you can create arrays of <xref:System.Collections.Concurrent.BlockingCollection%601> and use the static methods such as <xref:System.Collections.Concurrent.BlockingCollection%601.TakeFromAny%2A> and <xref:System.Collections.Concurrent.BlockingCollection%601.AddToAny%2A> that will add to or take from any of the collections in the array.</span></span> <span data-ttu-id="8ace7-152">いずれかのコレクションがブロックしている場合、メソッドはすぐに別のコレクションを試します。これは、操作を実行できるコレクションが見つかるまで続行されます。</span><span class="sxs-lookup"><span data-stu-id="8ace7-152">If one collection is blocking, the method immediately tries another until it finds one that can perform the operation.</span></span> <span data-ttu-id="8ace7-153">詳細については、「[方法:パイプラインでブロッキング コレクションの配列を使用する](how-to-use-arrays-of-blockingcollections.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="8ace7-153">For more information, see [How to: Use Arrays of Blocking Collections in a Pipeline](how-to-use-arrays-of-blockingcollections.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8ace7-154">関連項目</span><span class="sxs-lookup"><span data-stu-id="8ace7-154">See also</span></span>

- <xref:System.Collections.Concurrent?displayProperty=nameWithType>
- [<span data-ttu-id="8ace7-155">コレクションとデータ構造体</span><span class="sxs-lookup"><span data-stu-id="8ace7-155">Collections and Data Structures</span></span>](../index.md)
- [<span data-ttu-id="8ace7-156">スレッドセーフなコレクション</span><span class="sxs-lookup"><span data-stu-id="8ace7-156">Thread-Safe Collections</span></span>](index.md)
