---
title: 'チュートリアル: 部分信頼シナリオにおけるコード出力'
description: 部分信頼シナリオでコードを出力する方法について確認します。 リフレクション出力は同じ API を使用しますが、部分的に信頼されるコードでは、一部の機能で特定のアクセス許可が必要となります。
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: 70adb3ce67b45459b18741948092a912f6173731
ms.sourcegitcommit: 3d84eac0818099c9949035feb96bbe0346358504
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/21/2020
ms.locfileid: "86865191"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="bbe20-104">チュートリアル: 部分信頼シナリオにおけるコード出力</span><span class="sxs-lookup"><span data-stu-id="bbe20-104">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="bbe20-105">リフレクション出力は、完全信頼または部分信頼において同じ API セットを使用しますが、部分的に信頼されるコードでは実行する機能によって特定のアクセス許可が必要になります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-105">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="bbe20-106">リフレクション出力には、匿名でホストされる動的メソッドという機能があります。この機能は、透過的セキュリティ アセンブリによって部分信頼で使用されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-106">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="bbe20-107">.NET Framework 3.5 以前では、コード出力を行うには <xref:System.Security.Permissions.ReflectionPermission> に <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> フラグを指定する必要がありました。</span><span class="sxs-lookup"><span data-stu-id="bbe20-107">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="bbe20-108">このアクセス許可は、既定で `FullTrust` および `Intranet` の名前付きアクセス許可セットには含まれますが、`Internet` アクセス許可セットには含まれません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-108">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="bbe20-109">したがって、ライブラリを部分信頼で使用するには、<xref:System.Security.SecurityCriticalAttribute> 属性を設定し、<xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> に対して <xref:System.Security.PermissionSet.Assert%2A> メソッドを実行する必要がありました。</span><span class="sxs-lookup"><span data-stu-id="bbe20-109">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="bbe20-110">このようなライブラリでは、コーディング エラーがあるとセキュリティ ホールが発生するおそれがあるため、セキュリティを慎重にレビューする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-110">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="bbe20-111">コードの生成は本質的に特権を必要とする操作ではないため、.NET Framework 3.5 はセキュリティ確認要求を発行せずに部分信頼シナリオでコードを出力できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-111">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="bbe20-112">これは、生成されたコードには、コードを出力したアセンブリと同等以下のアクセス許可しかないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-112">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="bbe20-113">これにより、コードを出力するライブラリは透過的セキュリティになるため、<xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> を要求する必要がなくなります。つまり、安全なライブラリを記述するためにセキュリティを入念に確認する必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-113">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="bbe20-114">このチュートリアルでは、次の作業について説明します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-114">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="bbe20-115">[部分的に信頼されたコードのテスト用に単純なサンドボックスを設定する](#Setting_up)</span><span class="sxs-lookup"><span data-stu-id="bbe20-115">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="bbe20-116">これは、部分信頼でコードを試す簡単な方法です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-116">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="bbe20-117">実際には信頼されていない場所から取得したコードを実行する場合は、「[How to:Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)」 (方法: サンドボックスで部分信頼コードを実行する) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bbe20-117">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="bbe20-118">[部分的に信頼されたアプリケーション ドメインでコードを実行する](#Running_code)</span><span class="sxs-lookup"><span data-stu-id="bbe20-118">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="bbe20-119">[匿名でホストされる動的メソッドを使用して部分信頼でコードを出力し実行する](#Using_methods)</span><span class="sxs-lookup"><span data-stu-id="bbe20-119">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="bbe20-120">部分信頼シナリオでのコード出力の詳細については、「[リフレクション出力のセキュリティ関連事項](security-issues-in-reflection-emit.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bbe20-120">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="bbe20-121">ここで説明する手順に示すコードの完全な一覧については、このチュートリアルの最後の「[例](#Example)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bbe20-121">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="bbe20-122">部分的に信頼された場所を設定する</span><span class="sxs-lookup"><span data-stu-id="bbe20-122">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="bbe20-123">次の 2 つの手順では、部分信頼でテストできるコードの場所を設定する方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-123">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="bbe20-124">最初の手順では、サンドボックス化されたアプリケーション ドメインを作成する方法について説明します。このドメインでは、インターネット アクセス許可がコードに付与されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-124">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="bbe20-125">2 番目の手順では、部分的に信頼されたアプリケーション ドメインに対し、<xref:System.Security.Permissions.ReflectionPermission> フラグを設定して <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> を追加する方法を説明します。これにより、信頼レベルが同等以下のアセンブリでプライベート データにアクセスできるようになります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-125">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="bbe20-126">サンドボックス化されたアプリケーション ドメインを作成する</span><span class="sxs-lookup"><span data-stu-id="bbe20-126">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="bbe20-127">部分信頼でアセンブリを実行するアプリケーション ドメインを作成するには、<xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> メソッド オーバーロードを使用して、アセンブリに付与するアクセス許可セットを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-127">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="bbe20-128">許可セットを指定するための最も簡単な方法として、セキュリティ ポリシーから名前付きアクセス許可セットを取得する方法があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-128">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="bbe20-129">次の手順では、部分信頼でコードを実行するサンドボックス化されたアプリケーション ドメインを作成し、出力されるコードが、パブリック型のパブリック メンバーにのみアクセスできるというシナリオをテストします。</span><span class="sxs-lookup"><span data-stu-id="bbe20-129">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="bbe20-130">後続の手順では、<xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> を追加する方法を説明し、出力されるコードが、同等以下のアクセス許可を付与されたアセンブリ内にある非パブリックな型とメンバーにアクセスできるというシナリオをテストします。</span><span class="sxs-lookup"><span data-stu-id="bbe20-130">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="bbe20-131">部分信頼でアプリケーション ドメインを作成するには</span><span class="sxs-lookup"><span data-stu-id="bbe20-131">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="bbe20-132">サンドボックス化されたアプリケーション ドメイン内のアセンブリに付与するアクセス許可セットを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-132">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="bbe20-133">ここでは、インターネット ゾーンのアクセス許可セットを使用します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-133">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="bbe20-134">アプリケーション ドメインをアプリケーション パスで初期化するため、<xref:System.AppDomainSetup> オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-134">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="bbe20-135">単純にするため、このコード例では現在のフォルダーを使用します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-135">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="bbe20-136">実際にインターネットから取得されたコードを実行する場合は、信頼できないコード用の別のフォルダーを使用してください。詳細については、「[How to:Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)」 (方法: サンドボックスで部分信頼コードを実行する) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bbe20-136">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="bbe20-137">アプリケーション ドメインで実行されるすべてのアセンブリについて、アプリケーション ドメイン設定情報、および許可セットを指定して、アプリケーション ドメインを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-137">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="bbe20-138"><xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> メソッド オーバーロードの最後のパラメーターを使用すると、アプリケーション ドメインの許可セットではなく、完全な信頼が付与されたアセンブリのセットを指定できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-138">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="bbe20-139">.NET Framework アセンブリはグローバル アセンブリ キャッシュにあるため、アプリケーションで使用するそれらのアセンブリを指定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-139">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="bbe20-140">グローバル アセンブリ キャッシュにあるアセンブリは、常に完全に信頼されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-140">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="bbe20-141">このパラメーターを使用して、グローバル アセンブリ キャッシュには存在しない厳密名のアセンブリを指定できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-141">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="bbe20-142">サンドボックス化されたドメインに RestrictedMemberAccess を追加する</span><span class="sxs-lookup"><span data-stu-id="bbe20-142">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="bbe20-143">ホスト アプリケーションは、匿名でホストされる動的メソッドが、コードを出力するアセンブリの信頼レベルと同等以下の信頼レベルが設定されたアセンブリ内のプライベート データにアクセスすることを許可できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-143">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="bbe20-144">この制限付き機能を有効にして Just-In-Time (JIT) 参照範囲チェックをスキップするため、ホスト アプリケーションは、許可セットに対し、<xref:System.Security.Permissions.ReflectionPermission> (RMA) フラグを設定した <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> オブジェクトを追加します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-144">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="bbe20-145">たとえば、ホストはインターネット アプリケーションに対し、RMA を設定した Internet アクセス許可を付与し、インターネット アプリケーションが独自のアセンブリ内にあるプライベート データにアクセスするコードを出力できるようにすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-145">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="bbe20-146">このアクセスは、信頼レベルが同等以下であるアセンブリに限定されるため、インターネット アプリケーションは、.NET Framework アセンブリのような完全に信頼されたアセンブリのメンバーにはアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-146">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="bbe20-147">特権の昇格を回避するため、匿名でホストされる動的メソッドの作成時にはアセンブリ出力の履歴情報が含まれます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-147">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="bbe20-148">メソッドの呼び出し時に履歴情報がチェックされるため、</span><span class="sxs-lookup"><span data-stu-id="bbe20-148">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="bbe20-149">完全に信頼されたコードから呼び出された、匿名でホストされる動的メソッドは、依然として出力アセンブリの信頼レベルに制限されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-149">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="bbe20-150">RMA を設定した部分信頼でアプリケーション ドメインを作成するには</span><span class="sxs-lookup"><span data-stu-id="bbe20-150">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="bbe20-151"><xref:System.Security.Permissions.ReflectionPermission> (RMA) フラグを指定した新しい <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> オブジェクトを作成し、<xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> メソッドを使用して、許可セットにアクセス許可を追加します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-151">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="bbe20-152">許可セットにアクセス許可が含まれていない場合、<xref:System.Security.PermissionSet.AddPermission%2A> メソッドによって、許可セットにアクセス許可が追加されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-152">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="bbe20-153">許可セットにアクセス許可が含まれている場合は、既存のアクセス許可に指定フラグが追加されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-153">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="bbe20-154">RMA は、匿名でホストされる動的メソッドの 1 つの機能です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-154">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="bbe20-155">通常の動的メソッドが JIT 参照範囲チェックをスキップした場合、出力コードには完全信頼が必要です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-155">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="bbe20-156">アプリケーション ドメイン設定情報、および許可セットを指定して、アプリケーション ドメインを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-156">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="bbe20-157">サンドボックス化されたアプリケーション ドメインでコードを実行する</span><span class="sxs-lookup"><span data-stu-id="bbe20-157">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="bbe20-158">次の手順では、アプリケーション ドメインで実行可能なメソッドを使用してクラスを定義する方法、そのドメインでクラスのインスタンスを作成する方法、そのメソッドを実行する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-158">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="bbe20-159">アプリケーション ドメインでメソッドを定義して実行するには</span><span class="sxs-lookup"><span data-stu-id="bbe20-159">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="bbe20-160"><xref:System.MarshalByRefObject> から派生するクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-160">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="bbe20-161">これにより、他のアプリケーション ドメインにクラスのインスタンスを作成し、アプリケーション ドメインの境界を越えてメソッドを呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-161">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="bbe20-162">この例のクラスの名前は `Worker` です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-162">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="bbe20-163">実行するコードを含むパブリック メソッドを定義します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-163">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="bbe20-164">この例では、コードは単純な動的メソッドを出力し、メソッドを実行するためのデリゲートを作成して、デリゲートを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-164">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="bbe20-165">メイン プログラムで、アセンブリの表示名を取得します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-165">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="bbe20-166">この名前は、サンドボックス化されたアプリケーション ドメインで `Worker` クラスのインスタンスを作成するときに使用します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-166">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="bbe20-167">メイン プログラムでは、このチュートリアルの[最初の手順](#Setting_up)で説明したとおり、サンドボックス化されたアプリケーション ドメインを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-167">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="bbe20-168">`Internet` メソッドはパブリック メソッドのみを使用するため、`SimpleEmitDemo` アクセス許可セットに任意のアクセス許可を追加しないでください。</span><span class="sxs-lookup"><span data-stu-id="bbe20-168">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="bbe20-169">メイン プログラムで、サンドボックス化されたアプリケーション ドメインに `Worker` クラスのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-169">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="bbe20-170"><xref:System.AppDomain.CreateInstanceAndUnwrap%2A> メソッドにより、対象のアプリケーション ドメイン内にオブジェクトが作成され、オブジェクトのプロパティおよびメソッドの呼び出しに使用できるプロキシが返されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-170">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="bbe20-171">Visual Studio でこのコードを使用する場合は、名前空間を含むようにクラスの名前を変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-171">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="bbe20-172">既定では、名前空間がプロジェクト名になります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-172">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="bbe20-173">たとえば、プロジェクト名が "PartialTrust" である場合、クラス名は "PartialTrust.Worker" にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-173">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="bbe20-174">`SimpleEmitDemo` メソッドを呼び出すコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-174">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="bbe20-175">呼び出しはアプリケーションのドメイン境界を越えてマーシャリングされ、コードはサンドボックス化されたアプリケーション ドメインで実行されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-175">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="bbe20-176">匿名でホストされる動的メソッドを使用する</span><span class="sxs-lookup"><span data-stu-id="bbe20-176">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="bbe20-177">匿名でホストされる動的メソッドは、システムが提供する透過的なアセンブリに関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-177">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="bbe20-178">そのため、これらのメッソドに含まれるコードは透過的になります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-178">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="bbe20-179">それに対し、通常の動的メソッドは、直接指定されるか関連付けられた型から推論されるかに関係なく、既存のモジュールに関連付ける必要があり、そのモジュールからセキュリティ レベルを引き継ぎます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-179">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="bbe20-180">次の手順では、匿名のホストを提供するアセンブリに動的メソッドを関連付ける唯一の方法であるコンストラクターの使用法について説明します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-180">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="bbe20-181">匿名のホスト アセンブリでモジュールを明示的に指定することはできません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-181">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="bbe20-182">通常の動的メソッドは、関連付けられているモジュールの内部メンバーまたは関連付けられている型のプライベート メンバーにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-182">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="bbe20-183">匿名でホストされる動的メソッドは他のコードから分離されているため、プライベート データにアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-183">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="bbe20-184">ただし、JIT 参照範囲チェックをスキップしてプライベート データにアクセスするための、制限付き機能が設定されています。</span><span class="sxs-lookup"><span data-stu-id="bbe20-184">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="bbe20-185">この機能が設定されるのは、コードを出力するアセンブリの信頼レベルと同等以下の信頼レベルが設定されたアセンブリに限定されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-185">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="bbe20-186">特権の昇格を回避するため、匿名でホストされる動的メソッドの作成時にはアセンブリ出力の履歴情報が含まれます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-186">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="bbe20-187">メソッドの呼び出し時に履歴情報がチェックされるため、</span><span class="sxs-lookup"><span data-stu-id="bbe20-187">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="bbe20-188">完全に信頼されたコードから呼び出された、匿名でホストされる動的メソッドは、依然として出力アセンブリの信頼レベルに制限されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-188">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="bbe20-189">匿名でホストされる動的メソッドを使用するには</span><span class="sxs-lookup"><span data-stu-id="bbe20-189">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="bbe20-190">関連付けられたモジュールや型を指定しないコンストラクターを使用して、匿名でホストされる動的メソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-190">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="bbe20-191">匿名でホストされる動的メソッドが使用するのがパブリック型とパブリック メソッドのみである場合、メンバー アクセスを制限する必要はなく、JIT 参照範囲チェックをスキップする必要もありません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-191">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="bbe20-192">動的メソッドの出力に必要なアクセス許可はありませんが、出力コードには、そのコードが使用する型やメソッドに応じたアクセス許可が必要です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-192">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="bbe20-193">たとえば、ファイルにアクセスするメソッドを呼び出す出力コードには、<xref:System.Security.Permissions.FileIOPermission> が必要です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-193">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="bbe20-194">信頼レベルに該当のアクセス許可が含まれていないと、出力コードの実行時にセキュリティ例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-194">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="bbe20-195">ここでは、<xref:System.Console.WriteLine%2A?displayProperty=nameWithType> メソッドのみを使用する動的メソッドを出力するコードを示します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-195">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="bbe20-196">このコードは、部分的に信頼された場所から実行できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-196">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="bbe20-197">または、JIT 参照範囲チェックをスキップするために機能を制限した、匿名でホストされる動的メソッドを作成します。これを行うには、<xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> コンストラクターを使用して、`true` パラメーターに `restrictedSkipVisibility` を指定します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-197">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="bbe20-198">ここでの制限は、匿名でホストされる動的メソッドがアクセスできるプライベート データは、出力アセンブリの信頼レベルと同等以下の信頼レベルが設定されたアセンブリ内にあるプライベート データに限定されることを意味します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-198">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="bbe20-199">たとえば、動的メソッドをインターネット信頼で実行している場合、同様にインターネット信頼で実行している他のアセンブリ内にあるプライベート データにはアクセスできますが、.NET Framework アセンブリのプライベート データにはアクセスできません。</span><span class="sxs-lookup"><span data-stu-id="bbe20-199">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="bbe20-200">.NET Framework アセンブリは、グローバル アセンブリ キャッシュにインストールされているもので、常に完全に信頼されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-200">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="bbe20-201">匿名でホストされる動的メソッドは、ホスト アプリケーションが <xref:System.Security.Permissions.ReflectionPermission> フラグが設定された <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> を付与している場合のみ、JIT 参照範囲チェックをスキップして制限付き機能を使用できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-201">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="bbe20-202">このアクセス許可は、メソッドの呼び出し時に要求されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-202">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="bbe20-203">出力アセンブリの呼び出し履歴情報は、動的メソッドの作成時に含まれます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-203">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="bbe20-204">したがって、この要求は、メソッドを呼び出すアセンブリではなく、出力アセンブリのアクセス許可に対して発行されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-204">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="bbe20-205">これにより、昇格されたアクセス権で出力コードが実行されることを回避します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-205">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="bbe20-206">制限付きメンバー アクセスの使用と制約については、このチュートリアルの最後の「[完全なコード例](#Example)」に示します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-206">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="bbe20-207">`Worker` クラスには、参照範囲チェックをスキップするための制限付き機能の有無に関係なく匿名でホストされる動的メソッドを作成できるメソッドが含まれます。例では、異なる信頼レベルを設定したアプリケーション ドメインでこのメソッドを実行した結果も示します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-207">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="bbe20-208">参照範囲チェックをスキップするための制限付き機能は、匿名でホストされる動的メソッドの 1 つの機能です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-208">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="bbe20-209">通常の動的メソッドが JIT 参照範囲チェックをスキップした場合、完全信頼が与えられている必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-209">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="bbe20-210">例</span><span class="sxs-lookup"><span data-stu-id="bbe20-210">Example</span></span>

### <a name="description"></a><span data-ttu-id="bbe20-211">説明</span><span class="sxs-lookup"><span data-stu-id="bbe20-211">Description</span></span>

<span data-ttu-id="bbe20-212"><xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> フラグを使用して、匿名でホストされる動的メソッドが JIT の参照範囲チェックをスキップできるようにするコード例を次に示します。ただし、対象のメンバーの信頼レベルは、コードを出力するアセンブリ以下であることを前提とします。</span><span class="sxs-lookup"><span data-stu-id="bbe20-212">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="bbe20-213">この例では、アプリケーション ドメインの境界を越えてマーシャリングできる `Worker` クラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-213">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="bbe20-214">クラスには、動的メソッドを出力して実行する、`AccessPrivateMethod` メソッド オーバーロードが 2 つあります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-214">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="bbe20-215">最初のオーバーロードは、`PrivateMethod` クラスのプライベート `Worker` メソッドを呼び出す動的メソッドを出力します。これは、JIT の参照範囲チェックを実行するかどうかにかかわらず、動的メソッドを出力できます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-215">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="bbe20-216">2 番目のオーバーロードは、`internal` クラスの `Friend` プロパティ (Visual Basic では <xref:System.String> プロパティ) にアクセスする動的メソッドを出力します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-216">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="bbe20-217">この例では、ヘルパー メソッドを使用して、`Internet` アクセス許可に制限される許可セットを作成します。次に、<xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> メソッド オーバーロードを使用してアプリケーション ドメインを作成し、この許可セットを使用するドメインで実行するすべてのコードを指定します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-217">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="bbe20-218">アプリケーション ドメインに `Worker` クラスのインスタンスを作成し、`AccessPrivateMethod` メソッドを 2 回実行します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-218">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="bbe20-219">`AccessPrivateMethod` メソッドを初めて実行すると、JIT の参照範囲チェックが強制的に実行されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-219">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="bbe20-220">動的メソッドは、JIT の参照範囲チェックによってプライベート メソッドにアクセスできなくなるため、呼び出し時に失敗します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-220">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="bbe20-221">`AccessPrivateMethod` メソッドの 2 回目の実行では、JIT 参照範囲チェックをスキップします。</span><span class="sxs-lookup"><span data-stu-id="bbe20-221">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="bbe20-222">`Internet` 許可セットでは、参照範囲チェックをスキップするのに十分なアクセス許可が付与されていないため、動的メソッドはコンパイル時に失敗します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-222">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="bbe20-223">この例では、<xref:System.Security.Permissions.ReflectionPermission> を指定した <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> を許可セットに追加します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-223">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="bbe20-224">次に、2 番目のドメインを作成し、新しい許可セットにアクセス許可が付与されるドメインで実行するすべてのコードを指定します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-224">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="bbe20-225">新しいアプリケーション ドメインに `Worker` クラスのインスタンスを作成し、`AccessPrivateMethod` メソッドの両方のオーバーロードを実行します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-225">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="bbe20-226">`AccessPrivateMethod` メソッドの最初のオーバーロードが実行され、JIT の参照範囲チェックがスキップされます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-226">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="bbe20-227">コードを出力するアセンブリがプライベート メソッドを含むアセンブリと同じであるため、動的メソッドのコンパイルと実行は成功します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-227">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="bbe20-228">したがって、信頼レベルは同等です。</span><span class="sxs-lookup"><span data-stu-id="bbe20-228">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="bbe20-229">`Worker` クラスを含むアプリケーションに複数のアセンブリが存在する場合、これらは同じ信頼レベルにあるため、どのアセンブリでも同じプロセスが成功します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-229">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="bbe20-230">`AccessPrivateMethod` メソッドの 2 番目のオーバーロードが実行され、JIT の参照範囲チェックは再度スキップされます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-230">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="bbe20-231"><xref:System.String> クラスの `internal` `FirstChar` プロパティへのアクセスを試行するため、ここでは、動的メソッドはコンパイル時に失敗します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-231">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="bbe20-232"><xref:System.String> クラスを含むアセンブリは完全に信頼されます。</span><span class="sxs-lookup"><span data-stu-id="bbe20-232">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="bbe20-233">したがって、コードを出力するアセンブリよりも信頼レベルが高くなります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-233">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="bbe20-234">この比較により、<xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> によって、信頼されたコードのセキュリティを損なうことなく、部分的に信頼されたコードが、部分的に信頼された他のコードの参照範囲チェックをスキップできるようにする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="bbe20-234">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="bbe20-235">コード</span><span class="sxs-lookup"><span data-stu-id="bbe20-235">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="bbe20-236">コードのコンパイル</span><span class="sxs-lookup"><span data-stu-id="bbe20-236">Compiling the Code</span></span>

- <span data-ttu-id="bbe20-237">このコード例を Visual Studio でビルドする場合は、クラスを <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> メソッドに渡すときに、名前空間を含むようにクラスの名前を変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-237">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="bbe20-238">既定では、名前空間がプロジェクト名になります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-238">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="bbe20-239">たとえば、プロジェクト名が "PartialTrust" である場合、クラス名は "PartialTrust.Worker" にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="bbe20-239">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="bbe20-240">関連項目</span><span class="sxs-lookup"><span data-stu-id="bbe20-240">See also</span></span>

- [<span data-ttu-id="bbe20-241">リフレクション出力のセキュリティ関連事項</span><span class="sxs-lookup"><span data-stu-id="bbe20-241">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="bbe20-242">方法: サンドボックスで部分信頼コードを実行する</span><span class="sxs-lookup"><span data-stu-id="bbe20-242">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
