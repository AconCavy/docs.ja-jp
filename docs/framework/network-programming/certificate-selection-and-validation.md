---
title: 証明書の選択と検証
description: SSL/TLS 接続の証明書を選択して検証するために、System.Net クラスで提供されるいくつかの方法を確認します。
ms.date: 03/30/2017
ms.assetid: c933aca2-4cd0-4ff1-9df9-267143f25a6f
ms.openlocfilehash: 2dc63413f5c3a5fadd0d62ad61f0b887697c6a45
ms.sourcegitcommit: da21fc5a8cce1e028575acf31974681a1bc5aeed
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/08/2020
ms.locfileid: "84502653"
---
# <a name="certificate-selection-and-validation"></a><span data-ttu-id="d2a34-103">証明書の選択と検証</span><span class="sxs-lookup"><span data-stu-id="d2a34-103">Certificate Selection and Validation</span></span>
<span data-ttu-id="d2a34-104"><xref:System.Net> クラスは、Secure Socket Layer (SSL) 接続の <xref:System.Security.Cryptography.X509Certificates> を選択および検証する方法を複数サポートしています。</span><span class="sxs-lookup"><span data-stu-id="d2a34-104">The <xref:System.Net> classes support several ways to select and validate <xref:System.Security.Cryptography.X509Certificates> for Secure Socket Layer (SSL) connections.</span></span> <span data-ttu-id="d2a34-105">クライアントは、サーバーに対する認証に 1 つまたは複数の証明書を選択できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-105">A client can select one or more certificates to authenticate itself to a server.</span></span> <span data-ttu-id="d2a34-106">サーバーは、クライアント証明書の認証に固有の属性が 1 つまたは複数あることを必須にすることができます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-106">A server can require that a client certificate have one or more specific attributes for authentication.</span></span>  
  
## <a name="definition"></a><span data-ttu-id="d2a34-107">定義</span><span class="sxs-lookup"><span data-stu-id="d2a34-107">Definition</span></span>  
 <span data-ttu-id="d2a34-108">証明書は、公開キー、属性 (バージョン番号、シリアル番号、有効期限など)、および証明機関のデジタル署名を含む ASCII バイト ストリームです。</span><span class="sxs-lookup"><span data-stu-id="d2a34-108">A certificate is an ASCII byte stream that contains a public key, attributes (such as version number, serial number, and expiration date) and a digital signature from a Certificate Authority.</span></span> <span data-ttu-id="d2a34-109">証明書は、暗号化された接続を確立するため、またはサーバーに対してクライアントを認証するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-109">Certificates are used to establish an encrypted connection or to authenticate a client to a server.</span></span>  
  
## <a name="client-certificate-selection-and-validation"></a><span data-ttu-id="d2a34-110">クライアント証明書の選択と検証</span><span class="sxs-lookup"><span data-stu-id="d2a34-110">Client Certificate Selection and Validation</span></span>  
 <span data-ttu-id="d2a34-111">クライアントは、特定の SSL 接続に 1 つまたは複数の証明書を選択できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-111">A client can select one or more certificates for a specific SSL connection.</span></span> <span data-ttu-id="d2a34-112">クライアント証明書は、Web サーバーまたは SMTP メール サーバーとの SSL 接続と関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-112">Client certificates can be associated with the SSL connection to a web server or an SMTP mail server.</span></span> <span data-ttu-id="d2a34-113">クライアントは、<xref:System.Security.Cryptography.X509Certificates.X509Certificate> または <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> クラス オブジェクトのコレクションに証明書を追加します。</span><span class="sxs-lookup"><span data-stu-id="d2a34-113">A client adds certificates to a collection of <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects.</span></span> <span data-ttu-id="d2a34-114">たとえば、電子メールを使用する場合、証明書コレクションは、<xref:System.Net.Mail.SmtpClient> クラスの <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> プロパティと関連付けられた <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection> のインスタンスです。</span><span class="sxs-lookup"><span data-stu-id="d2a34-114">Using email as an example, the certificate collection is an instance of a <xref:System.Security.Cryptography.X509Certificates.X509CertificateCollection>) associated with the <xref:System.Net.Mail.SmtpClient.ClientCertificates%2A> property of the <xref:System.Net.Mail.SmtpClient> class.</span></span> <span data-ttu-id="d2a34-115"><xref:System.Net.HttpWebRequest> クラスには類似した <xref:System.Net.HttpWebRequest.ClientCertificates%2A> プロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="d2a34-115">The <xref:System.Net.HttpWebRequest> class has a similar <xref:System.Net.HttpWebRequest.ClientCertificates%2A> property.</span></span>  
  
 <span data-ttu-id="d2a34-116"><xref:System.Security.Cryptography.X509Certificates.X509Certificate> クラスと <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> クラスの主な違いは、秘密キーが <xref:System.Security.Cryptography.X509Certificates.X509Certificate> クラスの証明書ストアに存在する必要がある点です。</span><span class="sxs-lookup"><span data-stu-id="d2a34-116">The primary difference between the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class is that the private key must reside in the certificate store for the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> class.</span></span>  
  
 <span data-ttu-id="d2a34-117">証明書がコレクションに追加され、特定の SSL コレクションと関連付けられている場合でも、サーバーが必須としていない場合、サーバーに証明書は送信されません。</span><span class="sxs-lookup"><span data-stu-id="d2a34-117">Even if certificates are added to a collection and associated with a specific SSL connection, no certificates will be sent to the server unless the server requests them.</span></span> <span data-ttu-id="d2a34-118">1 つの接続で複数のクライアント証明書が送信された場合、サーバーから提供された証明書発行者の一覧と、クライアント証明書の発行者名との一致を考慮したアルゴリズムに基づいて、最適な証明書が使用されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-118">If multiple client certificates are set on a connection, the best one will be used based on an algorithm that considers the match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span>  
  
 <span data-ttu-id="d2a34-119"><xref:System.Net.Security.SslStream> クラスは、SSL ハンドシェイクをさらに細かく制御できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-119">The <xref:System.Net.Security.SslStream> class provides even more control over the SSL handshake.</span></span> <span data-ttu-id="d2a34-120">クライアントは、使用するクライアント証明書を選択するデリゲートを指定できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-120">A client can specify a delegate to pick which client certificate to use.</span></span>  
  
 <span data-ttu-id="d2a34-121">リモート サーバーは、クライアント証明書が有効で最新であり、適切な証明機関が署名していることを検証できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-121">A remote server can verify that a client certificate is valid, current, and signed by the appropriate Certificate Authority.</span></span> <span data-ttu-id="d2a34-122">デリゲートを <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> に追加して、証明書の検証を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-122">A delegate can be added to the <xref:System.Net.ServicePointManager.ServerCertificateValidationCallback%2A> to enforce certificate validation.</span></span>  
  
## <a name="client-certificate-selection"></a><span data-ttu-id="d2a34-123">クライアント証明書の選択</span><span class="sxs-lookup"><span data-stu-id="d2a34-123">Client Certificate Selection</span></span>  
 <span data-ttu-id="d2a34-124">.NET Framework は、次の方法でサーバーに提示するクライアント証明書を選択します。</span><span class="sxs-lookup"><span data-stu-id="d2a34-124">The .NET Framework selects the client certificate to present to the server in the following manner:</span></span>  
  
1. <span data-ttu-id="d2a34-125">以前にクライアント証明書がサーバーに提示されていた場合、最初に提示されたときに証明書はキャッシュされ、以降のクライアント証明書要求があった場合に再利用されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-125">If a client certificate was presented previously to the server, the certificate is cached when first presented and is reused for subsequent client certificate requests.</span></span>  
  
2. <span data-ttu-id="d2a34-126">デリゲートが存在する場合は、選択するクライアント証明書として常にデリゲートの結果が使用されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-126">If a delegate is present, always use the result from the delegate as the client certificate to select.</span></span> <span data-ttu-id="d2a34-127">可能な限りキャッシュされた証明書の使用を試行してください。ただし、デリゲートが null を返し、証明書コレクションが空ではない場合、キャッシュされた匿名の資格情報は使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="d2a34-127">Try to use a cached certificate when possible, but do not use cached anonymous credentials if the delegate has returned null and the certificate collection is not empty.</span></span>  
  
3. <span data-ttu-id="d2a34-128">これがクライアント証明書の最初のチャレンジの場合、.NET Framework は、接続に関連付けられている <xref:System.Security.Cryptography.X509Certificates.X509Certificate> または <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> クラス オブジェクトの証明書を列挙し、サーバーから提供された証明書発行元の一覧と、クライアント証明書の発行元の名前との一致を検索します。</span><span class="sxs-lookup"><span data-stu-id="d2a34-128">If this is the first challenge for a client certificate, the Framework enumerates the certificates in <xref:System.Security.Cryptography.X509Certificates.X509Certificate> or the <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> class objects associated with the connection, looking for a match between the list of certificate issuers provided by the server and the client certificate issuer name.</span></span> <span data-ttu-id="d2a34-129">一致した最初の証明書がサーバーに送信されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-129">The first certificate that matches is sent to the server.</span></span> <span data-ttu-id="d2a34-130">一致する証明書がない場合、または証明書コレクションが空の場合、匿名の資格情報がサーバーに送信されます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-130">If no certificate matches or the certificate collection is empty, then an anonymous credential is sent to the server.</span></span>  
  
## <a name="tools-for-certificate-configuration"></a><span data-ttu-id="d2a34-131">証明書構成のツール</span><span class="sxs-lookup"><span data-stu-id="d2a34-131">Tools for Certificate Configuration</span></span>  
 <span data-ttu-id="d2a34-132">クライアントとサーバーの証明書構成には複数のツールを使用できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-132">A number of tools are available for client and server certificate configuration.</span></span>  
  
 <span data-ttu-id="d2a34-133">*Winhttpcertcfg.exe* ツールは、クライアント証明書の構成に使用できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-133">The *Winhttpcertcfg.exe* tool can be used to configure client certificates.</span></span> <span data-ttu-id="d2a34-134">*Winhttpcertcfg.exe* ツールは、Windows Server 2003 リソース キットに付属するツールの 1 つとして提供されています。</span><span class="sxs-lookup"><span data-stu-id="d2a34-134">The *Winhttpcertcfg.exe* tool is provided as one of the tools with the Windows Server 2003 Resource Kit.</span></span> <span data-ttu-id="d2a34-135">このツールは、Windows Server 2003 リソース キット ツールの一部として [www.microsoft.com](https://www.microsoft.com) からダウンロードすることもできます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-135">This tool is also available as a download as part of the Windows Server 2003 Resource Kit Tools at [www.microsoft.com](https://www.microsoft.com).</span></span>  
  
<span data-ttu-id="d2a34-136">*HttpCfg.exe* ツールは、<xref:System.Net.HttpListener> クラスのサーバー証明書の構成に使用できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-136">The *HttpCfg.exe* tool can be used to configure server certificates for the <xref:System.Net.HttpListener> class.</span></span> <span data-ttu-id="d2a34-137">*HttpCfg.exe* ツールは、Windows Server 2003 および Windows XP Service Pack 2 のサポート ツールの 1 つとして提供されています。</span><span class="sxs-lookup"><span data-stu-id="d2a34-137">The *HttpCfg.exe* tool is provided as one of the support tools for Windows Server 2003 and Windows XP Service Pack 2.</span></span> <span data-ttu-id="d2a34-138">*HttpCfg.exe* とその他のサポート ツールは、Windows Server 2003 または Windows XP の既定ではインストールされません。</span><span class="sxs-lookup"><span data-stu-id="d2a34-138">*HttpCfg.exe* and the other support tools are not installed by default on either Windows Server 2003 or Windows XP.</span></span> <span data-ttu-id="d2a34-139">Windows Server 2003 の場合、</span><span class="sxs-lookup"><span data-stu-id="d2a34-139">On Windows Server 2003.</span></span> <span data-ttu-id="d2a34-140">サポート ツールは、Windows Server 2003 CD-ROM 上の次のフォルダーとファイルとは別にインストールされます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-140">the support tools are installed separately from the following folder and file on the Windows Server 2003 CD-ROM:</span></span>  
  
 <span data-ttu-id="d2a34-141">\Support\Tools\Suptools.msi</span><span class="sxs-lookup"><span data-stu-id="d2a34-141">\Support\Tools\Suptools.msi</span></span>  
  
 <span data-ttu-id="d2a34-142">Windows XP Service Pack 2 で使用する場合、Windows XP サポート ツールは、[www.microsoft.com](https://www.microsoft.com) からのダウンロードとして使用できます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-142">For use with Windows XP Service Pack 2, the Windows XP Support Tools are available as a download from [www.microsoft.com](https://www.microsoft.com).</span></span>  
  
 <span data-ttu-id="d2a34-143">*HttpCfg.exe* ツールのバージョンのソース コードは、Windows Server SDK にサンプルとしても付属しています。</span><span class="sxs-lookup"><span data-stu-id="d2a34-143">The source code to a version of the *HttpCfg.exe* tool is also provided as a sample with the Windows Server SDK.</span></span> <span data-ttu-id="d2a34-144">*HttpCfg.exe* サンプルのソース コードは、Windows SDK の一部としてネットワーク サンプルの既定で次のフォルダーにインストールされます。</span><span class="sxs-lookup"><span data-stu-id="d2a34-144">The source code to the *HttpCfg.exe* sample is installed by default with the networking samples as part of the Windows SDK under the following folder:</span></span>  
  
 <span data-ttu-id="d2a34-145">*C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig*</span><span class="sxs-lookup"><span data-stu-id="d2a34-145">*C:\Program Files\Microsoft SDKs\Windows\v1.0\Samples\NetDS\http\serviceconfig*</span></span>  
  
 <span data-ttu-id="d2a34-146">これらのツールに加え、<xref:System.Security.Cryptography.X509Certificates.X509Certificate> クラスと <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> クラスには、ファイル システムから証明書を読み込むメソッドがあります。</span><span class="sxs-lookup"><span data-stu-id="d2a34-146">In addition to these tools, the <xref:System.Security.Cryptography.X509Certificates.X509Certificate> and <xref:System.Security.Cryptography.X509Certificates.X509Certificate2> classes provides methods for loading a certificate from the file system.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d2a34-147">関連項目</span><span class="sxs-lookup"><span data-stu-id="d2a34-147">See also</span></span>

- [<span data-ttu-id="d2a34-148">ネットワーク プログラミングにおけるセキュリティ</span><span class="sxs-lookup"><span data-stu-id="d2a34-148">Security in Network Programming</span></span>](security-in-network-programming.md)
- [<span data-ttu-id="d2a34-149">.NET Framework のネットワーク プログラミング</span><span class="sxs-lookup"><span data-stu-id="d2a34-149">Network Programming in the .NET Framework</span></span>](index.md)
