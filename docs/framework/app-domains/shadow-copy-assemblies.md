---
title: アセンブリのシャドウ コピー
description: アプリケーション ドメインをアンロードしなくても、アプリケーション ドメインで使用されるアセンブリを更新できるように、.NET でのアセンブリのシャドウ コピーについて調べます。
ms.date: 03/30/2017
helpviewer_keywords:
- assemblies [.NET Framework], shadow copying
- application domains, shadow copying assemblies
- shadow copying assemblies
ms.assetid: de8b8759-fca7-4260-896b-5a4973157672
ms.openlocfilehash: a7ff72763dd26dbc50cd37e070c2d25ababa00f3
ms.sourcegitcommit: 1c37a894c923bea021a3cc38ce7cba946357bbe1
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/19/2020
ms.locfileid: "85104565"
---
# <a name="shadow-copying-assemblies"></a><span data-ttu-id="96e66-103">アセンブリのシャドウ コピー</span><span class="sxs-lookup"><span data-stu-id="96e66-103">Shadow Copying Assemblies</span></span>

<span data-ttu-id="96e66-104">シャドウ コピーにより、アプリケーション ドメインをアンロードしなくても、アプリケーション ドメインで使用されるアセンブリを更新できます。</span><span class="sxs-lookup"><span data-stu-id="96e66-104">Shadow copying enables assemblies that are used in an application domain to be updated without unloading the application domain.</span></span> <span data-ttu-id="96e66-105">これは、ASP.NET サイトなど、継続的に使用可能であることが必要なアプリケーションで特に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="96e66-105">This is particularly useful for applications that must be available continuously, such as ASP.NET sites.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="96e66-106">シャドウ コピーは、Windows 8.x Store アプリではサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="96e66-106">Shadow copying is not supported in Windows 8.x Store apps.</span></span>

<span data-ttu-id="96e66-107">共通言語ランタイムは、アセンブリがアンロードされるまでファイルを更新できないように、アセンブリがロードされるときにアセンブリ ファイルをロックします。</span><span class="sxs-lookup"><span data-stu-id="96e66-107">The common language runtime locks an assembly file when the assembly is loaded, so the file cannot be updated until the assembly is unloaded.</span></span> <span data-ttu-id="96e66-108">アプリケーション ドメインからアセンブリをアンロードする唯一の方法は、アプリケーション ドメインをアンロードすることなので、通常の状況では、アセンブリを使用しているすべてのアプリケーション ドメインがアンロードされるまで、そのアセンブリをディスク上で更新することはできません。</span><span class="sxs-lookup"><span data-stu-id="96e66-108">The only way to unload an assembly from an application domain is by unloading the application domain, so under normal circumstances, an assembly cannot be updated on disk until all the application domains that are using it have been unloaded.</span></span>

<span data-ttu-id="96e66-109">ファイルをシャドウ コピーするようにアプリケーション ドメインが構成されると、アプリケーション パスからのアセンブリが別の場所にコピーされて、その場所から読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="96e66-109">When an application domain is configured to shadow copy files, assemblies from the application path are copied to another location and loaded from that location.</span></span> <span data-ttu-id="96e66-110">コピーはロックされますが、元のアセンブリ ファイルはロック解除されて、更新可能になります。</span><span class="sxs-lookup"><span data-stu-id="96e66-110">The copy is locked, but the original assembly file is unlocked and can be updated.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="96e66-111">シャドウ コピーが可能な唯一のアセンブリは、アプリケーション ドメインの構成時に <xref:System.AppDomainSetup.ApplicationBase%2A> または <xref:System.AppDomainSetup.PrivateBinPath%2A> プロパティで指定された、アプリケーション ディレクトリやそのサブディレクトリに保存されているものです。</span><span class="sxs-lookup"><span data-stu-id="96e66-111">The only assemblies that can be shadow copied are those stored in the application directory or its subdirectories, specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties when the application domain is configured.</span></span> <span data-ttu-id="96e66-112">グローバル アセンブリ キャッシュに格納されているアセンブリは、シャドウ コピーされません。</span><span class="sxs-lookup"><span data-stu-id="96e66-112">Assemblies stored in the global assembly cache are not shadow copied.</span></span>

<span data-ttu-id="96e66-113">この記事は、次のセクションで構成されています。</span><span class="sxs-lookup"><span data-stu-id="96e66-113">This article contains the following sections:</span></span>

- <span data-ttu-id="96e66-114">「[シャドウ コピーの有効化と使用](#EnablingAndUsing)」では、シャドウ コピーの基本的な使用方法と使用可能なオプションについて説明します。</span><span class="sxs-lookup"><span data-stu-id="96e66-114">[Enabling and Using Shadow Copying](#EnablingAndUsing) describes the basic use and the options that are available for shadow copying.</span></span>

- <span data-ttu-id="96e66-115">「[起動時のパフォーマンス](#StartupPerformance)」では、起動時のパフォーマンスを改善するために .NET Framework 4 でシャドウ コピーに加えられた変更、および以前のバージョンの動作に戻す方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="96e66-115">[Startup Performance](#StartupPerformance) describes the changes that are made to shadow copying in the .NET Framework 4 to improve startup performance, and how to revert to the behavior of earlier versions.</span></span>

- <span data-ttu-id="96e66-116">「[廃止メソッド](#ObsoleteMethods)」では、.NET Framework 2.0 でシャドウ コピーを制御するためにプロパティとメソッドに加えられた変更について説明します。</span><span class="sxs-lookup"><span data-stu-id="96e66-116">[Obsolete Methods](#ObsoleteMethods) describes the changes that were made to the properties and methods that control shadow copying in the .NET Framework 2.0.</span></span>

<a name="EnablingAndUsing"></a>

## <a name="enabling-and-using-shadow-copying"></a><span data-ttu-id="96e66-117">シャドウ コピーの有効化と使用</span><span class="sxs-lookup"><span data-stu-id="96e66-117">Enabling and Using Shadow Copying</span></span>

<span data-ttu-id="96e66-118"><xref:System.AppDomainSetup> クラスのプロパティを以下のように使用して、シャドウ コピー用のアプリケーション ドメインを構成できます。</span><span class="sxs-lookup"><span data-stu-id="96e66-118">You can use the properties of the <xref:System.AppDomainSetup> class as follows to configure an application domain for shadow copying:</span></span>

- <span data-ttu-id="96e66-119"><xref:System.AppDomainSetup.ShadowCopyFiles%2A> プロパティを文字列値に `"true"` に設定して、シャドウ コピーを有効にします。</span><span class="sxs-lookup"><span data-stu-id="96e66-119">Enable shadow copying by setting the <xref:System.AppDomainSetup.ShadowCopyFiles%2A> property to the string value `"true"`.</span></span>

  <span data-ttu-id="96e66-120">既定では、この設定は、アプリケーション パス内のすべてのアセンブリを、それらが読み込まれる前にダウンロード キャッシュにコピーします。</span><span class="sxs-lookup"><span data-stu-id="96e66-120">By default, this setting causes all assemblies in the application path to be copied to a download cache before they are loaded.</span></span> <span data-ttu-id="96e66-121">これは、他のコンピューターからダウンロードしたファイルを格納するために共通言語ランタイムによって保守されるものと同じキャッシュで、不要になったときには、共通言語ランタイムが自動的にファイルを削除します。</span><span class="sxs-lookup"><span data-stu-id="96e66-121">This is the same cache maintained by the common language runtime to store files downloaded from other computers, and the common language runtime automatically deletes the files when they are no longer needed.</span></span>

- <span data-ttu-id="96e66-122">必要に応じて、<xref:System.AppDomainSetup.CachePath%2A> プロパティと <xref:System.AppDomainSetup.ApplicationName%2A> プロパティを使用して、シャドウ コピーしたファイルのカスタムの場所を設定します。</span><span class="sxs-lookup"><span data-stu-id="96e66-122">Optionally set a custom location for shadow copied files by using the <xref:System.AppDomainSetup.CachePath%2A> property and the <xref:System.AppDomainSetup.ApplicationName%2A> property.</span></span>

  <span data-ttu-id="96e66-123">この場所の基本パスは、<xref:System.AppDomainSetup.ApplicationName%2A> プロパティに <xref:System.AppDomainSetup.CachePath%2A> プロパティをサブディレクトリとして連結することにより形成されます。</span><span class="sxs-lookup"><span data-stu-id="96e66-123">The base path for the location is formed by concatenating the <xref:System.AppDomainSetup.ApplicationName%2A> property to the <xref:System.AppDomainSetup.CachePath%2A> property as a subdirectory.</span></span> <span data-ttu-id="96e66-124">アセンブリは、基本パス自体ではなく、このパスのサブディレクトリにシャドウ コピーされます。</span><span class="sxs-lookup"><span data-stu-id="96e66-124">Assemblies are shadow copied to subdirectories of this path, not to the base path itself.</span></span>

  > [!NOTE]
  > <span data-ttu-id="96e66-125"><xref:System.AppDomainSetup.ApplicationName%2A> プロパティが設定されていない場合、<xref:System.AppDomainSetup.CachePath%2A> プロパティは無視されて、ダウンロード キャッシュが使用されます。</span><span class="sxs-lookup"><span data-stu-id="96e66-125">If the <xref:System.AppDomainSetup.ApplicationName%2A> property is not set, the <xref:System.AppDomainSetup.CachePath%2A> property is ignored and the download cache is used.</span></span> <span data-ttu-id="96e66-126">例外をスローすることはありません。</span><span class="sxs-lookup"><span data-stu-id="96e66-126">No exception is thrown.</span></span>

  <span data-ttu-id="96e66-127">カスタムの場所を指定する場合は、不要になったときに、ディレクトリとコピー済みファイルをユーザーがクリーンアップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="96e66-127">If you specify a custom location, you are responsible for cleaning up the directories and copied files when they are no longer needed.</span></span> <span data-ttu-id="96e66-128">それらは自動的には削除されません。</span><span class="sxs-lookup"><span data-stu-id="96e66-128">They are not deleted automatically.</span></span>

  <span data-ttu-id="96e66-129">シャドウ コピーされるファイル用にカスタムの場所を設定すると良いいくつかの理由があります。</span><span class="sxs-lookup"><span data-stu-id="96e66-129">There are a few reasons why you might want to set a custom location for shadow copied files.</span></span> <span data-ttu-id="96e66-130">アプリケーションが生成するコピーの数が多い場合は、シャドウ コピーされるファイル用にカスタムの場所を設定することができます。</span><span class="sxs-lookup"><span data-stu-id="96e66-130">You might want to set a custom location for shadow copied files if your application generates a large number of copies.</span></span> <span data-ttu-id="96e66-131">ダウンロード キャッシュは有効期間ではなくサイズによって制限されるので、共通言語ランタイムが、まだ使用されているファイルを削除しようとする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="96e66-131">The download cache is limited by size, not by lifetime, so it is possible that the common language runtime will attempt to delete a file that is still in use.</span></span> <span data-ttu-id="96e66-132">カスタムの場所を設定するもう 1 つの状況は、アプリケーションを実行しているユーザーに、共通言語ランタイムがダウンロード キャッシュ用に使用するディレクトリの場所に対する書き込みアクセス権がない場合です。</span><span class="sxs-lookup"><span data-stu-id="96e66-132">Another reason to set a custom location is when users running your application do not have write access to the directory location the common language runtime uses for the download cache.</span></span>

- <span data-ttu-id="96e66-133">必要に応じて、<xref:System.AppDomainSetup.ShadowCopyDirectories%2A> プロパティを使用して、シャドウ コピーするアセンブリの数を制限します。</span><span class="sxs-lookup"><span data-stu-id="96e66-133">Optionally limit the assemblies that are shadow copied by using the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property.</span></span>

  <span data-ttu-id="96e66-134">アプリケーション ドメインのシャドウ コピーを有効にすると、既定では、アプリケーション パス内の、つまり <xref:System.AppDomainSetup.ApplicationBase%2A> と <xref:System.AppDomainSetup.PrivateBinPath%2A> プロパティで指定されたディレクトリ内の、すべてのアセンブリがコピーされます。</span><span class="sxs-lookup"><span data-stu-id="96e66-134">When you enable shadow copying for an application domain, the default is to copy all assemblies in the application path — that is, in the directories specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties.</span></span> <span data-ttu-id="96e66-135">シャドウ コピーするディレクトリのみを含む文字列を作成して、その文字列を <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> プロパティに割り当てることにより、コピー操作を選択したディレクトリに制限できます。</span><span class="sxs-lookup"><span data-stu-id="96e66-135">You can limit the copying to selected directories by creating a string that contains only those directories you want to shadow copy, and assigning the string to the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property.</span></span> <span data-ttu-id="96e66-136">ディレクトリをセミコロンで区切ります。</span><span class="sxs-lookup"><span data-stu-id="96e66-136">Separate the directories with semicolons.</span></span> <span data-ttu-id="96e66-137">シャドウ コピーされるアセンブリは、選択したディレクトリ内のものだけです。</span><span class="sxs-lookup"><span data-stu-id="96e66-137">The only assemblies that are shadow copied are the ones in the selected directories.</span></span>

  > [!NOTE]
  > <span data-ttu-id="96e66-138">文字列を <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> プロパティに割り当てない場合、またはこのプロパティを `null` に設定した場合は、<xref:System.AppDomainSetup.ApplicationBase%2A> と <xref:System.AppDomainSetup.PrivateBinPath%2A> プロパティで指定したディレクトリ内のすべてのアセンブリがシャドウ コピーされます。</span><span class="sxs-lookup"><span data-stu-id="96e66-138">If you don’t assign a string to the <xref:System.AppDomainSetup.ShadowCopyDirectories%2A> property, or if you set this property to `null`, all assemblies in the directories specified by the <xref:System.AppDomainSetup.ApplicationBase%2A> and <xref:System.AppDomainSetup.PrivateBinPath%2A> properties are shadow copied.</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="96e66-139">セミコロンは区切り文字なので、ディレクトリ パスにはセミコロンを含めないでください。</span><span class="sxs-lookup"><span data-stu-id="96e66-139">Directory paths must not contain semicolons, because the semicolon is the delimiter character.</span></span> <span data-ttu-id="96e66-140">セミコロンのためのエスケープ文字はありません。</span><span class="sxs-lookup"><span data-stu-id="96e66-140">There is no escape character for semicolons.</span></span>

<a name="StartupPerformance"></a>

## <a name="startup-performance"></a><span data-ttu-id="96e66-141">起動時のパフォーマンス</span><span class="sxs-lookup"><span data-stu-id="96e66-141">Startup Performance</span></span>

<span data-ttu-id="96e66-142">シャドウ コピーを使用するアプリケーション ドメインを開始するときには、アプリケーション ディレクトリ内のアセンブリをシャドウ コピー ディレクトリにコピーしたり、既にその場所にある場合には検証したりするので、遅延が生じます。</span><span class="sxs-lookup"><span data-stu-id="96e66-142">When an application domain that uses shadow copying starts, there is a delay while assemblies in the application directory are copied to the shadow copy directory, or verified if they are already in that location.</span></span> <span data-ttu-id="96e66-143">.NET Framework 4 の前には、すべてのアセンブリを一時ディレクトリにコピーしていました。</span><span class="sxs-lookup"><span data-stu-id="96e66-143">Before the .NET Framework 4, all assemblies were copied to a temporary directory.</span></span> <span data-ttu-id="96e66-144">各アセンブリを開いて、アセンブリ名を確認し、厳密な名前は検証しました。</span><span class="sxs-lookup"><span data-stu-id="96e66-144">Each assembly was opened to verify the assembly name, and the strong name was validated.</span></span> <span data-ttu-id="96e66-145">各アセンブリを検査して、シャドウ コピーのディレクトリにあるコピーよりも最近に更新されていないかどうかを調べました。</span><span class="sxs-lookup"><span data-stu-id="96e66-145">Each assembly was checked to see whether it had been updated more recently than the copy in the shadow copy directory.</span></span> <span data-ttu-id="96e66-146">更新されていた場合、それはシャドウ コピーのディレクトリにコピーしました。</span><span class="sxs-lookup"><span data-stu-id="96e66-146">If so, it was copied to the shadow copy directory.</span></span> <span data-ttu-id="96e66-147">最後に、一時コピーを破棄しました。</span><span class="sxs-lookup"><span data-stu-id="96e66-147">Finally, the temporary copies were discarded.</span></span>

<span data-ttu-id="96e66-148">.NET Framework 4 以降は、起動時の既定の動作として、アプリケーション ディレクトリ内にある各アセンブリのファイルの日時を、シャドウ コピーのディレクトリ内にあるコピーのファイルの日時と直接比較します。</span><span class="sxs-lookup"><span data-stu-id="96e66-148">Beginning with the .NET Framework 4, the default startup behavior is to directly compare the file date and time of each assembly in the application directory with the file date and time of the copy in the shadow copy directory.</span></span> <span data-ttu-id="96e66-149">アセンブリが更新されている場合は、.NET Framework の以前のバージョンと同じ手順を使用してそれをコピーし、そうでない場合は、シャドウ コピーのディレクトリ内にあるコピーが読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="96e66-149">If the assembly has been updated, it is copied by using the same procedure as in earlier versions of the .NET Framework; otherwise, the copy in the shadow copy directory is loaded.</span></span>

<span data-ttu-id="96e66-150">結果としてのパフォーマンスの改善は、アセンブリの変更頻度が小さく、通常はアセンブリの小さなサブセット内で変更が生じるようなアプリケーションで最大となります。</span><span class="sxs-lookup"><span data-stu-id="96e66-150">The resulting performance improvement is largest for applications in which assemblies do not change frequently and changes usually occur in a small subset of assemblies.</span></span> <span data-ttu-id="96e66-151">アプリケーション内のアセンブリの大部分が頻繁に変更される場合は、新しい既定動作によって、パフォーマンスが低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="96e66-151">If a majority of assemblies in an application change frequently, the new default behavior might cause a performance regression.</span></span> <span data-ttu-id="96e66-152">構成ファイルに [\<shadowCopyVerifyByTimestamp> 要素](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md)と `enabled="false"` を追加すると、.NET Framework の以前のバージョンの起動動作を復元することができます。</span><span class="sxs-lookup"><span data-stu-id="96e66-152">You can restore the startup behavior of previous versions of the .NET Framework by adding the [\<shadowCopyVerifyByTimestamp> element](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md) to the configuration file, with `enabled="false"`.</span></span>

<a name="ObsoleteMethods"></a>

## <a name="obsolete-methods"></a><span data-ttu-id="96e66-153">廃止メソッド</span><span class="sxs-lookup"><span data-stu-id="96e66-153">Obsolete Methods</span></span>

<span data-ttu-id="96e66-154"><xref:System.AppDomain> クラスには、アプリケーション ドメインでシャドウ コピーを制御するために使用できる <xref:System.AppDomain.SetShadowCopyFiles%2A> や <xref:System.AppDomain.ClearShadowCopyPath%2A> などのいくつかのメソッドがありますが、これらは .NET Framework version 2.0 では廃止された機能としてマークされています。</span><span class="sxs-lookup"><span data-stu-id="96e66-154">The <xref:System.AppDomain> class has several methods, such as <xref:System.AppDomain.SetShadowCopyFiles%2A> and <xref:System.AppDomain.ClearShadowCopyPath%2A>, that can be used to control shadow copying on an application domain, but these have been marked obsolete in the .NET Framework version 2.0.</span></span> <span data-ttu-id="96e66-155">シャドウ コピー用にアプリケーション ドメインを構成するには、<xref:System.AppDomainSetup> クラスのプロパティを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="96e66-155">The recommended way to configure an application domain for shadow copying is to use the properties of the <xref:System.AppDomainSetup> class.</span></span>

## <a name="see-also"></a><span data-ttu-id="96e66-156">関連項目</span><span class="sxs-lookup"><span data-stu-id="96e66-156">See also</span></span>

- <xref:System.AppDomainSetup.ShadowCopyFiles%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.CachePath%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ApplicationName%2A?displayProperty=nameWithType>
- <xref:System.AppDomainSetup.ShadowCopyDirectories%2A?displayProperty=nameWithType>
- [<span data-ttu-id="96e66-157">\<shadowCopyVerifyByTimestamp> 要素</span><span class="sxs-lookup"><span data-stu-id="96e66-157">\<shadowCopyVerifyByTimestamp> Element</span></span>](../configure-apps/file-schema/runtime/shadowcopyverifybytimestamp-element.md)
