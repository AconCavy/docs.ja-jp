---
title: コントラクトおよびサービスのエラーの指定と処理
ms.date: 03/30/2017
helpviewer_keywords:
- handling faults [WCF]
ms.assetid: a9696563-d404-4905-942d-1e0834c26dea
ms.openlocfilehash: bbc1ca97c8887ebdfbe30f7dd76549572367efbe
ms.sourcegitcommit: 628e8147ca10187488e6407dab4c4e6ebe0cac47
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/15/2019
ms.locfileid: "72321112"
---
# <a name="specifying-and-handling-faults-in-contracts-and-services"></a><span data-ttu-id="44108-102">コントラクトおよびサービスのエラーの指定と処理</span><span class="sxs-lookup"><span data-stu-id="44108-102">Specifying and Handling Faults in Contracts and Services</span></span>

<span data-ttu-id="44108-103">Windows Communication Foundation (WCF) アプリケーションは、マネージ例外オブジェクトを SOAP エラーオブジェクトに、SOAP エラーオブジェクトをマネージ例外オブジェクトにマップすることによって、エラー状況を処理します。</span><span class="sxs-lookup"><span data-stu-id="44108-103">Windows Communication Foundation (WCF) applications handle error situations by mapping managed exception objects to SOAP fault objects and SOAP fault objects to managed exception objects.</span></span> <span data-ttu-id="44108-104">ここでは、エラー状態がカスタムの SOAP エラーとして公開されるようにコントラクトを設計する方法、そのエラーをサービス実装の一部として返す方法、およびクライアントがそのエラーをキャッチする方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="44108-104">The topics in this section discuss how to design contracts to expose error conditions as custom SOAP faults, how to return such faults as part of service implementation, and how clients catch such faults.</span></span>

## <a name="error-handling-overview"></a><span data-ttu-id="44108-105">エラー処理の概要</span><span class="sxs-lookup"><span data-stu-id="44108-105">Error Handling Overview</span></span>

<span data-ttu-id="44108-106">すべてのマネージド アプリケーションで、操作エラーは <xref:System.Exception> オブジェクトにより表されます。</span><span class="sxs-lookup"><span data-stu-id="44108-106">In all managed applications, processing errors are represented by <xref:System.Exception> objects.</span></span> <span data-ttu-id="44108-107">WCF アプリケーションなどの SOAP ベースのアプリケーションでは、サービスメソッドは SOAP エラーメッセージを使用して処理エラー情報を通信します。</span><span class="sxs-lookup"><span data-stu-id="44108-107">In SOAP-based applications such as WCF applications, service methods communicate processing error information using SOAP fault messages.</span></span> <span data-ttu-id="44108-108">SOAP エラーは、サービス操作のメタデータに含まれるメッセージ型です。これにより、クライアントが操作を堅牢かつインタラクティブにするために使用できるエラー コントラクトを作成できます。</span><span class="sxs-lookup"><span data-stu-id="44108-108">SOAP faults are message types that are included in the metadata for a service operation and therefore create a fault contract that clients can use to make their operation more robust or interactive.</span></span> <span data-ttu-id="44108-109">さらに、SOAP エラーは XML 形式でクライアントに表現されるので、任意の SOAP プラットフォーム上のクライアントが使用できる、相互運用可能な型システムで、WCF アプリケーションの範囲を広げることができます。</span><span class="sxs-lookup"><span data-stu-id="44108-109">In addition, because SOAP faults are expressed to clients in XML form, it is a highly interoperable type system that clients on any SOAP platform can use, increasing the reach of your WCF application.</span></span>

<span data-ttu-id="44108-110">WCF アプリケーションは両方の種類のエラーシステムで実行されるため、クライアントに送信されるマネージ例外情報は、例外からサービスの SOAP エラーに変換され、送信され、SOAP エラーから WCF クライアントのエラー例外に変換される必要があります。</span><span class="sxs-lookup"><span data-stu-id="44108-110">Because WCF applications run under both types of error systems, any managed exception information that is sent to the client must be converted from exceptions into SOAP faults on the service, sent, and converted from SOAP faults to fault exceptions in WCF clients.</span></span> <span data-ttu-id="44108-111">双方向クライアントの場合は、クライアント コントラクトによって SOAP エラーがサービスに返送されることもあります。</span><span class="sxs-lookup"><span data-stu-id="44108-111">In the case of duplex clients, client contracts can also send SOAP faults back to a service.</span></span> <span data-ttu-id="44108-112">いずれの場合も、開発者は、既定のサービス例外の動作を使用することも、例外をエラー メッセージにマップするかどうかを制御することも (その場合はどのようにマップするかを指定することも) できます。</span><span class="sxs-lookup"><span data-stu-id="44108-112">In either case, you can use the default service exception behaviors, or you can explicitly control whether—and how—exceptions are mapped to fault messages.</span></span>

<span data-ttu-id="44108-113">2種類の SOAP エラーを送信できます。*宣言*され、宣言さ*れてい*ません。</span><span class="sxs-lookup"><span data-stu-id="44108-113">Two types of SOAP faults can be sent: *declared* and *undeclared*.</span></span> <span data-ttu-id="44108-114">宣言された SOAP エラーは、カスタム SOAP エラーの種類を指定する <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType> 属性を含む操作で発生します。</span><span class="sxs-lookup"><span data-stu-id="44108-114">Declared SOAP faults are those in which an operation has a <xref:System.ServiceModel.FaultContractAttribute?displayProperty=nameWithType> attribute that specifies a custom SOAP fault type.</span></span> <span data-ttu-id="44108-115">*宣言*しないSOAP エラーは、操作のコントラクトで指定されていません。</span><span class="sxs-lookup"><span data-stu-id="44108-115">*Undeclared* SOAP faults are not specified in the contract for an operation.</span></span>

<span data-ttu-id="44108-116"><xref:System.ServiceModel.FaultContractAttribute> 属性を使用して、通常の操作中に受信することをクライアントが予期できるすべての SOAP エラーを正式に指定することによって、サービス操作でそのエラーを宣言することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="44108-116">It is strongly recommended that service operations declare their faults by using the <xref:System.ServiceModel.FaultContractAttribute> attribute to formally specify all SOAP faults that a client can expect to receive in the normal course of an operation.</span></span> <span data-ttu-id="44108-117">また、SOAP エラーでは、情報の漏えいを最小限に抑えるために、クライアントが知る必要がある情報だけを返すことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="44108-117">It is also recommended that you return in a SOAP fault only the information that a client must know to minimize information disclosure.</span></span>

<span data-ttu-id="44108-118">通常、サービス (および双方向クライアント) は、次の手順に従ってエラー処理をアプリケーションに統合します。</span><span class="sxs-lookup"><span data-stu-id="44108-118">Typically, services (and duplex clients) take the following steps to successfully integrate error handling into their applications:</span></span>

- <span data-ttu-id="44108-119">例外状態をカスタム SOAP エラーにマップします。</span><span class="sxs-lookup"><span data-stu-id="44108-119">Map exception conditions to custom SOAP faults.</span></span>

- <span data-ttu-id="44108-120">クライアントとサービスは、SOAP エラーを例外として送受信します。</span><span class="sxs-lookup"><span data-stu-id="44108-120">Clients and services send and receive SOAP faults as exceptions.</span></span>

<span data-ttu-id="44108-121">また、WCF クライアントおよびサービスは、宣言されていない soap エラーをデバッグ目的で使用でき、既定のエラー動作を拡張できます。</span><span class="sxs-lookup"><span data-stu-id="44108-121">In addition, WCF clients and services can use undeclared soap faults for debugging purposes and can extend the default error behavior.</span></span> <span data-ttu-id="44108-122">以下のセクションで、これらのタスクと概念について説明します。</span><span class="sxs-lookup"><span data-stu-id="44108-122">The following sections discuss these tasks and concepts.</span></span>

## <a name="map-exceptions-to-soap-faults"></a><span data-ttu-id="44108-123">SOAP エラーへの例外のマッピング</span><span class="sxs-lookup"><span data-stu-id="44108-123">Map Exceptions to SOAP Faults</span></span>

<span data-ttu-id="44108-124">エラー状態の処理操作を作成するための最初の手順は、クライアント アプリケーションにエラーを通知する状態を決定することです。</span><span class="sxs-lookup"><span data-stu-id="44108-124">The first step in creating an operation that handles error conditions is to decide under what conditions a client application should be informed about errors.</span></span> <span data-ttu-id="44108-125">一部の操作には、その機能に固有のエラー状態があります。</span><span class="sxs-lookup"><span data-stu-id="44108-125">Some operations have error conditions specific to their functionality.</span></span> <span data-ttu-id="44108-126">たとえば、`PurchaseOrder` 操作では、発注書の作成が禁止になっている顧客に特定の情報を返すことができます。</span><span class="sxs-lookup"><span data-stu-id="44108-126">For example, a `PurchaseOrder` operation might return specific information to customers who are no longer permitted to initiate a purchase order.</span></span> <span data-ttu-id="44108-127">また、`Calculator` サービスなどでは、より一般的な `MathFault` SOAP エラーを使用してサービス全体のすべてのエラー状態を記述できます。</span><span class="sxs-lookup"><span data-stu-id="44108-127">In other cases, such as a `Calculator` service, a more general `MathFault` SOAP fault may be able to describe all error conditions across an entire service.</span></span> <span data-ttu-id="44108-128">サービスのクライアントのエラー状態を特定したら、カスタム SOAP エラーを作成し、エラー状態が発生したときに SOAP エラーを返す操作として、対応する操作をマークします。</span><span class="sxs-lookup"><span data-stu-id="44108-128">Once the error conditions of clients of your service are identified, a custom SOAP fault can be constructed and the operation can be marked as returning that SOAP fault when its corresponding error condition arises.</span></span>

<span data-ttu-id="44108-129">サービスまたはクライアントの開発手順の詳細については、「[エラーの定義と指定](defining-and-specifying-faults.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="44108-129">For more information about this step of developing your service or client, see [Defining and Specifying Faults](defining-and-specifying-faults.md).</span></span>

## <a name="clients-and-services-handle-soap-faults-as-exceptions"></a><span data-ttu-id="44108-130">クライアントとサービスによる例外としての SOAP エラーの処理</span><span class="sxs-lookup"><span data-stu-id="44108-130">Clients and Services Handle SOAP Faults as Exceptions</span></span>

<span data-ttu-id="44108-131">WCF アプリケーションでエラー処理を成功させるには、操作エラー条件を特定し、カスタム SOAP エラーを定義し、これらの操作をこれらのエラーを返すようにマークします。</span><span class="sxs-lookup"><span data-stu-id="44108-131">Identifying operation error conditions, defining custom SOAP faults, and marking those operations as returning those faults are the first steps in successful error handling in WCF applications.</span></span> <span data-ttu-id="44108-132">次の手順では、このエラーの送受信を適切に実装します。</span><span class="sxs-lookup"><span data-stu-id="44108-132">The next step is to properly implement the sending and receiving of these faults.</span></span> <span data-ttu-id="44108-133">通常は、サービスがエラーを送信してクライアント アプリケーションにエラー状態を通知しますが、双方向クライアントが SOAP エラーをサービスに送信することもできます。</span><span class="sxs-lookup"><span data-stu-id="44108-133">Typically services send faults to inform client applications about error conditions, but duplex clients can also send SOAP faults to services.</span></span>

<span data-ttu-id="44108-134">詳細については、「[エラーの送受信](sending-and-receiving-faults.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="44108-134">For more information, see [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

## <a name="undeclared-soap-faults-and-debugging"></a><span data-ttu-id="44108-135">非宣言 SOAP エラーとデバッグ</span><span class="sxs-lookup"><span data-stu-id="44108-135">Undeclared SOAP Faults and Debugging</span></span>

<span data-ttu-id="44108-136">宣言 SOAP エラーは、堅牢で相互運用可能な分散アプリケーションを構築するうえで便利です。</span><span class="sxs-lookup"><span data-stu-id="44108-136">Declared SOAP faults are extremely useful for building robust, interoperable, distributed applications.</span></span> <span data-ttu-id="44108-137">ただし、サービス (または双方向クライアント) が非宣言 SOAP エラーを送信することが役立つ場合があります。非宣言 SOAP エラーとは、その操作について Web サービス記述言語 (WSDL) で宣言されていないエラーです。</span><span class="sxs-lookup"><span data-stu-id="44108-137">However, in some cases it is useful for a service (or duplex client) to send an undeclared SOAP fault, one that is not mentioned in the Web Services Description Language (WSDL) for that operation.</span></span> <span data-ttu-id="44108-138">たとえば、サービスの開発時に予期しない状況が発生する可能性があります。この場合、デバッグのために情報をクライアントに送信することが役立ちます。</span><span class="sxs-lookup"><span data-stu-id="44108-138">For example, when developing a service, unexpected situations can occur in which it is useful for debugging purposes to send information back to the client.</span></span> <span data-ttu-id="44108-139">また、<xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> プロパティまたは <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> プロパティを `true` に設定して、WCF クライアントが内部サービス操作の例外に関する情報を取得できるようにすることもできます。</span><span class="sxs-lookup"><span data-stu-id="44108-139">In addition, you can set the <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property or the <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> property to `true` to permit WCF clients to obtain information about internal service operation exceptions.</span></span> <span data-ttu-id="44108-140">個々のエラーの送信とデバッグ動作プロパティの設定については、「[エラーの送信と受信](sending-and-receiving-faults.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="44108-140">Both sending individual faults and setting the debugging behavior properties are described in [Sending and Receiving Faults](sending-and-receiving-faults.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="44108-141">マネージ例外によって内部アプリケーション情報が公開される可能性があるため、<xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> または <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> を `true` に設定すると、WCF クライアントは、個人を特定できるなどの内部サービス操作例外に関する情報を取得することができます。機密情報。</span><span class="sxs-lookup"><span data-stu-id="44108-141">Because managed exceptions can expose internal application information, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` can permit WCF clients to obtain information about internal service operation exceptions, including personally identifiable or other sensitive information.</span></span>
>
> <span data-ttu-id="44108-142">したがって、<xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> または <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> を `true` に設定することは、サービス アプリケーションを一時的にデバッグする方法としてのみお勧めできます。</span><span class="sxs-lookup"><span data-stu-id="44108-142">Therefore, setting <xref:System.ServiceModel.ServiceBehaviorAttribute.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> or <xref:System.ServiceModel.Description.ServiceDebugBehavior.IncludeExceptionDetailInFaults%2A?displayProperty=nameWithType> to `true` is recommended only as a way to temporarily debug a service application.</span></span> <span data-ttu-id="44108-143">さらに、このようにして未処理のマネージド例外を返すメソッドの WSDL には、<xref:System.ServiceModel.FaultException%601> 型の <xref:System.ServiceModel.ExceptionDetail> のコントラクトが含まれません。</span><span class="sxs-lookup"><span data-stu-id="44108-143">In addition, the WSDL for a method that returns unhandled managed exceptions in this way does not contain the contract for the <xref:System.ServiceModel.FaultException%601> of type <xref:System.ServiceModel.ExceptionDetail>.</span></span> <span data-ttu-id="44108-144">クライアントは、デバッグ情報を適切に取得するために、不明な SOAP エラー (<xref:System.ServiceModel.FaultException?displayProperty=nameWithType> オブジェクトとして WCF クライアントに返される) の可能性を期待する必要があります。</span><span class="sxs-lookup"><span data-stu-id="44108-144">Clients must expect the possibility of an unknown SOAP fault (returned to WCF clients as <xref:System.ServiceModel.FaultException?displayProperty=nameWithType> objects) to obtain the debugging information properly.</span></span>

## <a name="customizing-error-handling-with-ierrorhandler"></a><span data-ttu-id="44108-145">IErrorHandler によるエラー処理のカスタマイズ</span><span class="sxs-lookup"><span data-stu-id="44108-145">Customizing Error Handling with IErrorHandler</span></span>

<span data-ttu-id="44108-146">アプリケーション レベルの例外が発生した場合にクライアントへの応答メッセージをカスタマイズする、または応答メッセージが返された後に何らかのカスタム処理を実行するという特別な要件がある場合は、<xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="44108-146">If you have special requirements to either customize the response message to the client when an application-level exception happens or perform some custom processing after the response message is returned, implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler?displayProperty=nameWithType> interface.</span></span>

## <a name="fault-serialization-issues"></a><span data-ttu-id="44108-147">エラーのシリアル化の問題</span><span class="sxs-lookup"><span data-stu-id="44108-147">Fault Serialization Issues</span></span>

<span data-ttu-id="44108-148">WCF では、エラー コントラクトを逆シリアル化する場合、最初に SOAP メッセージのエラー コントラクト名とエラー コントラクトの型を一致させようとします。</span><span class="sxs-lookup"><span data-stu-id="44108-148">When deserializing a fault contract, WCF first attempts to match the fault contract name in the SOAP message with the fault contract type.</span></span> <span data-ttu-id="44108-149">正しく一致しない場合、使用可能なエラー コントラクトのアルファベット順のリストで互換性のある型を検索します。</span><span class="sxs-lookup"><span data-stu-id="44108-149">If it cannot find an exact match it will then search the list of available fault contracts in alphabetical order for a compatible type.</span></span> <span data-ttu-id="44108-150">2 つのエラー コントラクトが互換性のある型である場合 (たとえば、一方のコントラクトが別のコントラクトのサブクラスである場合)、エラーを逆シリアル化するときに間違った型が使用される場合があります。</span><span class="sxs-lookup"><span data-stu-id="44108-150">If two fault contracts are compatible types (one is a subclass of another, for example) the wrong type may be used to de-serialize the fault.</span></span> <span data-ttu-id="44108-151">このような問題は、エラー コントラクトで名前、名前空間、およびアクションが指定されていない場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="44108-151">This only occurs if the fault contract does not specify a name, namespace, and action.</span></span> <span data-ttu-id="44108-152">このような問題が発生しないようにするには、常に名前、名前空間、およびアクションの属性を指定して、エラー コントラクトを完全修飾するようにしてください。</span><span class="sxs-lookup"><span data-stu-id="44108-152">To prevent this issue from occurring, always fully qualify fault contracts by specifying the name, namespace, and action attributes.</span></span> <span data-ttu-id="44108-153">また、共有基本クラスから派生した関連エラー コントラクトを定義している場合は、新しいメンバーを `[DataMember(IsRequired=true)]` でマークしてください。</span><span class="sxs-lookup"><span data-stu-id="44108-153">Additionally if you have defined a number of related fault contracts derived from a shared base class, make sure to mark any new members with `[DataMember(IsRequired=true)]`.</span></span> <span data-ttu-id="44108-154">この `IsRequired` 属性の詳細については、「<xref:System.Runtime.Serialization.DataMemberAttribute>」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="44108-154">For more information on this `IsRequired` attribute see, <xref:System.Runtime.Serialization.DataMemberAttribute>.</span></span> <span data-ttu-id="44108-155">この結果、基本クラスに互換性のある型が指定されなくなり、正しい派生型にエラーが逆シリアル化されます。</span><span class="sxs-lookup"><span data-stu-id="44108-155">This will prevent a base class from being a compatible type and force the fault to be deserialized into the correct derived type.</span></span>

## <a name="see-also"></a><span data-ttu-id="44108-156">参照</span><span class="sxs-lookup"><span data-stu-id="44108-156">See also</span></span>

- <xref:System.ServiceModel.FaultException>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.FaultException>
- <xref:System.Xml.Serialization.XmlSerializer>
- <xref:System.ServiceModel.XmlSerializerFormatAttribute>
- <xref:System.ServiceModel.FaultContractAttribute>
- <xref:System.ServiceModel.CommunicationException>
- <xref:System.ServiceModel.FaultContractAttribute.Action%2A>
- <xref:System.ServiceModel.FaultException.Code%2A>
- <xref:System.ServiceModel.FaultException.Reason%2A>
- <xref:System.ServiceModel.FaultCode.SubCode%2A>
- <xref:System.ServiceModel.OperationContractAttribute.IsOneWay%2A>
- [<span data-ttu-id="44108-157">エラーの定義と指定</span><span class="sxs-lookup"><span data-stu-id="44108-157">Defining and Specifying Faults</span></span>](defining-and-specifying-faults.md)
