---
title: メッセージ フローの概要
ms.date: 03/30/2017
ms.assetid: fb0899e1-84cc-4d90-b45b-dc5a50063943
ms.openlocfilehash: cb2924b62fce62620b664efa34208deb12dd34b7
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96285539"
---
# <a name="message-flow-overview"></a><span data-ttu-id="0b01e-102">メッセージ フローの概要</span><span class="sxs-lookup"><span data-stu-id="0b01e-102">Message Flow Overview</span></span>

<span data-ttu-id="0b01e-103">相互接続されたサービスを持つ分散システムでは、サービス間の因果関係を調べる必要があります。</span><span class="sxs-lookup"><span data-stu-id="0b01e-103">In a distributed system containing interconnected services, it is necessary to determine causal relationships between the services.</span></span> <span data-ttu-id="0b01e-104">状態監視、トラブルシューティング、根本原因分析などの重要なシナリオをサポートするには、要求フローに含まれるさまざまなコンポーネントを理解することが重要です。</span><span class="sxs-lookup"><span data-stu-id="0b01e-104">It is important to understand the various components that were part of a request flow to support critical scenarios such as health monitoring, troubleshooting, and root cause analysis.</span></span> <span data-ttu-id="0b01e-105">.NET Framework 4 では、多様なサービス間でトレースを関連付けることができるように、次の機能のサポートが追加されています。</span><span class="sxs-lookup"><span data-stu-id="0b01e-105">To enable the correlation of traces between various services, in the .NET Framework 4 we added support through the following features:</span></span>

- <span data-ttu-id="0b01e-106">分析トレース: Event Tracing for Windows (ETW) を使用したトレース機能です。詳細度が低く、パフォーマンスに優れています。</span><span class="sxs-lookup"><span data-stu-id="0b01e-106">Analytic tracing: A high performance and low verbosity tracing feature using Event Tracing for Windows (ETW).</span></span>

- <span data-ttu-id="0b01e-107">WCF/WF サービス用のエンドツーエンドのアクティビティ モデル: <xref:System.ServiceModel> 名前空間および <xref:System.Workflow.ComponentModel> 名前空間が生成するトレースの相関関係をサポートする機能です。</span><span class="sxs-lookup"><span data-stu-id="0b01e-107">End-to-end activity model for WCF/WF services: This feature supports correlation of traces generated by the <xref:System.ServiceModel> and <xref:System.Workflow.ComponentModel> namespaces.</span></span>

- <span data-ttu-id="0b01e-108">WF の ETW 追跡: この機能では、WF サービスによって生成された追跡レコードを使用して、ワークフローの現在の状態と進行状況を把握します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-108">ETW tracking for WF: This feature uses tracking records generated by WF services to provide visibility into the workflow’s current state and progress.</span></span>

 <span data-ttu-id="0b01e-109">追跡レコードまたはトレース レコードに記録されたエラーを使用して、コード障害や誤った形式のメッセージを検出できます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-109">Errors logged in a tracking or tracing record can be used to find code defects or incorrectly formed messages.</span></span> <span data-ttu-id="0b01e-110">エラー状態のアクティビティの特定には、イベントのメッセージ ヘッダーにある Correlation ノードの ActivityId プロパティを使用することができます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-110">The ActivityId property of the Correlation node in the event’s message header can be used to determine the faulting activity.</span></span> <span data-ttu-id="0b01e-111">アクティビティ ID によるメッセージフローのトレースを有効にするには、「 [メッセージフローのトレースの構成](./etw/configuring-message-flow-tracing.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0b01e-111">To enable message flow tracing by activity ID, see [Configuring Message Flow Tracing](./etw/configuring-message-flow-tracing.md).</span></span> <span data-ttu-id="0b01e-112">このトピックでは、チュートリアル入門で作成されたプロジェクトでメッセージ フローのトレースを有効にする方法を示します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-112">This topic demonstrates how to enable message flow tracing in the project created in the Getting Started tutorial.</span></span>

### <a name="to-enable-message-flow-tracing-in-the-getting-started-tutorial"></a><span data-ttu-id="0b01e-113">チュートリアル入門で作成されたプロジェクトでメッセージ フローのトレースを有効にするには</span><span class="sxs-lookup"><span data-stu-id="0b01e-113">To enable message flow tracing in the Getting Started tutorial</span></span>

1. <span data-ttu-id="0b01e-114">[ **開始**]、[ **実行**] の順にクリックしてイベントビューアーを開き、「」と入力し `eventvwr.exe` ます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-114">Open Event Viewer by clicking **Start**, **Run**, and entering `eventvwr.exe`.</span></span>

2. <span data-ttu-id="0b01e-115">分析トレースを有効にしていない場合は、[ **アプリケーションとサービスログ**]、[ **Microsoft**]、[ **Windows**]、[ **アプリケーションサーバー-アプリケーション**] の順に展開します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-115">If you haven’t enabled analytic tracing, expand **Applications and Services Logs**, **Microsoft**, **Windows**, **Application Server-Applications**.</span></span> <span data-ttu-id="0b01e-116">[ **表示**]、[ **分析およびデバッグログの表示**] を選択します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-116">Select **View**, **Show Analytic and Debug Logs**.</span></span> <span data-ttu-id="0b01e-117">[ **分析** ] を右クリックし、[ **ログを有効にする**] を選択します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-117">Right-click **Analytic** and select **Enable Log**.</span></span> <span data-ttu-id="0b01e-118">トレースが表示されるように、イベント ビューアーを開いたままにします。</span><span class="sxs-lookup"><span data-stu-id="0b01e-118">Leave Event Viewer open so that traces can be viewed.</span></span>

3. <span data-ttu-id="0b01e-119">Visual Studio 2012 の [はじめにチュートリアル](../getting-started-tutorial.md) で作成したサンプルを開きます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-119">Open the sample created in the [Getting Started Tutorial](../getting-started-tutorial.md) in Visual Studio 2012.</span></span> <span data-ttu-id="0b01e-120">サービスを作成できるようにするには、Visual Studio 2012 を管理者として実行する必要があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="0b01e-120">Note that you must run Visual Studio 2012 as an administrator so that the service can be created.</span></span> <span data-ttu-id="0b01e-121">WCF サンプルがインストールされている場合は、チュートリアルで作成した完成したプロジェクトを含む [はじめに](../samples/getting-started-sample.md)を開くことができます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-121">If you have the WCF samples installed, you can open the [Getting Started](../samples/getting-started-sample.md), which contains the completed project created in the tutorial.</span></span>

4. <span data-ttu-id="0b01e-122">**サービス** プロジェクトを右クリックし、[**追加**]、[**新しい項目**] の順に選択します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-122">Right-click the **Service** project and select **Add**, **New Item**.</span></span> <span data-ttu-id="0b01e-123">[ **アプリケーション構成ファイル** ] を選択し、[ **OK**] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="0b01e-123">Select **Application Configuration File** and click **OK**.</span></span>

5. <span data-ttu-id="0b01e-124">上の手順で作成した App.Config ファイルに次のコードを追加します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-124">Add the following code to the App.Config file created in the previous step.</span></span>

    ```xml
    <system.serviceModel>
      <diagnostics>
        <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
      </diagnostics>
    </system.serviceModel>
    ```

6. <span data-ttu-id="0b01e-125">Ctrl キーを押しながら F5 キーを押して、サーバー アプリケーションをデバッグなしで実行します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-125">Execute the server application without debugging by pressing CTRL+F5.</span></span> <span data-ttu-id="0b01e-126">**クライアントプロジェクト** を右クリックし、[**デバッグ**]、[**新しいインスタンスを開始**] の順に選択して、クライアントプロジェクトを実行します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-126">Execute the client project by right-clicking the **Client** project and selecting **Debug**, **Start New Instance**.</span></span>

7. <span data-ttu-id="0b01e-127">クライアントからサーバーへのイベントをトレースするには、Client プロジェクトのアプリケーション構成ファイルに次の内容を追加します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-127">To trace the events from the client to the server, add the following to the application configuration file in the Client project.</span></span>

    ```xml
    <diagnostics>
      <endToEndTracing propagateActivity="true" messageFlowTracing="true"/>
    </diagnostics>
    ```

8. <span data-ttu-id="0b01e-128">クライアントの Program.cs に、次の Using ステートメントを追加します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-128">In Program.cs in the client, add the following Using statement.</span></span>

    ```csharp
    using System.Diagnostics;
    ```

9. <span data-ttu-id="0b01e-129">Client プロジェクトの program.cs ファイルにある Main メソッドで、トレース GUID をイベント ログに伝達するように設定します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-129">In the Main method in the program.cs file in the client project, set the Trace GUID to be propagated in the event log.</span></span>

    ```csharp
    Guid guid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = guid;
    ```

10. <span data-ttu-id="0b01e-130">**分析** ログを更新して確認します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-130">Refresh and examine the **Analytic**  log.</span></span>  <span data-ttu-id="0b01e-131">イベント ID が 220 のイベントを探します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-131">Look for an event with Event ID 220.</span></span>  <span data-ttu-id="0b01e-132">イベントを選択し、プレビューウィンドウの [ **詳細** ] タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="0b01e-132">Select the event, and click the **Details** tab in the preview pane.</span></span> <span data-ttu-id="0b01e-133">このイベントには、呼び出し元アクティビティの相関 ID が含まれています。</span><span class="sxs-lookup"><span data-stu-id="0b01e-133">This event will contain the correlation ID for the calling activity.</span></span>

    ```xml
    <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" />
    ```

    > [!NOTE]
    > <span data-ttu-id="0b01e-134">ActivityID に同じ GUID を持つすべてのイベントは、1 つの要求に関連しています。</span><span class="sxs-lookup"><span data-stu-id="0b01e-134">All events with the same GUID in the ActivityID are related to one request.</span></span> <span data-ttu-id="0b01e-135">これは、特定のクライアントから特定のサービスへメッセージを関連付けるために使用できます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-135">This can be used to correlate messages from a specific client to a specific service.</span></span> <span data-ttu-id="0b01e-136">このクライアントが別のサービスを呼び出した場合、同じクライアントが ActivityID によって識別されます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-136">If the client called another service, then the same client could be identified by ActivityID.</span></span>

11. <span data-ttu-id="0b01e-137">場合によっては、ActivityID が元の GUID から新しい ActivityID に変更されます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-137">In some cases, the ActivityID can change from the original GUID to a new ActivityID.</span></span> <span data-ttu-id="0b01e-138">その場合、転送イベントが生成されます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-138">In that case, a transfer event is emitted.</span></span> <span data-ttu-id="0b01e-139">このイベント ID は 499 で、イベントのヘッダーに次のデータが格納されます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-139">This event ID is 499, and the event will contain the following data in the header.</span></span>

    ```xml
    <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
        <System>
            <Provider Name="Microsoft-Windows-Application Server-Applications" Guid="{c651f5f6-1c0d-492e-8ae1-b4efd7c9d503}" />
            <EventID>499</EventID>
            ...
            <Correlation ActivityID="{A066CCF1-8AB3-459B-B62F-F79F957A5036}" RelatedActivityID="{85FC0930-9C49-42DA-804B-A7368104BD1B}" />
            ...
       </System>
    </Event>
    ```

    > [!NOTE]
    > <span data-ttu-id="0b01e-140">転送イベントは、アクティブな ActivityID が、ActivityID として指定された GUID から RelatedActivityID として指定された GUID に変更されたことを記録します。</span><span class="sxs-lookup"><span data-stu-id="0b01e-140">The transfer event records the change of the active ActivityID from the GUID specified as the ActivityID to the GUID specified as RelatedActivityID.</span></span> <span data-ttu-id="0b01e-141">転送イベントの生成後は、すべてのイベントに新しい GUID が ActivityID として格納されます。</span><span class="sxs-lookup"><span data-stu-id="0b01e-141">After the transfer event is emitted, all events will contain the new GUID as the ActivityID.</span></span>
