---
title: アクティビティ
ms.date: 03/30/2017
ms.assetid: 70471705-f55f-4da1-919f-4b580f172665
ms.openlocfilehash: 7f498c1f2222add197f428386076148cccc9ad06
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2019
ms.locfileid: "64656288"
---
# <a name="activity"></a>アクティビティ
このトピックでは、Windows Communication Foundation (WCF) トレース モデルでのアクティビティ トレースについて説明します。 アクティビティは、ユーザーがエラーの範囲を絞り込む上で役立つ処理単位です。 同じアクティビティで発生したエラーは直接関連します。 たとえば、メッセージを復号化できなかったために、ある操作が失敗したとします。 この操作とメッセージ復号化失敗のトレースは同じアクティビティ内に表示され、復号化エラーと要求エラー間の直接相関関係が示されます。  
  
## <a name="configuring-activity-tracing"></a>アクティビティ トレースの構成  
 WCF には、アプリケーションを処理するための定義済みのアクティビティが用意されています (を参照してください[アクティビティ リスト](../../../../../docs/framework/wcf/diagnostics/tracing/activity-list.md))。 また、ユーザー トレースをグループ化するために、アクティビティをプログラムによって定義することもできます。 詳細については、次を参照してください。[ユーザー コード トレースの出力](../../../../../docs/framework/wcf/diagnostics/tracing/emitting-user-code-traces.md)します。  
  
 実行時にアクティビティ トレースを出力するには使用、`ActivityTracing`の設定、`System.ServiceModel`構成コードを次に示すようにソース、またはその他の WCF またはカスタム トレース ソースをトレースします。  
  
```xml  
<source name="System.ServiceModel" switchValue="Verbose,ActivityTracing">  
```  
  
 構成要素と使用されている属性の詳細については、次を参照してください。、[トレースの構成](../../../../../docs/framework/wcf/diagnostics/tracing/configuring-tracing.md)トピック。  
  
## <a name="viewing-activities"></a>アクティビティの表示  
 アクティビティとそのユーティリティで表示できます、[サービス トレース ビューアー ツール (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)します。 ActivityTracing が有効な場合、このツールはトレースを取得し、アクティビティに基づいて並べ替えます。 トレース転送を表示することもできます。 トレース転送は、さまざまなアクティビティが相互にどのように関連しているかを示します。 これにより、特定のアクティビティによって別のアクティビティが開始されたことを確認できます。 たとえば、Secure Conversation トークンを取得するために、あるメッセージ要求によってセキュリティ ハンドシェイクが開始されたことを確認できます。  
  
### <a name="correlating-activities-in-service-trace-viewer"></a>サービス トレース ビューアーでのアクティビティの関連付け  
 次のように、サービス トレース ビューアー ツールには、アクティビティの 2 つのビューが用意されています。  
  
- **リスト**ビュー、アクティビティ ID を使用して、直接プロセス間でトレースを関連付けます。 異なるプロセス (クライアントとサービスなど) のトレースであっても、同じアクティビティ ID を持つトレースは、同じアクティビティにグループ化されます。 したがって、サービスで発生したエラーによってクライアントでエラーが発生した場合、ツールの同じアクティビティ ビューに両方のエラーが表示されることになります。  
  
- **グラフ**アクティビティがプロセスによってグループ化を表示します。 このビューでは、クライアントとサービスのトレースは、アクティビティ ID が同じであっても、異なるアクティビティに表示されます。 アクティビティ ID は同じであるが、異なるプロセスに含まれるアクティビティを相互に関連付けるために、このツールでは、関連するアクティビティ間のメッセージ フローが示されます。  
  
 詳細については、およびサービス トレース ビューアー ツールのグラフィカル ビューを表示するには、「[サービス トレース ビューアー ツール (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)と[相関トレースの表示のサービス トレース ビューアーを使用して、トラブルシューティング](../../../../../docs/framework/wcf/diagnostics/tracing/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting.md)します。  
  
## <a name="defining-the-scope-of-an-activity"></a>アクティビティ スコープの定義  
 アクティビティはデザイン時に定義され、作業の論理単位を表します。 同じアクティビティ識別子を使用して出力されたトレースは直接関連し、同じアクティビティに含まれます。 アクティビティはエンドポイントの境界を越えることができるため (要求など)、アクティビティには 2 つのスコープが定義されています。  
  
- `Global` スコープ (アプリケーションごと)。 このスコープでは、アクティビティは 128 ビットの、グローバルに一意なアクティビティ識別子 (gAId) によって識別されます。 gAId は、エンドポイント全体にわたって伝達されます。  
  
- `Local` スコープ (エンドポイントごと)。 このスコープでは、アクティビティは、gAId、アクティビティ トレースを出力するトレース ソース名、およびプロセス ID によって識別されます。この 3 つの組み合わせによって、ローカル アクティビティ ID (lAId) が構成されます。 lAId は、アクティビティの (ローカル) 境界の定義に使用されます。  
  
## <a name="trace-schema"></a>トレース スキーマ  
 トレースはスキーマを使用して Microsoft プラットフォーム間で出力できます。 "e2e"(「エンド ツー エンド」) には、一般的に使用されるスキーマです。 このスキーマには、128 ビット識別子 (gAId)、トレース ソース名、およびプロセス ID が含まれます。 マネージド コードでは、<xref:System.Diagnostics.XmlWriterTraceListener> が e2e スキーマでトレースを出力します。  
  
 開発者は、スレッド ローカル ストレージ (TLS) の GUID を使用して <xref:System.Diagnostics.CorrelationManager.ActivityId%2A> プロパティを設定することにより、トレースで出力する AID を設定できます。 次に例を示します。  
  
```csharp
// set the current Activity ID to a new GUID.  
CorrelationManager.ActivityId = Guid.NewGuid();  
```
  
 次の例に示すように、トレース ソースを使用してトレースを出力すると、TLS での gAId の設定が明確に示されます。  
  
```csharp
TraceSource traceSource = new TraceSource("myTraceSource");  
traceSource.TraceEvent(TraceEventType.Warning, eventId, "Information");  
```  
  
 出力されるトレースには、TLS の現在の gAId、トレース ソースのコンストラクターにパラメーターとして渡されるトレース ソース名、および現在のプロセスの ID が含まれます。  
  
## <a name="activity-lifetime"></a>アクティビティの有効期間  
 最も厳密な意味では、アクティビティの形跡は、出力されたトレースでアクティビティ ID が初めて使用されたときに始まり、出力されたトレースでアクティビティ ID が最後に使用されたときに終わります。 <xref:System.Diagnostics> には、定義済みのトレースの種類のセットが用意されています。これは、アクティビティの有効期間の境界を明示的にマークするための Start トレースと Stop トレースを含みます。  
  
- 開始:アクティビティの開始を示します。 "Start"トレースは、新しい処理マイルス トーンの開始のレコードを提供します。 このトレースには、特定のプロセスの特定のトレース ソースに使用される新しいアクティビティ ID が含まれます。ただし、エンドポイント間でアクティビティ ID が伝達される場合を除きます (この場合は、エンドポイントごとに 1 つの "Start" トレースが表示されます)。 新しいアクティビティの開始の例として、新しい処理スレッドの作成や、新しいパブリック メソッドの入力などがあります。  
  
- 停止:アクティビティの終了を示します。 "Stop"トレースは、既存の処理マイルス トーンの終了のレコードを提供します。 このトレースには、特定のプロセスの特定のトレース ソースに使用される既存のアクティビティ ID が含まれます。ただし、エンドポイント間でアクティビティ ID が伝達される場合を除きます (この場合は、エンドポイントごとに 1 つの "Stop" トレースが表示されます)。  アクティビティの停止の例には、処理スレッドを終了、または既存の"Start"トレースの開始が示されたメソッドが含まれます。  
  
- 中断します。アクティビティの処理の中断を示します。 "Suspend"トレースには、既存のアクティビティ ID は後で再開する処理が必要ですが含まれています。 中断イベントと再開イベントの間に、現在のトレース ソースからこの ID を使用してトレースが出力されることはありません。 中断の例として、外部ライブラリ関数の呼び出し時、または I/O 完了ポートなどのリソースで待機する際のアクティビティの一時停止などがあります。  
  
- 再開:アクティビティの処理の再開を示します。 "Resume"トレースには、既存のアクティビティ id、現在のトレース ソースからの最後に出力されたトレースが"Suspend"トレースが含まれています。 再開の例として、外部ライブラリ関数の呼び出しからの復帰や、I/O 完了ポートなどのリソースによって処理の再開が通知された場合などがあります。  
  
- 転送します。一部のアクティビティは、他のユーザーによるまたは他のユーザーに関連付ける、ため、"Transfer"トレースでは、他のアクティビティにアクティビティを関連付けることができます。 転送により、アクティビティ間の直接の関係が記録されます。  
  
 Start トレースと Stop トレースは、関連付けにとっては重要ではありません。 ただし、これらのトレースは、パフォーマンスの向上、プロファイリング、およびアクティビティ スコープの検証に役立ちます。  
  
 同じアクティビティの直接関連するイベントを検出するときや、転送トレースを追跡する場合に関連アクティビティのイベントを検出するときに、ツールはこれらのトレースを使用して、トレース ログのナビゲーションを最適化することができます。 たとえば、ツールが Start/Stop トレースを確認したときに、特定のアクティビティのログの解析を中止できます。  
  
 Start/Stop トレースは、プロファイリングに使用することもできます。 開始マーカーと終了マーカーの間で使用されるリソースは、論理アクティビティを含むアクティビティの包括時間を表します。 Suspend トレースから Resume トレースまでの時間間隔を減算することで、アクティビティの実際の時間がわかります。  
  
 また、Stop トレースは、実装済みのアクティビティのスコープを検証する際に特に役立ちます。 特定のアクティビティ内ではなく Stop トレースの後に出現する処理トレースがある場合、これはコードの欠陥を示している可能性があります。  
  
## <a name="guidelines-for-using-activity-tracing"></a>アクティビティ トレースを使用するためのガイドライン  
 ActivityTracing トレース (Start、Stop、Suspend、Resume、および Transfer) を使用する際のガイドラインを以下に示します。  
  
- トレースは、ツリーではなく循環有向グラフです。 あるアクティビティを発生させたアクティビティに制御を戻すことができます。  
  
- アクティビティは処理の境界を示します。処理の境界は、システム管理者にとって重要であり、サポートを容易にする上でも役立ちます。  
  
- クライアントとサーバーの両方で、各 WCF メソッドは制限されます (後の作業を完了すると)、新しいアクティビティを開始することで、新しいアクティビティを終了し、アンビエント アクティビティに返すことです。  
  
- 接続のリッスンやメッセージの待機など、長時間にわたって実行される (継続中の) アクティビティは、対応する開始マーカーと終了マーカーによって表されます。  
  
- メッセージの受信または処理によって起動されるアクティビティは、トレースの境界によって表されます。  
  
- アクティビティはアクティビティを表します。オブジェクトとは限りません。 アクティビティとして解釈する必要があります"これが発生しているときにします。 . .  (有効なトレース出力が発生したときに) これが発生していた" と解釈する必要があります。  
  
## <a name="see-also"></a>関連項目

- [トレースの構成](../../../../../docs/framework/wcf/diagnostics/tracing/configuring-tracing.md)
- [サービス トレース ビューアーを使用した相関トレースの表示とトラブルシューティング](../../../../../docs/framework/wcf/diagnostics/tracing/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting.md)
- [エンドツーエンドのトレースのシナリオ](../../../../../docs/framework/wcf/diagnostics/tracing/end-to-end-tracing-scenarios.md)
- [サービス トレース ビューアー ツール (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)
- [ユーザー コード トレースの出力](../../../../../docs/framework/wcf/diagnostics/tracing/emitting-user-code-traces.md)
