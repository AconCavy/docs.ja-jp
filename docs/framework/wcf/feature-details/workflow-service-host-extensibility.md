---
title: ワークフロー サービス ホストの拡張機能
ms.date: 03/30/2017
ms.assetid: c0e8f7bb-cb13-49ec-852f-b85d7c23972f
ms.openlocfilehash: 67a7830c564cabafb9441e86eb0d87164d854ee5
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96258453"
---
# <a name="workflow-service-host-extensibility"></a><span data-ttu-id="fe05b-102">ワークフロー サービス ホストの拡張機能</span><span class="sxs-lookup"><span data-stu-id="fe05b-102">Workflow Service Host Extensibility</span></span>

[!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)] <span data-ttu-id="fe05b-103">には、ワークフロー サービスをホストするための <xref:System.ServiceModel.Activities.WorkflowServiceHost> クラスがあります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-103">provides the <xref:System.ServiceModel.Activities.WorkflowServiceHost> class for hosting workflow services.</span></span> <span data-ttu-id="fe05b-104">このクラスは、マネージド アプリケーションまたは Windows サービスで、ワークフロー サービスを自己ホストするときに使用します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-104">This class is used when you are self-hosting a workflow service in a managed application or a Windows service.</span></span> <span data-ttu-id="fe05b-105">また、このクラスは、インターネット インフォメーション サービス (IIS) または Windows プロセス アクティブ化サービス (WAS) を使用してワークフロー サービスをホストするときにも使用します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-105">This class is also used when hosting a workflow service with Internet Information Services (IIS) or Windows Process Activation Service (WAS).</span></span> <span data-ttu-id="fe05b-106"><xref:System.ServiceModel.Activities.WorkflowServiceHost> クラスは、カスタムの拡張機能の追加、アイドル動作の変更、およびサービス以外のワークフロー (メッセージング アクティビティを使用しないワークフロー) のホストを可能にする拡張ポイントを提供します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-106">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> class provides extension points that allow you to add custom extensions, change the idle behavior, and host non-service workflows (workflows that do not use messaging activities).</span></span>  
  
## <a name="workflow-service-host-extensions"></a><span data-ttu-id="fe05b-107">ワークフロー サービス ホストの拡張機能</span><span class="sxs-lookup"><span data-stu-id="fe05b-107">Workflow Service Host Extensions</span></span>  

 <span data-ttu-id="fe05b-108"><xref:System.ServiceModel.Activities.WorkflowServiceHost> には、<xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> に拡張機能を追加するメソッドを提供する、<xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> 型の <xref:System.ServiceModel.Activities.WorkflowServiceHost> プロパティがあります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-108">The <xref:System.ServiceModel.Activities.WorkflowServiceHost> contains a <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> property of type <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager> that provides methods to add extensions to the <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span></span> <span data-ttu-id="fe05b-109">各ワークフロー サービス インスタンスに拡張機能を追加するには、<xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-109">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service instance.</span></span> <span data-ttu-id="fe05b-110">指定されたデリゲートは、ワークフロー サービス インスタンスが作成されるとき、または永続化ストアから読み込まれるときに、新しい拡張機能を作成するために呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-110">The delegate specified is called to create a new extension when a workflow service instance is created or loaded from a persistence store.</span></span> <span data-ttu-id="fe05b-111">各ワークフロー サービス ホストに拡張機能を追加するには、<xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> メソッドを使用します。追加された拡張機能の 1 つのインスタンスが、すべてのワークフロー サービス インスタンスで共有されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-111">Use the <xref:System.Activities.Hosting.WorkflowInstanceExtensionManager.Add%2A> method to add an extension for each workflow service host, one instance of the extension is shared for all workflow service instances.</span></span>  
  
## <a name="react-to-unhandled-exceptions"></a><span data-ttu-id="fe05b-112">ハンドルされない例外の処理</span><span class="sxs-lookup"><span data-stu-id="fe05b-112">React to Unhandled Exceptions</span></span>  

 <span data-ttu-id="fe05b-113"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> を使用すると、ワークフロー サービス内でハンドルされない例外が発生したときに実行されるアクションを指定できます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-113">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior> enables you to specify the action to take if an unhandled exception occurs within a workflow service.</span></span> <span data-ttu-id="fe05b-114"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> プロパティには、次の <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> 値のいずれかを指定します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-114">The <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionBehavior.Action%2A> property specifies one of the <xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction> values:</span></span>  
  
- <span data-ttu-id="fe05b-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – ワークフロー サービス インスタンスを中止します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-115"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Abandon> – Aborts the workflow service instance.</span></span>  
  
- <span data-ttu-id="fe05b-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – 前回永続化された状態にロールバックし、ワークフロー サービス インスタンスを中断します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-116"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.AbandonAndSuspend> – Rolls back to the last persisted state and suspends the workflow service instance.</span></span> <span data-ttu-id="fe05b-117">これは、ワークフローが既に 1 回以上、永続化されている場合にのみ実行されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-117">This only occurs if the workflow has already been persisted at least once.</span></span> <span data-ttu-id="fe05b-118">永続化されたことがない場合は、ワークフロー インスタンスが中止されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-118">If not the workflow instance is aborted.</span></span>  
  
- <span data-ttu-id="fe05b-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – インスタンスを取り消します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-119"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Cancel> – Cancels the instance.</span></span>  
  
- <span data-ttu-id="fe05b-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – ワークフロー インスタンスを終了します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-120"><xref:System.ServiceModel.Activities.Description.WorkflowUnhandledExceptionAction.Terminate> – Terminates the instance.</span></span>  
  
 <span data-ttu-id="fe05b-121">この動作は、次の例に示すように、コードで構成できます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-121">This behavior can be configured in code as shown in the following example.</span></span>  
  
```csharp  
host.Description.Behaviors.Add(new WorkflowUnhandledExceptionBehavior { Action = WorkflowUnhandledExceptionAction.Abandon });  
```  
  
 <span data-ttu-id="fe05b-122">また、次の例のように、構成ファイルで構成することもできます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-122">It can also be configured in a configuration file as shown in the following example.</span></span>  
  
```xml
<behaviors>  
      <serviceBehaviors>  
        <behavior>  
          <serviceMetadata httpGetEnabled="True"/>  
          <serviceDebug includeExceptionDetailInFaults="False" />  
          <workflowUnhandledExceptionBehavior action="Abandon" />
        </behavior>  
      </serviceBehaviors>  
</behaviors>
```  
  
## <a name="hosting-non-service-workflows"></a><span data-ttu-id="fe05b-123">サービス以外のワークフローのホスティング</span><span class="sxs-lookup"><span data-stu-id="fe05b-123">Hosting Non-Service Workflows</span></span>  

 <span data-ttu-id="fe05b-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> を使用すると、サービス以外のワークフロー、つまり、<xref:System.ServiceModel.Activities.Receive> アクティビティで開始されないワークフロー、またはメッセージング アクティビティを使用しないワークフローをホストできます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-124"><xref:System.ServiceModel.Activities.WorkflowServiceHost> can be used to host non-service workflows, or workflows that either do not begin with a <xref:System.ServiceModel.Activities.Receive> activity or workflows that do not use the messaging activities.</span></span> <span data-ttu-id="fe05b-125">ワークフロー サービスは、通常、<xref:System.ServiceModel.Activities.Receive> アクティビティで開始されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-125">Workflow services normally begin with a <xref:System.ServiceModel.Activities.Receive> activity.</span></span> <span data-ttu-id="fe05b-126"><xref:System.ServiceModel.Activities.WorkflowServiceHost> がワークフロー サービスに対するメッセージを受信すると、ワークフロー サービスが実行 (または永続化) されていない場合は、新しいワークフロー サービス インスタンスが作成されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-126">When the <xref:System.ServiceModel.Activities.WorkflowServiceHost> receives a message for a workflow service, if it is not already running (or persisted) a new workflow service instance is created.</span></span> <span data-ttu-id="fe05b-127">ワークフローが Receive アクティビティで開始されない場合は、メッセージを受信するアクティビティがないため、このワークフローは、メッセージを送信して開始することはできません。</span><span class="sxs-lookup"><span data-stu-id="fe05b-127">If a workflow does not begin with a Receive activity, it cannot be started by sending a message because there is no activity to receive the message.</span></span> <span data-ttu-id="fe05b-128">サービス以外のワークフローをホストするには、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> から派生クラスを作成し、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>、および <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> をオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="fe05b-128">To host a non-service workflow, derive a class from <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> and override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A>, <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A>, and <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A>.</span></span> <span data-ttu-id="fe05b-129"><xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> をオーバーライドすると、優先するインスタンスの ID を指定できます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-129">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetInstanceId%2A> if you want to provide a preferred instance ID.</span></span> <span data-ttu-id="fe05b-130"><xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> をオーバーライドすると、カスタムのワークフロー作成コンテキストを作成したり、既存の <xref:System.ServiceModel.Activities.WorkflowCreationContext> インスタンスを設定したりできます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-130">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnGetCreationContext%2A> to create a custom workflow creation context or populate an instance of the existing <xref:System.ServiceModel.Activities.WorkflowCreationContext>.</span></span> <span data-ttu-id="fe05b-131"><xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> をオーバーライドすると、受信メッセージから手動でブックマークを抽出できます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-131">Override <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint.OnResolveBookmark%2A> to manually extract the bookmark from the incoming message.</span></span> <span data-ttu-id="fe05b-132">このメソッドをオーバーライドすると、WorkflowHostingEndpoint に送信されたメッセージに応答するために本文で <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> を呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-132">If you override this method, you must invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> in its body so as to respond to the message sent to the WorkflowHostingEndpoint.</span></span> <span data-ttu-id="fe05b-133">これを呼び出さないと、<xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> の制限を最終的に超過する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-133">If you do not do so, a <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> limit may be eventually exceeded.</span></span> <span data-ttu-id="fe05b-134">双方向コントラクトでは、応答を受信するために発生したクライアントのエラーのために、<xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> の呼び出しで発生したエラーを検出できる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-134">In two-way contracts, you may be able to detect your   failure to invoke <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> because of the client’s failure to receive a response.</span></span> <span data-ttu-id="fe05b-135">一方向コントラクトでは、<xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> スロットルの制限を超過するまで <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> を呼び出していないというミスを認識しない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-135">In one-way contracts, you may not recognize the mistake of failing to call <xref:System.ServiceModel.Activities.WorkflowHostingResponseContext.SendResponse%2A> until it’s too late, after the <xref:System.ServiceModel.Description.ServiceThrottlingBehavior.MaxConcurrentCalls%2A> throttle limit is exceeded.</span></span> <span data-ttu-id="fe05b-136">詳細については、 [WorkflowHostingEndpoint Resume ブックマーク](../../windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)を参照して、サービス以外のワークフローの新しいインスタンスを作成し、新しいインスタンスを作成する操作を定義するサービスコントラクトを宣言してください。</span><span class="sxs-lookup"><span data-stu-id="fe05b-136">For more information, please see the [WorkflowHostingEndpoint Resume Bookmark](../../windows-workflow-foundation/samples/workflowhostingendpoint-resume-bookmark.md)To create a new instance of a non-service workflow, declare a service contract that defines an operation that creates a new instance.</span></span> <span data-ttu-id="fe05b-137">作成操作は、 \<string, object> 必要なワークフローパラメーターを渡すために、IDictionary を受け取る必要があります。</span><span class="sxs-lookup"><span data-stu-id="fe05b-137">The creation operation should take an IDictionary\<string, object> to pass any required workflow parameters.</span></span> <span data-ttu-id="fe05b-138">このコントラクトは、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> の派生クラスによって、暗黙で実装されます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-138">This contract is implicitly implemented by the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class.</span></span> <span data-ttu-id="fe05b-139">ワークフローをホストする場合は、<xref:System.ServiceModel.Activities.WorkflowHostingEndpoint> を呼び出して <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> の派生クラスのインスタンスをホストに追加し、<xref:System.ServiceModel.Channels.CommunicationObject.Open%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-139">When hosting the workflow, add an instance of the <xref:System.ServiceModel.Activities.WorkflowHostingEndpoint>-derived class to the host by calling <xref:System.ServiceModel.Activities.WorkflowServiceHost.AddServiceEndpoint%2A> and call <xref:System.ServiceModel.Channels.CommunicationObject.Open%2A>.</span></span> <span data-ttu-id="fe05b-140">ワークフローのインスタンスを作成するには、使用するサービス コントラクト型の <xref:System.ServiceModel.ChannelFactory%601> を作成し、<xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="fe05b-140">To create an instance of the workflow, create a <xref:System.ServiceModel.ChannelFactory%601> of your service contract type and call <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A>.</span></span> <span data-ttu-id="fe05b-141">これで、サービス コントラクトに定義されている作成操作を呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="fe05b-141">You can then call the create operation defined in your service contract.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="fe05b-142">関連項目</span><span class="sxs-lookup"><span data-stu-id="fe05b-142">See also</span></span>

- [<span data-ttu-id="fe05b-143">ワークフロー サービス</span><span class="sxs-lookup"><span data-stu-id="fe05b-143">Workflow Services</span></span>](workflow-services.md)
- [<span data-ttu-id="fe05b-144">メッセージング アクティビティ</span><span class="sxs-lookup"><span data-stu-id="fe05b-144">Messaging Activities</span></span>](messaging-activities.md)
