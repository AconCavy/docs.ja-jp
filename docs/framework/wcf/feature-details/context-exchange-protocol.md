---
title: コンテキスト交換プロトコル
ms.date: 03/30/2017
ms.assetid: 3dfd38e0-ae52-491c-94f4-7a862b9843d4
ms.openlocfilehash: ba613a2d12843ad00034057f8bbf08d5357d7f04
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96237821"
---
# <a name="context-exchange-protocol"></a><span data-ttu-id="7e14e-102">コンテキスト交換プロトコル</span><span class="sxs-lookup"><span data-stu-id="7e14e-102">Context Exchange Protocol</span></span>

<span data-ttu-id="7e14e-103">このセクションでは、Windows Communication Foundation (WCF) リリース .NET Framework バージョン3.5 で導入されたコンテキスト交換プロトコルについて説明します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-103">This section describes the context exchange protocol introduced in Windows Communication Foundation (WCF) release .NET Framework version 3.5.</span></span> <span data-ttu-id="7e14e-104">このプロトコルを使用すると、クライアント チャネルはサービスから送られたコンテキストを受け入れ、以降はそのコンテキストを、同じクライアント チャネル インスタンス経由でそのサービスに送信されるすべての要求に適用できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-104">This protocol allows the client channel to accept a context supplied by a service and apply it to all subsequent requests to that service sent over the same client channel instance.</span></span> <span data-ttu-id="7e14e-105">コンテキスト交換プロトコルを実装されると、2 つの機構 (HTTP クッキーまたは SOAP ヘッダー) のいずれか 1 つを使用し、サーバーとクライアント間でコンテキストを伝達できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-105">The implementation of the context exchange protocol can use one of the following two mechanisms to propagate the context between the server and the client: HTTP cookies or a SOAP header.</span></span>  
  
 <span data-ttu-id="7e14e-106">コンテキスト交換プロトコルは、カスタム チャネル層に実装されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-106">The context exchange protocol is implemented in a custom channel layer.</span></span> <span data-ttu-id="7e14e-107">チャネルでは <xref:System.ServiceModel.Channels.ContextMessageProperty> プロパティを使用して、アプリケーション層とコンテキストを送受信します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-107">The channel communicates the context to and from the application layer using a <xref:System.ServiceModel.Channels.ContextMessageProperty> property.</span></span> <span data-ttu-id="7e14e-108">エンドポイント間の転送については、コンテキストの値は、チャネル層で SOAP ヘッダーとしてシリアル化されるか、HTTP 要求および応答を表すメッセージ プロパティとの間で双方向に変換されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-108">For transmission between endpoints, the value of the context is either serialized as a SOAP header at the channel layer, or converted to or from the message properties that represent a HTTP request and response.</span></span> <span data-ttu-id="7e14e-109">後者の場合、下位のチャネル層のいずれか 1 つで、HTTP 要求および応答のメッセージ プロパティをそれぞれ HTTP クッキーとの間で双方向に変換する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-109">In the latter case, it is expected that one of the underlying channel layers converts the HTTP request and response message properties to and from HTTP cookies, respectively.</span></span> <span data-ttu-id="7e14e-110">コンテキスト交換に使用する機構の選択は、<xref:System.ServiceModel.Channels.ContextExchangeMechanism> の <xref:System.ServiceModel.Channels.ContextBindingElement> プロパティを使用します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-110">The choice of the mechanism used to exchange the context is done using the <xref:System.ServiceModel.Channels.ContextExchangeMechanism> property on the <xref:System.ServiceModel.Channels.ContextBindingElement>.</span></span> <span data-ttu-id="7e14e-111">有効な値は `HttpCookie` または `SoapHeader`です。</span><span class="sxs-lookup"><span data-stu-id="7e14e-111">Valid values are `HttpCookie` or `SoapHeader`.</span></span>  
  
 <span data-ttu-id="7e14e-112">クライアントでは、チャネルのインスタンスは <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> チャネル プロパティの設定値に基づいて 2 つのモードで動作します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-112">On the client, an instance of a channel can operate in two modes based on the settings on the channel property, <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A>.</span></span>  
  
## <a name="mode-1-channel-context-management"></a><span data-ttu-id="7e14e-113">モード 1: チャネル コンテキスト管理</span><span class="sxs-lookup"><span data-stu-id="7e14e-113">Mode 1: Channel Context Management</span></span>  

 <span data-ttu-id="7e14e-114">これは、<xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> を `true` に設定した場合の既定のモードです。</span><span class="sxs-lookup"><span data-stu-id="7e14e-114">This is the default mode where <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `true`.</span></span> <span data-ttu-id="7e14e-115">このモードでは、コンテキスト チャネルはコンテキストを管理し、その有効期間中、コンテキストをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="7e14e-115">In this mode the context channel manages the context and caches the context during its lifetime.</span></span> <span data-ttu-id="7e14e-116">コンテキストは、`IContextManager` メソッドを呼び出して、`GetContext` チャネル プロパティ経由でチャネルから取得できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-116">Context can be retrieved from the channel through channel property `IContextManager` by calling the `GetContext` method.</span></span> <span data-ttu-id="7e14e-117">チャネルを開く前に、チャネル プロパティで `SetContext` メソッドを呼び出して、事前に特定のコンテキストで初期化できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-117">The channel can also be pre-initialized with specific context before being opened by calling the `SetContext` method on the channel property.</span></span> <span data-ttu-id="7e14e-118">チャネルは一度コンテキストで初期化すると、リセットできません。</span><span class="sxs-lookup"><span data-stu-id="7e14e-118">Once the channel is initialized with context it cannot be reset.</span></span>  
  
 <span data-ttu-id="7e14e-119">このモードのインバリアントの一覧を次に示します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-119">The following is a list of invariants in this mode:</span></span>  
  
- <span data-ttu-id="7e14e-120">チャネルを開いた後に `SetContext` を使用してコンテキストをリセットしようとすると、<xref:System.InvalidOperationException> がスローされます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-120">Any attempt to reset the context using `SetContext` after the channel has been opened throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="7e14e-121">送信メッセージで <xref:System.ServiceModel.Channels.ContextMessageProperty> を使用してコンテキストを送信しようとすると、<xref:System.InvalidOperationException> がスローされます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-121">Any attempt to send context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty> in an outgoing message throws an <xref:System.InvalidOperationException>.</span></span>  
  
- <span data-ttu-id="7e14e-122">特定のコンテキストを持つサーバーからメッセージを受信する場合に、チャネルが既に特定のコンテキストで初期化されていると、<xref:System.ServiceModel.ProtocolException> が発生します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-122">If a message is received from server with a specific context, when the channel has already been initialized with a specific context, this results in a <xref:System.ServiceModel.ProtocolException>.</span></span>  
  
    > [!NOTE]
    > <span data-ttu-id="7e14e-123">明示的にコンテキストが設定されていないチャネルを開いている場合に限り、サーバーから初期コンテキストを受信するのが適切です。</span><span class="sxs-lookup"><span data-stu-id="7e14e-123">It is appropriate to receive an initial context from the server only if the channel is opened without any context set explicitly.</span></span>  
  
- <span data-ttu-id="7e14e-124">受信メッセージの <xref:System.ServiceModel.Channels.ContextMessageProperty> は常に null です。</span><span class="sxs-lookup"><span data-stu-id="7e14e-124">The <xref:System.ServiceModel.Channels.ContextMessageProperty> on incoming message is always null.</span></span>  
  
## <a name="mode-2-application-context-management"></a><span data-ttu-id="7e14e-125">モード 2: アプリケーション コンテキスト管理</span><span class="sxs-lookup"><span data-stu-id="7e14e-125">Mode 2: Application Context Management</span></span>  

 <span data-ttu-id="7e14e-126">これは、<xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> を `false` に設定した場合のモードです。</span><span class="sxs-lookup"><span data-stu-id="7e14e-126">This is the mode when <xref:System.ServiceModel.Channels.IContextManager.Enabled%2A> is set to `false`.</span></span> <span data-ttu-id="7e14e-127">このモードでは、コンテキスト チャネルでコンテキストを管理しません。</span><span class="sxs-lookup"><span data-stu-id="7e14e-127">In this mode the context channel does not manage context.</span></span> <span data-ttu-id="7e14e-128">コンテキストの取得、管理、および適用は、<xref:System.ServiceModel.Channels.ContextMessageProperty> を使用してアプリケーションで行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-128">It is the application's responsibility to retrieve, manage and apply context by using the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="7e14e-129">`GetContext` または `SetContext` を呼び出そうとすると、<xref:System.InvalidOperationException> が発生します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-129">Any attempt to call `GetContext` or `SetContext` results in an <xref:System.InvalidOperationException>.</span></span>  
  
 <span data-ttu-id="7e14e-130">どちらのモードを選択しても、クライアント チャネル ファクトリは、<xref:System.ServiceModel.Channels.IRequestChannel>、<xref:System.ServiceModel.Channels.IRequestSessionChannel>、および <xref:System.ServiceModel.Channels.IDuplexSessionChannel> の各メッセージ交換パターンをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7e14e-130">No matter which mode is chosen the client channel factory supports <xref:System.ServiceModel.Channels.IRequestChannel>, <xref:System.ServiceModel.Channels.IRequestSessionChannel>, and <xref:System.ServiceModel.Channels.IDuplexSessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="7e14e-131">サービスでは、チャネルのインスタンスが、受信メッセージでクライアントから送られたコンテキストを <xref:System.ServiceModel.Channels.ContextMessageProperty> に変換します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-131">On the service, an instance of the channel is responsible for converting the context supplied by the client on incoming messages to the <xref:System.ServiceModel.Channels.ContextMessageProperty>.</span></span> <span data-ttu-id="7e14e-132">これで、アプリケーション層、または呼び出しスタックの上位に位置する他のチャネルから、メッセージ プロパティにアクセスできるようになります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-132">The message property can then be accessed by the application layer or other channels further up in the call stack.</span></span> <span data-ttu-id="7e14e-133">サービス チャネルを使用し、応答メッセージに <xref:System.ServiceModel.Channels.ContextMessageProperty> をアタッチすることによって、クライアントに返される新しいコンテキスト値をアプリケーション層で指定することもできます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-133">The service channels also allow the application layer to specify a new context value to be propagated back to the client by attaching a <xref:System.ServiceModel.Channels.ContextMessageProperty> to the response message.</span></span> <span data-ttu-id="7e14e-134">このプロパティは、コンテキストを含む SOAP ヘッダーまたは HTTP クッキーに変換されます。どちらに変換されるかは、バイディングの構成によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-134">This property is converted to the SOAP header or HTTP cookie that contains the context, which depends on the configuration of the binding.</span></span> <span data-ttu-id="7e14e-135">サービス チャネル リスナーは、<xref:System.ServiceModel.Channels.IReplyChannel>、<xref:System.ServiceModel.Channels.IReplySessionChannel>、および <xref:System.ServiceModel.Channels.IReplySessionChannel> の各メッセージ交換パターンをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7e14e-135">The service channel listener supports <xref:System.ServiceModel.Channels.IReplyChannel>, <xref:System.ServiceModel.Channels.IReplySessionChannel>, and <xref:System.ServiceModel.Channels.IReplySessionChannel> message exchange patterns.</span></span>  
  
 <span data-ttu-id="7e14e-136">コンテキスト交換プロトコルは、コンテキストの伝達に HTTP クッキーを使用しない場合にコンテキスト情報を表す新しい `wsc:Context` SOAP ヘッダーを使用します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-136">The context exchange protocol introduces a new `wsc:Context` SOAP header to represent the context information when HTTP cookies are not used to propagate the context.</span></span> <span data-ttu-id="7e14e-137">コンテキスト ヘッダー スキーマでは、文字列キーと文字列コンテンツを持つ任意の数の子要素を使用できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-137">The context header schema allows for any number of child elements, each with a string key and string content.</span></span> <span data-ttu-id="7e14e-138">コンテキスト ヘッダーの例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-138">The following is an example of a context header.</span></span>  
  
 `<Context xmlns="http://schemas.microsoft.com/ws/2006/05/context">`  
  
 `<property name="myContext">context-2</property>`  
  
 `</Context>`  
  
 <span data-ttu-id="7e14e-139">`HttpCookie` モードの場合、`SetCookie` ヘッダーを使用してクッキーが設定されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-139">When in `HttpCookie` mode, cookies are set using the `SetCookie` header.</span></span> <span data-ttu-id="7e14e-140">クッキーの名前は `WscContext` です。</span><span class="sxs-lookup"><span data-stu-id="7e14e-140">The cookie name is `WscContext`.</span></span> <span data-ttu-id="7e14e-141">クッキーの値は、`wsc:Context` ヘッダーの Base64 エンコーディングです。</span><span class="sxs-lookup"><span data-stu-id="7e14e-141">The value of the cookie is the Base64 encoding of the `wsc:Context` header.</span></span> <span data-ttu-id="7e14e-142">この値は引用符で囲まれます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-142">This value is enclosed in quotes.</span></span>  
  
 <span data-ttu-id="7e14e-143">WS-Addressing ヘッダーを保護するのと同じ理由により、コンテキスト値は、転送中に変更されないように保護する必要があります。WS-Addressing ヘッダーは、サービスで要求のディスパッチ先を確認するのに使用されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-143">The value of the context must be protected from modification while in transit for the same reason WS-Addressing headers are protected – the header is used to determine where to dispatch the request to on the service.</span></span> <span data-ttu-id="7e14e-144">したがって、バインディングにメッセージ保護機能がある場合、SOAP レベルかトランスポート レベルのいずれかで `wsc:Context` ヘッダーにデジタル署名するか、署名と暗号化を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-144">The `wsc:Context` header is therefore required to be digitally signed or signed and encrypted at either the SOAP or transport level when the binding offers message protection capability.</span></span> <span data-ttu-id="7e14e-145">HTTP クッキーを使用してコンテキストを伝達する場合は、トランスポート セキュリティを使用して保護する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7e14e-145">When HTTP cookies are used to propagate context, they should be protected using transport security.</span></span>  
  
 <span data-ttu-id="7e14e-146">サービス エンドポイントでコンテキスト交換プロトコルのサポートを必要とする場合は、公開するポリシーにそのことを明示できます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-146">Service endpoints that require support for the context exchange protocol can make it explicit in the published policy.</span></span> <span data-ttu-id="7e14e-147">新たに 2 つのポリシー アサーションが導入され、SOAP レベルでコンテキスト交換プロトコルをサポートしたり、HTTP クッキーのサポートを有効化したりするクライアント要件を示すことができます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-147">Two new policy assertions have been introduced to represent the requirement for the client to support the context exchange protocol at the SOAP level or to enable HTTP cookie support.</span></span> <span data-ttu-id="7e14e-148">このアサーションはサービスのポリシー内に生成されます。生成は次のように、<xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> プロパティの値によって制御します。</span><span class="sxs-lookup"><span data-stu-id="7e14e-148">Generation of these assertions into the policy on the service is controlled by the value of the <xref:System.ServiceModel.Channels.ContextBindingElement.ContextExchangeMechanism%2A> property as follows:</span></span>  
  
- <span data-ttu-id="7e14e-149"><xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader> の場合は、次のアサーションが生成されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-149">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.ContextSoapHeader>, the following assertion is generated:</span></span>  
  
    ```xml  
    <IncludeContext
    xmlns="http://schemas.microsoft.com/ws/2006/05/context"  
    protectionLevel="Sign" />  
    ```  
  
- <span data-ttu-id="7e14e-150"><xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie> の場合は、次のアサーションが生成されます。</span><span class="sxs-lookup"><span data-stu-id="7e14e-150">For <xref:System.ServiceModel.Channels.ContextExchangeMechanism.HttpCookie>, the following assertion is generated:</span></span>  
  
    ```xml  
    <HttpUseCookie xmlns="http://schemas.xmlsoap.org/soap/http"/>  
    ```  
  
## <a name="see-also"></a><span data-ttu-id="7e14e-151">関連項目</span><span class="sxs-lookup"><span data-stu-id="7e14e-151">See also</span></span>

- [<span data-ttu-id="7e14e-152">Web サービス プロトコルの相互運用性ガイド</span><span class="sxs-lookup"><span data-stu-id="7e14e-152">Web Services Protocols Interoperability Guide</span></span>](web-services-protocols-interoperability-guide.md)
