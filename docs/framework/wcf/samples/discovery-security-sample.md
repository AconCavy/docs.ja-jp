---
title: 探索のセキュリティのサンプル
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: 00f81d1879d9157a7ecdfa0db8d2ea0d505ad5b6
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/12/2020
ms.locfileid: "79183739"
---
# <a name="discovery-security-sample"></a><span data-ttu-id="f09a8-102">探索のセキュリティのサンプル</span><span class="sxs-lookup"><span data-stu-id="f09a8-102">Discovery Security Sample</span></span>

<span data-ttu-id="f09a8-103">Discovery 仕様では、探索プロセスに参加するエンドポイントをセキュリティで保護する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f09a8-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="f09a8-104">探索メッセージをセキュリティで強化することで、さまざまな種類の攻撃 (メッセージの改ざん、サービス拒否、リプレイ、なりすまし) が軽減されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="f09a8-105">このサンプルでは、コンパクトな署名形式 (WS-Discovery 仕様のセクション 8.2 を参照) を使用してメッセージ署名の計算と検証を行うカスタム チャネルの実装方法を示します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="f09a8-106">サンプルでは[、2005 ディスカバリー仕様](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf)と[1.1 バージョン](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf)の両方がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="f09a8-106">The sample supports both the [2005 Discovery specification](http://specs.xmlsoap.org/ws/2005/04/discovery/ws-discovery.pdf) and the [1.1 version](http://docs.oasis-open.org/ws-dd/discovery/1.1/cs-01/wsdd-discovery-1.1-spec-cs-01.pdf).</span></span>  
  
 <span data-ttu-id="f09a8-107">カスタム チャネルは、探索エンドポイントおよびアナウンス エンドポイントの既存のチャネル スタックの上に適用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="f09a8-108">これにより、署名ヘッダーがすべての送信メッセージに適用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="f09a8-109">署名は受信メッセージで検証され、署名が一致しない場合やメッセージに署名がない場合、そのメッセージは破棄されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="f09a8-110">このサンプルでは、メッセージの署名と検証を行うために証明書を使用します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="f09a8-111">ディスカッション</span><span class="sxs-lookup"><span data-stu-id="f09a8-111">Discussion</span></span>  
 <span data-ttu-id="f09a8-112">WCF は拡張性が非常に高く、ユーザーは必要に応じてチャネルをカスタマイズできます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="f09a8-113">このサンプルでは、セキュリティで保護されたチャネルを作成する、探索のセキュリティ保護されたバインド要素を実装します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="f09a8-114">セキュリティで保護されたチャネルは、メッセージ署名を適用および検証します。このチャネルは現在のスタックの上に適用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="f09a8-115">セキュリティ保護されたバインディング要素は、セキュリティで保護されたチャネル ファクトリとチャネル リスナーを作成します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="f09a8-116">セキュリティで保護されたチャネル ファクトリ</span><span class="sxs-lookup"><span data-stu-id="f09a8-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="f09a8-117">セキュリティで保護されたチャネル ファクトリは、メッセージ ヘッダーにコンパクトな署名を追加する出力チャネルまたは双方向チャネルを作成します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="f09a8-118">メッセージをできるだけ小さくするために、コンパクトな署名形式が使用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="f09a8-119">コンパクトな署名の構造の例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >
  [<d:Sig Scheme="xs:anyURI"
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"
          Sig="xs:base64Binary"
          ... />]?  
  ...
</d:Security>  
```  
  
> [!NOTE]
> <span data-ttu-id="f09a8-120">`PrefixList` は、Discovery プロトコルの 2008 バージョンで追加されました。</span><span class="sxs-lookup"><span data-stu-id="f09a8-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="f09a8-121">このサンプルでは、署名を計算するために、展開される署名のアイテムを特定します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="f09a8-122">WS-Discovery 仕様の規定のとおり、XML 署名 (`SignedInfo`) が `ds` 名前空間プレフィックスを使用して作成されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="f09a8-123">探索の本文とすべてのヘッダーおよびアドレス名前空間は署名で参照されるため、改ざんされることはありません。</span><span class="sxs-lookup"><span data-stu-id="f09a8-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="f09a8-124">参照される各要素は、排他的正規化 ( )http://www.w3.org/2001/10/xml-exc-c14n#を使用して変換され、SHA-1 ダイジェスト値が計算http://www.w3.org/2000/09/xmldsig#sha1されます ( )。</span><span class="sxs-lookup"><span data-stu-id="f09a8-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="f09a8-125">参照されるすべての要素とそのダイジェスト値に基づいて、署名値は RSA アルゴリズム ( )http://www.w3.org/2000/09/xmldsig#rsa-sha1を使用して計算されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="f09a8-126">メッセージは、クライアントが指定した証明書を使用して署名されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="f09a8-127">バインディング要素の作成時に、ストアの場所、名前、および証明書のサブジェクト名を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f09a8-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="f09a8-128">コンパクトな署名の `KeyId` は、署名トークンのキー識別子を表します。これは、署名トークンのサブジェクト キー識別子 (SKI) か、署名トークンの公開キーの SHA-1 ハッシュ (SKI が存在しない場合) です。</span><span class="sxs-lookup"><span data-stu-id="f09a8-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="f09a8-129">セキュリティで保護されたチャネル リスナー</span><span class="sxs-lookup"><span data-stu-id="f09a8-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="f09a8-130">セキュリティで保護されたチャネル リスナーは、受信メッセージのコンパクトな署名を検証する入力チャネルまたは双方向チャネルを作成します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="f09a8-131">署名を検証するために、メッセージに結び付けられているコンパクトな署名で指定された `KeyId` を使用して、指定されたストアから証明書が選択されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="f09a8-132">メッセージに署名がない場合や署名のチェックに失敗した場合、そのメッセージは破棄されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="f09a8-133">このサンプルでは、セキュリティで保護されたバインディングを使用するために、探索のセキュリティ保護されたバインド要素が追加されたカスタムの <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> と <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> を作成するファクトリを定義します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="f09a8-134">これらのセキュリティで保護されたエンドポイントは、探索アナウンス リスナーや探索サービスで使用できます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="f09a8-135">サンプルの詳細</span><span class="sxs-lookup"><span data-stu-id="f09a8-135">Sample Details</span></span>  
 <span data-ttu-id="f09a8-136">このサンプルには、1 つのライブラリと 4 つのコンソール アプリケーションが含まれています。</span><span class="sxs-lookup"><span data-stu-id="f09a8-136">The sample includes a library and 4 console applications:</span></span>  
  
- <span data-ttu-id="f09a8-137">**セキュリティ保護**されたバインディングを公開するライブラリ。</span><span class="sxs-lookup"><span data-stu-id="f09a8-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="f09a8-138">このライブラリは、送信/受信メッセージのコンパクトな署名の計算と検証を行います。</span><span class="sxs-lookup"><span data-stu-id="f09a8-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
- <span data-ttu-id="f09a8-139">**サービス**: ICalculatorService コントラクトを公開するサービスで、自己ホスト型です。</span><span class="sxs-lookup"><span data-stu-id="f09a8-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="f09a8-140">このサービスは、Discoverable としてマークされます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="f09a8-141">メッセージの署名に使用する証明書の詳細はユーザーが指定します。ストアの場所と名前、証明書のサブジェクト名またはその他の一意の識別子、およびクライアント証明書 (受信メッセージの署名のチェックに使用する証明書) の保存場所を指定します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="f09a8-142">これらの詳細に基づいて、セキュリティが追加された UdpDiscoveryEndpoint が作成されて使用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
- <span data-ttu-id="f09a8-143">**クライアント**: このクラスは、ICalculatorService を検出し、サービスのメソッドを呼び出そうとします。</span><span class="sxs-lookup"><span data-stu-id="f09a8-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="f09a8-144">ここでも、メッセージの署名と検証を行うために、セキュリティが追加された <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> が作成されて使用されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
- <span data-ttu-id="f09a8-145">**AnnouncementListener**: オンラインおよびオフラインのアナウンスをリッスンし、セキュアアナウンス エンドポイントを使用する、自己ホスト型サービス。</span><span class="sxs-lookup"><span data-stu-id="f09a8-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="f09a8-146">Setup.bat を複数回実行すると、証明書が重複し、証明書マネージャーから、追加する証明書を選択するように求められます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="f09a8-147">その場合は、既に重複が作成されているため、Setup.bat を中止して Cleanup.bat を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="f09a8-148">Cleanup.bat でも、削除する証明書を選択するように求められます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="f09a8-149">一覧から証明書を選択し、残っている証明書がなくなるまで Cleanup.bat を実行します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="f09a8-150">このサンプルを使用するには</span><span class="sxs-lookup"><span data-stu-id="f09a8-150">To use this sample</span></span>  
  
1. <span data-ttu-id="f09a8-151">Visual Studio の開発者コマンド プロンプトから Setup.bat スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-151">Execute the Setup.bat script from a Developer Command Prompt for Visual Studio.</span></span> <span data-ttu-id="f09a8-152">このサンプルでは、証明書を使用してメッセージの署名と検証を行います。</span><span class="sxs-lookup"><span data-stu-id="f09a8-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="f09a8-153">スクリプトによって、証明書が Makecert.exe を使用して作成され、Certmgr.exe を使用してインストールされます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="f09a8-154">このスクリプトは、管理者権限で実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f09a8-154">The script must be run with administrator privileges.</span></span>  
  
2. <span data-ttu-id="f09a8-155">サンプルをビルドして実行するには、Visual Studio で Security.sln ファイルを開き、[**すべてリビルド**] を選択します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="f09a8-156">ソリューションのプロパティを更新して複数のプロジェクトを開始する: [DiscoverySecureChannels] を除くすべてのプロジェクトで **[開始**] を選択します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="f09a8-157">通常どおりソリューションを実行します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-157">Run the solution normally.</span></span>  
  
3. <span data-ttu-id="f09a8-158">サンプルの作業が終了したら、このサンプルで作成した証明書を削除する Cleanup.bat スクリプトを実行します。</span><span class="sxs-lookup"><span data-stu-id="f09a8-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="f09a8-159">サンプルは、既にコンピューターにインストールされている場合があります。</span><span class="sxs-lookup"><span data-stu-id="f09a8-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="f09a8-160">続行する前に、次の (既定の) ディレクトリを確認してください。</span><span class="sxs-lookup"><span data-stu-id="f09a8-160">Check for the following (default) directory before continuing.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> <span data-ttu-id="f09a8-161">このディレクトリが存在しない場合は[、.NET Framework 4 の Windows コミュニケーション ファウンデーション (WCF) および Windows ワークフローファウンデーション (WF) サンプル](https://www.microsoft.com/download/details.aspx?id=21459)に移動して、すべての Windows 通信基盤 (WCF) とサンプルを[!INCLUDE[wf1](../../../../includes/wf1-md.md)]ダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="f09a8-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="f09a8-162">このサンプルは、次のディレクトリに格納されます。</span><span class="sxs-lookup"><span data-stu-id="f09a8-162">This sample is located in the following directory.</span></span>  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
