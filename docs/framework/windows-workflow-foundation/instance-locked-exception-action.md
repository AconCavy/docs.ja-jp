---
title: インスタンス ロック例外アクション
ms.date: 03/30/2017
ms.assetid: 164a5419-315c-4987-ad72-54cbdb88d402
ms.openlocfilehash: 3554975589bb6d55cef3611320d25687d1ee9ba6
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96279858"
---
# <a name="instance-locked-exception-action"></a><span data-ttu-id="96702-102">インスタンス ロック例外アクション</span><span class="sxs-lookup"><span data-stu-id="96702-102">Instance Locked Exception Action</span></span>

<span data-ttu-id="96702-103">SQL Workflow Instance Store の <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> プロパティでは、SQL 永続化プロバイダーが <xref:System.Runtime.DurableInstancing.InstanceLockedException> を受け取ったときに実行するアクションを指定します。</span><span class="sxs-lookup"><span data-stu-id="96702-103">The <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore.InstanceLockedExceptionAction%2A> property of the SQL Workflow Instance Store lets you specify what action the SQL persistence provider should take when it receives an <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span> <span data-ttu-id="96702-104">永続化プロバイダーがこの例外を受け取るのは、別のサービス ホストが現在ロックしているワークフロー サービス インスタンスをこの永続化プロバイダーがロックしようとしたときです。</span><span class="sxs-lookup"><span data-stu-id="96702-104">The persistence provider receives this exception when it tries to lock a workflow service instance that is currently locked by another service host.</span></span> <span data-ttu-id="96702-105">このプロパティの値は <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>、<xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>、および <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> です。</span><span class="sxs-lookup"><span data-stu-id="96702-105">The values for this property are <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>, <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>, and <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span></span> <span data-ttu-id="96702-106">既定値は <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> です。</span><span class="sxs-lookup"><span data-stu-id="96702-106">The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span> <span data-ttu-id="96702-107">この 3 つのオプションを次の一覧で説明します。</span><span class="sxs-lookup"><span data-stu-id="96702-107">The following list describes the three options:</span></span>  
  
- <span data-ttu-id="96702-108"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span><span class="sxs-lookup"><span data-stu-id="96702-108"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span> <span data-ttu-id="96702-109">サービスホストは、ワークフローサービスインスタンスのロックを試行せず、を <xref:System.Runtime.DurableInstancing.InstanceLockedException> 呼び出し元に渡します。</span><span class="sxs-lookup"><span data-stu-id="96702-109">The service host does not attempt to lock the workflow service instance and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller.</span></span>  <span data-ttu-id="96702-110">60秒を超える期間、ワークフローがメモリ内にとどまる場合は、 <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> 再試行としてを使用します。</span><span class="sxs-lookup"><span data-stu-id="96702-110">If your workflow stays in memory for a period exceeding 60 seconds, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> as the retry.</span></span> <span data-ttu-id="96702-111">既定値は <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry> です。</span><span class="sxs-lookup"><span data-stu-id="96702-111">The default value is <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.NoRetry>.</span></span>  
  
- <span data-ttu-id="96702-112"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>.</span><span class="sxs-lookup"><span data-stu-id="96702-112"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry>.</span></span> <span data-ttu-id="96702-113">サービス ホストは一定の再試行間隔でワークフロー サービス インスタンスのロックを再試行し、シーケンスの最後に <xref:System.Runtime.DurableInstancing.InstanceLockedException> を呼び出し元に渡します。</span><span class="sxs-lookup"><span data-stu-id="96702-113">The service host reattempts to lock the workflow service instance with a linear interval between retry attempts and passes the <xref:System.Runtime.DurableInstancing.InstanceLockedException> to the caller at the end of the sequence.</span></span> <span data-ttu-id="96702-114">ワークフローがおよそ 5 ～ 60 秒間メモリに留まり、ワークフローをアンロードする前にすべてのメッセージを処理するため、同じホスト上の同じインスタンスに送信されるメッセージのようにメッセージがバッチで届く場合、リソースを無駄にしない最適な待ち時間を実現するため <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> を使用します。</span><span class="sxs-lookup"><span data-stu-id="96702-114">If you workflow stays in memory approximately between 5-60 seconds, and messages arrive in batches where it is more likely for messages being sent to the same instance on the same host to process all messages before unloading the workflow, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> to achieve the best latency without wasting resources.</span></span>  
  
- <span data-ttu-id="96702-115"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span><span class="sxs-lookup"><span data-stu-id="96702-115"><xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>.</span></span> <span data-ttu-id="96702-116">サービス ホストは指数バックオフ間隔でワークフロー サービス インスタンスのロックを再試行し、シーケンスの最後に例外を呼び出し元に渡します。</span><span class="sxs-lookup"><span data-stu-id="96702-116">The service host reattempts to lock the workflow service instance with an exponential backoff interval between retry attempts, and passes the exception to the caller at the end of the sequence.</span></span> <span data-ttu-id="96702-117">ワーク フローがとても短い間 (5 秒以内) 目盛りに留まる場合、または Web ファームが大きく別のメッセージが同じホストに渡される可能性が高くない場合、最適な待ち時間を実現するため <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> を使用します。</span><span class="sxs-lookup"><span data-stu-id="96702-117">If your workflow stays in memory for a very short time (less than 5 seconds), or a Web farm is large and the chance of another message being delivered to the same host is not very high, use <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> to achieve the best latency.</span></span>  
  
 <span data-ttu-id="96702-118">インスタンス ロック例外アクション機能は、次のシナリオをサポートしています。</span><span class="sxs-lookup"><span data-stu-id="96702-118">The Instance Locked Exception Action feature supports the following scenarios.</span></span> <span data-ttu-id="96702-119">いずれのシナリオでも、SqlWorkflowInstanceStore の instanceLockedExceptionAction プロパティが <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> または <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry> に設定されていれば、ホストはインスタンスのロックを取得するために、再試行を自動的に繰り返します。</span><span class="sxs-lookup"><span data-stu-id="96702-119">In all scenarios, if the instanceLockedExceptionAction property of the SqlWorkflowInstanceStore is set to <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.BasicRetry> or <xref:System.Activities.DurableInstancing.InstanceLockedExceptionAction.AggressiveRetry>, the host transparently retries to acquire the lock on instances periodically.</span></span>  
  
1. <span data-ttu-id="96702-120">**正常なシャットダウンの有効化およびアプリケーション ドメインの重複したリサイクル。**</span><span class="sxs-lookup"><span data-stu-id="96702-120">**Enabling graceful shutdown and overlapped recycling of application domains.**</span></span> <span data-ttu-id="96702-121">ワークフローサービスインスタンスを実行しているサービスホストを持つ **appdomain** がリサイクルされ、古い **appdomain** が正常に停止している間に新しい要求を並列処理するために新しい **appdomain** が起動されるとします。</span><span class="sxs-lookup"><span data-stu-id="96702-121">Suppose an **AppDomain** with a service host running workflow service instances is being recycled and a new **AppDomain** is brought up to handle new requests in parallel while the old **AppDomain** is brought down gracefully.</span></span> <span data-ttu-id="96702-122">このシャットダウンは、ワークフロー サービス インスタンスがアイドル状態になるまで待機した後、このインスタンスを永続化してアンロードします。</span><span class="sxs-lookup"><span data-stu-id="96702-122">The shutdown waits until workflow service instances are idle, and then persists and unloads the instances.</span></span> <span data-ttu-id="96702-123">新しい **AppDomain** のホストがインスタンスをロックすると、が発生 <xref:System.Runtime.DurableInstancing.InstanceLockedException> します。</span><span class="sxs-lookup"><span data-stu-id="96702-123">Any attempts by hosts in the new **AppDomain** to lock an instance will cause an <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span>  
  
2. <span data-ttu-id="96702-124">**同種サーバー ファームでの永続的ワークフローの水平的スケーリング:**</span><span class="sxs-lookup"><span data-stu-id="96702-124">**Horizontally scaling durable workflows across a homogeneous farm of servers.**</span></span> <span data-ttu-id="96702-125">ワークフロー インスタンスが実行されているサーバー ファームのノードがクラッシュし、ワークフロー ホストが実行しているインスタンスのロックを解除できないことを想定しています。</span><span class="sxs-lookup"><span data-stu-id="96702-125">Suppose a node of a server farm on which a workflow instance is running crashes and the workflow host cannot remove locks on the instance it is running.</span></span> <span data-ttu-id="96702-126">ファームの別のノードで実行されているサービス ホストは、そのワークフロー インスタンスのメッセージを受け取ると、<xref:System.Runtime.DurableInstancing.InstanceLockedException> を受け取ることになる、これらのインスタンスのロックを取得する処理を試行します。</span><span class="sxs-lookup"><span data-stu-id="96702-126">When a service host running on another node of the farm receives a message for that workflow instance, it tries to acquire locks on these instances it will receive the <xref:System.Runtime.DurableInstancing.InstanceLockedException>.</span></span> <span data-ttu-id="96702-127">ロックを更新することになっていたホストは存在しないため、ロックはしばらくすると期限切れになります。</span><span class="sxs-lookup"><span data-stu-id="96702-127">The locks will expire after some time because the host that was supposed to renew the lock no longer exists.</span></span>  
  
     <span data-ttu-id="96702-128">**同種サーバー ファームでの永続的ワークフローの水平的スケーリング:**</span><span class="sxs-lookup"><span data-stu-id="96702-128">**Horizontally scaling durable workflows across a homogeneous farm of servers.**</span></span>  <span data-ttu-id="96702-129">NLB (ネットワーク負荷分散) の内側で複数のホストを使用して永続的なワークフローを水平的にスケーリングし、ファームのいずれかのノードで実行されているワークフロー ホストがワークフロー インスタンスを読み込み、メッセージを処理することを想定しています。また、このインスタンスへの次のメッセージは別のノードで実行されているホストにルーティングされます。これは、すでにインスタンスを実行しているホストにメッセージを届けるルーティング アルゴリズムが NLB にないためです。</span><span class="sxs-lookup"><span data-stu-id="96702-129">Suppose you want to horizontally scale a durable workflow using multiple hosts behind a NLB (Network Load Balancer), the workflow host running on one node of the farm loads a workflow instance and is processing a message, and the next message to the instance is routed to the host that is running on another node because the NLB does not have routing algorithm to deliver messages to the host that is already running the instance.</span></span> <span data-ttu-id="96702-130">メッセージを受け取ると、最初のホストがワークフロー インスタンスのロックを保持しているため、2 つ目のホストがこのインスタンスをロードする処理を試行し、<xref:System.Runtime.DurableInstancing.InstanceLockedException> を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="96702-130">Upon receiving the message, the second host attempts to load the workflow instance and receives the <xref:System.Runtime.DurableInstancing.InstanceLockedException> because the first host has a lock on the instance.</span></span> <span data-ttu-id="96702-131">最初のホストは、最初のメッセージの処理を完了してロック解除が行われるときにこのインスタンスのロックを解除し、2 つ目のホストは、次に再試行を行い、インスタンスをロードして、2 つ目のメッセージを処理するときにロックを取得します。</span><span class="sxs-lookup"><span data-stu-id="96702-131">The first host unlocks the instance when it is finished with processing the first message and the second host acquires the lock when it retries the next time, loads the instance, and processes the second message.</span></span>
