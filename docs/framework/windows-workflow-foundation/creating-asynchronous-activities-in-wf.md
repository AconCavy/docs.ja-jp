---
title: WF 内での非同期アクティビティの作成
description: AsyncCodeActivity を使用してカスタム非同期アクティビティを作成する方法について説明します。これにより、派生アクティビティが非同期実行ロジックを実装できるようになります。
ms.date: 03/30/2017
ms.assetid: 497e81ed-5eef-460c-ba55-fae73c05824f
ms.openlocfilehash: a03fbde1ff27084cc36dffc3a1912220d9bbca7e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/26/2020
ms.locfileid: "96242085"
---
# <a name="creating-asynchronous-activities-in-wf"></a><span data-ttu-id="73e09-103">WF 内での非同期アクティビティの作成</span><span class="sxs-lookup"><span data-stu-id="73e09-103">Creating Asynchronous Activities in WF</span></span>

<span data-ttu-id="73e09-104"><xref:System.Activities.AsyncCodeActivity> は使用する基本クラスをアクティビティ作成者に提供します。その結果、派生アクティビティが非同期実行ロジックを実装できるようになります。</span><span class="sxs-lookup"><span data-stu-id="73e09-104"><xref:System.Activities.AsyncCodeActivity> provides activity authors a base class to use that enables derived activities to implement asynchronous execution logic.</span></span> <span data-ttu-id="73e09-105">これは、ワークフローのスケジューラ スレッドを保持したり、並行して実行される可能性があるすべてのアクティビティをブロックしたりすることなく、非同期作業を実行する必要があるカスタム アクティビティに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="73e09-105">This is useful for custom activities that must perform asynchronous work without holding the workflow scheduler thread and blocking any activities that may be able to run in parallel.</span></span> <span data-ttu-id="73e09-106">ここでは、<xref:System.Activities.AsyncCodeActivity> を使用してカスタムの非同期アクティビティを作成する方法の概要を説明します。</span><span class="sxs-lookup"><span data-stu-id="73e09-106">This topic provides an overview of how to create custom asynchronous activities using <xref:System.Activities.AsyncCodeActivity>.</span></span>  
  
## <a name="using-asynccodeactivity"></a><span data-ttu-id="73e09-107">AsyncCodeActivity の使用</span><span class="sxs-lookup"><span data-stu-id="73e09-107">Using AsyncCodeActivity</span></span>  

 <span data-ttu-id="73e09-108"><xref:System.Activities?displayProperty=nameWithType> は、カスタム アクティビティ作成者に、アクティビティの作成要件に応じてさまざまな基本クラスを提供します。</span><span class="sxs-lookup"><span data-stu-id="73e09-108"><xref:System.Activities?displayProperty=nameWithType> provides custom activity authors with different base classes for different activity authoring requirements.</span></span> <span data-ttu-id="73e09-109">それぞれが特定のセマンティックを持ち、ワークフロー作成者 (およびアクティビティ ランタイム) に対応するコントラクトを提供します。</span><span class="sxs-lookup"><span data-stu-id="73e09-109">Each one carries a particular semantic and provides a workflow author (and the activity runtime) a corresponding contract.</span></span> <span data-ttu-id="73e09-110"><xref:System.Activities.AsyncCodeActivity> ベースのアクティビティは、スケジューラ スレッド、およびマネージド コードで表される実行ロジックに関連して、非同期に作業を実行するアクティビティです。</span><span class="sxs-lookup"><span data-stu-id="73e09-110">An <xref:System.Activities.AsyncCodeActivity> based activity is an activity that performs work asynchronously relative to the scheduler thread and whose execution logic is expressed in managed code.</span></span> <span data-ttu-id="73e09-111">非同期作業になると、<xref:System.Activities.AsyncCodeActivity> によって実行中にアイドル ポイントが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="73e09-111">As a result of going asynchronous, an <xref:System.Activities.AsyncCodeActivity> may induce an idle point during execution.</span></span> <span data-ttu-id="73e09-112">非同期作業には揮発的な性質があるため、<xref:System.Activities.AsyncCodeActivity> はアクティビティの実行期間に対して常に非永続的なブロックを作成します。</span><span class="sxs-lookup"><span data-stu-id="73e09-112">Due to the volatile nature of asynchronous work, an <xref:System.Activities.AsyncCodeActivity> always creates a no persist block for the duration of the activity’s execution.</span></span> <span data-ttu-id="73e09-113">こうすることで、ワークフロー ランタイムによって、非同期作業中にワークフロー インスタンスが永続化されることを回避できます。また、非同期コードの実行中にワークフロー インスタンスがアンロードされることを回避できます。</span><span class="sxs-lookup"><span data-stu-id="73e09-113">This prevents the workflow runtime from persisting the workflow instance in the middle of the asynchronous work, and also prevents the workflow instance from unloading while the asynchronous code is executing.</span></span>  
  
### <a name="asynccodeactivity-methods"></a><span data-ttu-id="73e09-114">AsyncCodeActivity メソッド</span><span class="sxs-lookup"><span data-stu-id="73e09-114">AsyncCodeActivity Methods</span></span>  

 <span data-ttu-id="73e09-115"><xref:System.Activities.AsyncCodeActivity> から派生するアクティビティでは、<xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> メソッドと <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> メソッドをカスタム コードでオーバーライドすることで、非同期実行ロジックを作成できます。</span><span class="sxs-lookup"><span data-stu-id="73e09-115">Activities that derive from <xref:System.Activities.AsyncCodeActivity> can create asynchronous execution logic by overriding the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> methods with custom code.</span></span> <span data-ttu-id="73e09-116">ランタイムによって呼び出されるとき、これらのメソッドには <xref:System.Activities.AsyncCodeActivityContext> が渡されます。</span><span class="sxs-lookup"><span data-stu-id="73e09-116">When called by the runtime, these methods are passed an <xref:System.Activities.AsyncCodeActivityContext>.</span></span> <span data-ttu-id="73e09-117"><xref:System.Activities.AsyncCodeActivityContext>アクティビティの作成者が <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> /  <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> コンテキストのプロパティの中で共有状態を提供できるようにし <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> ます。</span><span class="sxs-lookup"><span data-stu-id="73e09-117"><xref:System.Activities.AsyncCodeActivityContext> allows the activity author to provide shared state across <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>/ <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> in the context’s <xref:System.Activities.AsyncCodeActivityContext.UserState%2A> property.</span></span> <span data-ttu-id="73e09-118">次の例では、`GenerateRandom` アクティビティによって非同期に乱数を生成します。</span><span class="sxs-lookup"><span data-stu-id="73e09-118">In the following example, a `GenerateRandom` activity generates a random number asynchronously.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#8](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#8)]  
  
 <span data-ttu-id="73e09-119">前の例のアクティビティは、<xref:System.Activities.AsyncCodeActivity%601> から派生し、`OutArgument<int>` という昇格した `Result` を備えています。</span><span class="sxs-lookup"><span data-stu-id="73e09-119">The previous example activity derives from <xref:System.Activities.AsyncCodeActivity%601>, and has an elevated `OutArgument<int>` named `Result`.</span></span> <span data-ttu-id="73e09-120">`GetRandom` メソッドが返す値は、<xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> のオーバーライドによって抽出され、返されます。また、この値は `Result` 値として設定されます。</span><span class="sxs-lookup"><span data-stu-id="73e09-120">The value returned by the `GetRandom` method is extracted and returned by the <xref:System.Activities.AsyncCodeActivity%601.EndExecute%2A> override, and this value is set as the `Result` value.</span></span> <span data-ttu-id="73e09-121">結果を返さない非同期アクティビティは、<xref:System.Activities.AsyncCodeActivity> から派生する必要があります。</span><span class="sxs-lookup"><span data-stu-id="73e09-121">Asynchronous activities that do not return a result should derive from <xref:System.Activities.AsyncCodeActivity>.</span></span> <span data-ttu-id="73e09-122">次の例では、`DisplayRandom` から派生する <xref:System.Activities.AsyncCodeActivity> アクティビティが定義されます。</span><span class="sxs-lookup"><span data-stu-id="73e09-122">In the following example, a `DisplayRandom` activity is defined which derives from <xref:System.Activities.AsyncCodeActivity>.</span></span> <span data-ttu-id="73e09-123">このアクティビティは `GetRandom` アクティビティに似ていますが、結果を返す代わりにコンソールにメッセージを表示します。</span><span class="sxs-lookup"><span data-stu-id="73e09-123">This activity is like the `GetRandom` activity but instead of returning a result it displays a message to the console.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#11](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#11)]  
  
 <span data-ttu-id="73e09-124">戻り値がないため、`DisplayRandom` は <xref:System.Action> の代わりに <xref:System.Func%602> を使用してデリゲートを呼び出し、デリゲートは値を返さないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="73e09-124">Note that because there is no return value, `DisplayRandom` uses an <xref:System.Action> instead of a <xref:System.Func%602> to invoke its delegate, and the delegate returns no value.</span></span>  
  
 <span data-ttu-id="73e09-125">また、<xref:System.Activities.AsyncCodeActivity> は <xref:System.Activities.AsyncCodeActivity.Cancel%2A> のオーバーライドも提供します。</span><span class="sxs-lookup"><span data-stu-id="73e09-125"><xref:System.Activities.AsyncCodeActivity> also provides a <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override.</span></span> <span data-ttu-id="73e09-126"><xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> と <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> は必須のオーバーライドですが、<xref:System.Activities.AsyncCodeActivity.Cancel%2A> はオプションで、アクティビティを取り消したり中止したりするときに未処理の非同期状態を消去できるようにオーバーライドすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="73e09-126">While <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> are required overrides, <xref:System.Activities.AsyncCodeActivity.Cancel%2A> is optional, and can be overridden so the activity can clean up its outstanding asynchronous state when it is being canceled or aborted.</span></span> <span data-ttu-id="73e09-127">消去が可能で `AsyncCodeActivity.ExecutingActivityInstance.IsCancellationRequested` が `true` の場合、アクティビティでは <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="73e09-127">If clean up is possible and `AsyncCodeActivity.ExecutingActivityInstance.IsCancellationRequested` is `true`, the activity should call <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span></span> <span data-ttu-id="73e09-128">このメソッドからスローされるすべての例外は、ワークフロー インスタンスにとって致命的なものです。</span><span class="sxs-lookup"><span data-stu-id="73e09-128">Any exceptions thrown from this method are fatal to the workflow instance.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#10](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#10)]  
  
### <a name="invoking-asynchronous-methods-on-a-class"></a><span data-ttu-id="73e09-129">クラスでの非同期メソッドの呼び出し</span><span class="sxs-lookup"><span data-stu-id="73e09-129">Invoking Asynchronous Methods on a Class</span></span>  

 <span data-ttu-id="73e09-130">.NET Framework のクラスの多くは非同期機能を提供します。この機能は、ベースのアクティビティを使用して非同期的に呼び出すことができ <xref:System.Activities.AsyncCodeActivity> ます。</span><span class="sxs-lookup"><span data-stu-id="73e09-130">Many of the classes in the .NET Framework provide asynchronous functionality, and this functionality can be asynchronously invoked by using an <xref:System.Activities.AsyncCodeActivity> based activity.</span></span> <span data-ttu-id="73e09-131">次の例では、クラスを使用してファイルを非同期に作成するアクティビティが作成され <xref:System.IO.FileStream> ます。</span><span class="sxs-lookup"><span data-stu-id="73e09-131">In the following example, an activity is created that asynchronously creates a file by using the <xref:System.IO.FileStream> class.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#12](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#12)]  
  
### <a name="sharing-state-between-the-beginexecute-and-endexecute-methods"></a><span data-ttu-id="73e09-132">BeginExecute メソッドと EndExecute メソッドの間での状態の共有</span><span class="sxs-lookup"><span data-stu-id="73e09-132">Sharing State Between the BeginExecute and EndExecute Methods</span></span>  

 <span data-ttu-id="73e09-133">前の例では、<xref:System.IO.FileStream> 内で作成した <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> オブジェクトに <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> 内でアクセスしています。</span><span class="sxs-lookup"><span data-stu-id="73e09-133">In the previous example, the <xref:System.IO.FileStream> object that was created in <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> was accessed in the <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="73e09-134">このことは、`file` 変数を <xref:System.Activities.AsyncCodeActivityContext.UserState%2A?displayProperty=nameWithType> 内で <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> のプロパティに渡すことで可能になっています。</span><span class="sxs-lookup"><span data-stu-id="73e09-134">This is possible because the `file` variable was passed in the <xref:System.Activities.AsyncCodeActivityContext.UserState%2A?displayProperty=nameWithType> property in <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>.</span></span> <span data-ttu-id="73e09-135">これは <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> および <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> の間で状態を共有するための正しい方法です。</span><span class="sxs-lookup"><span data-stu-id="73e09-135">This is the correct method for sharing state between <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A>.</span></span> <span data-ttu-id="73e09-136">派生クラス内 (この場合は `FileWriter`) のメンバー変数を使用して <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> と <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> の間で状態を共有するのは正しい方法ではありません。そのようにすると、アクティビティのオブジェクトが複数のアクティビティ インスタンスから参照される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="73e09-136">It is incorrect to use a member variable in the derived class (`FileWriter` in this case) to share state between <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> and <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> because the activity object may be referenced by multiple activity instances.</span></span> <span data-ttu-id="73e09-137">メンバー変数を使用して状態を共有すると、いずれかの <xref:System.Activities.ActivityInstance> の値が上書きされたり、別の <xref:System.Activities.ActivityInstance> の値が使用されたりする場合があります。</span><span class="sxs-lookup"><span data-stu-id="73e09-137">Attempting to use a member variable to share state can result in values from one <xref:System.Activities.ActivityInstance> overwriting or consuming values from another <xref:System.Activities.ActivityInstance>.</span></span>  
  
### <a name="accessing-argument-values"></a><span data-ttu-id="73e09-138">引数値へのアクセス</span><span class="sxs-lookup"><span data-stu-id="73e09-138">Accessing Argument Values</span></span>  

 <span data-ttu-id="73e09-139"><xref:System.Activities.AsyncCodeActivity> の環境は、アクティビティに定義されている引数から構成されます。</span><span class="sxs-lookup"><span data-stu-id="73e09-139">The environment of an <xref:System.Activities.AsyncCodeActivity> consists of the arguments defined on the activity.</span></span> <span data-ttu-id="73e09-140">これらの引数は、 <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A> / <xref:System.Activities.AsyncCodeActivity.EndExecute%2A> パラメーターを使用してオーバーライドからアクセスでき <xref:System.Activities.AsyncCodeActivityContext> ます。</span><span class="sxs-lookup"><span data-stu-id="73e09-140">These arguments can be accessed from the <xref:System.Activities.AsyncCodeActivity.BeginExecute%2A>/<xref:System.Activities.AsyncCodeActivity.EndExecute%2A> overrides using the <xref:System.Activities.AsyncCodeActivityContext> parameter.</span></span> <span data-ttu-id="73e09-141">デリゲート内で引数にアクセスすることはできませんが、デリゲートのパラメーターを使用すると、引数値や任意の他の必要なデータをデリゲートに渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="73e09-141">The arguments cannot be accessed in the delegate, but the argument values or any other desired data can be passed in to the delegate using its parameters.</span></span> <span data-ttu-id="73e09-142">次の例では、`Max` 引数から包含的上限を取得する乱数生成アクティビティを定義します。</span><span class="sxs-lookup"><span data-stu-id="73e09-142">In the following example, a random number-generating activity is defined that obtains the inclusive upper bound from its `Max` argument.</span></span> <span data-ttu-id="73e09-143">デリゲートを呼び出すと、引数の値は非同期コードに渡されます。</span><span class="sxs-lookup"><span data-stu-id="73e09-143">The value of the argument is passed in to the asynchronous code when the delegate is invoked.</span></span>  
  
 [!code-csharp[CFX_ActivityExample#9](~/samples/snippets/csharp/VS_Snippets_CFX/CFX_ActivityExample/cs/Program.cs#9)]  
  
### <a name="scheduling-actions-or-child-activities-using-asynccodeactivity"></a><span data-ttu-id="73e09-144">AsyncCodeActivity を使用した、アクションまたは子アクティビティのスケジュール設定</span><span class="sxs-lookup"><span data-stu-id="73e09-144">Scheduling Actions or Child Activities Using AsyncCodeActivity</span></span>  

 <span data-ttu-id="73e09-145"><xref:System.Activities.AsyncCodeActivity> 派生カスタム アクティビティはワークフローのスレッドに関する作業を非同期に実行するメソッドを提供しますが、子アクティビティやアクションをスケジュールする機能はありません。</span><span class="sxs-lookup"><span data-stu-id="73e09-145"><xref:System.Activities.AsyncCodeActivity> derived custom activities  provide a method for performing work asynchronously with regard to the workflow thread, but do not provide the ability to schedule child activities or actions.</span></span> <span data-ttu-id="73e09-146">ただし、非同期動作は、コンポジションを介して子アクティビティのスケジュール設定と組み合わせることができます。</span><span class="sxs-lookup"><span data-stu-id="73e09-146">However, asynchronous behavior can be incorporated with scheduling of child activities through composition.</span></span> <span data-ttu-id="73e09-147">非同期アクティビティを作成してから、<xref:System.Activities.Activity> または <xref:System.Activities.NativeActivity> の派生アクティビティと共に構成すると、子アクティビティまたはアクションの非同期動作とスケジュール機能を提供できます。</span><span class="sxs-lookup"><span data-stu-id="73e09-147">An asynchronous activity can be created, and then composed with an <xref:System.Activities.Activity> or <xref:System.Activities.NativeActivity> derived activity to provide asynchronous behavior and scheduling of child activities or actions.</span></span> <span data-ttu-id="73e09-148">たとえば、アクティビティを <xref:System.Activities.Activity> から派生するように作成し、その実装時に <xref:System.Activities.Statements.Sequence> に非同期アクティビティと共にアクティビティのロジックを実装する他のアクティビティを含めることができます。</span><span class="sxs-lookup"><span data-stu-id="73e09-148">For example, an activity could be created that derives from <xref:System.Activities.Activity>, and has as its implementation a <xref:System.Activities.Statements.Sequence> containing the asynchronous activity as well the other activities that implement the logic of the activity.</span></span> <span data-ttu-id="73e09-149">とを使用してアクティビティを構成するその他の例につい <xref:System.Activities.Activity> <xref:System.Activities.NativeActivity> ては、「 [How to: Create a Activity](how-to-create-an-activity.md) and [activity Authoring Options](activity-authoring-options-in-wf.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="73e09-149">For more examples of composing activities using <xref:System.Activities.Activity> and <xref:System.Activities.NativeActivity>, see [How to: Create an Activity](how-to-create-an-activity.md) and [Activity Authoring Options](activity-authoring-options-in-wf.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="73e09-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="73e09-150">See also</span></span>

- <xref:System.Action>
- <xref:System.Func%602>
