---
title: External RuleSet Toolkit
ms.date: 03/30/2017
ms.assetid: a306d283-a031-475e-aa01-9ae86e7adcb0
ms.openlocfilehash: b07d2b63d9f3d98b8f08eb697a8d688d8fac1962
ms.sourcegitcommit: 5fb5b6520b06d7f5e6131ec2ad854da302a28f2e
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/03/2019
ms.locfileid: "74710897"
---
# <a name="external-ruleset-toolkit"></a><span data-ttu-id="3c9b5-102">External RuleSet Toolkit</span><span class="sxs-lookup"><span data-stu-id="3c9b5-102">External Ruleset Toolkit</span></span>

<span data-ttu-id="3c9b5-103">通常、ワークフロー アプリケーション内でルールが使用される場合は、そのルールはアセンブリの一部です。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-103">Normally when rules are used within a workflow application, the rules are part of the assembly.</span></span> <span data-ttu-id="3c9b5-104">場合によっては、ワークフロー アセンブリのリビルドや配置を行わずに RuleSet を更新できるように、RuleSet をアセンブリとは別に管理することもあります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-104">In some scenarios, you may want to maintain the RuleSets separately from the assembly so that they can be updated without rebuilding and deploying the workflow assembly.</span></span> <span data-ttu-id="3c9b5-105">このサンプルでは、RuleSet をデータベース内で管理および編集し、実行時にそれらの RuleSet にワークフローからアクセスできるようにしています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-105">This sample allows you to manage and edit RuleSets in a database and access those RuleSets from a workflow at runtime.</span></span> <span data-ttu-id="3c9b5-106">その結果、実行中のワークフロー インスタンスに、RuleSet への変更を自動的に組み込むことができます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-106">This enables running workflow instances to automatically incorporate RuleSet changes.</span></span>

<span data-ttu-id="3c9b5-107">この External RuleSet Toolkit サンプルには、RuleSet のバージョンをデータベース内で管理および編集するために使用できる Windows フォーム ベースのツールが含まれています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-107">The External RuleSet Toolkit sample contains a Windows Forms-based tool that you can use to manage and edit RuleSet versions in a database.</span></span> <span data-ttu-id="3c9b5-108">また、このようなルールを実行するためのアクティビティとホスト サービスも含まれます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-108">It also includes an activity and a host service for executing those rules.</span></span>

> [!NOTE]
> <span data-ttu-id="3c9b5-109">このサンプルには[Microsoft SQL Server](https://go.microsoft.com/fwlink/?LinkId=96181)が必要です。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-109">This sample requires [Microsoft SQL Server](https://go.microsoft.com/fwlink/?LinkId=96181).</span></span>

<span data-ttu-id="3c9b5-110">Visual Studio には、Windows Workflow Foundation (WF) の一部としてルールセットエディターが用意されています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-110">Visual Studio provides a RuleSet editor as part of the Windows Workflow Foundation (WF).</span></span> <span data-ttu-id="3c9b5-111">このエディタは、ワークフロー内の `Policy` アクティビティをダブルクリックすると起動できます。これにより、定義済みの RuleSet オブジェクトが、ワークフローに関連付けられている .rules ファイルにシリアル化されます (`Policy` アクティビティにより、ワークフローに対して RuleSet インスタンスが実行されます)。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-111">You can start this editor by double-clicking the `Policy` activity in a workflow; it serializes the defined RuleSet object to the .rules file associated with the workflow (a `Policy` activity runs a RuleSet instance against the workflow).</span></span> <span data-ttu-id="3c9b5-112">.rules ファイルは、ワークフロー プロジェクトをビルドするときに、リソースとしてアセンブリにコンパイルされます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-112">The .rules file is compiled into the assembly as a resource when you build the workflow project.</span></span>

<span data-ttu-id="3c9b5-113">このサンプルは、次のコンポーネントで構成されています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-113">The components of this sample include:</span></span>

- <span data-ttu-id="3c9b5-114">RuleSet のバージョンをデータベース内で編集および管理するために使用できる RuleSet グラフィカル ユーザー インターフェイス ツール。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-114">A RuleSet graphical user interface tool that you can use to edit and manage RuleSet versions in the database.</span></span>

- <span data-ttu-id="3c9b5-115">ホスト アプリケーション上で構成され、データベースから RuleSet にアクセスする RuleSet サービス。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-115">A RuleSet service that is configured on the host application and accesses RuleSets from the database.</span></span>

- <span data-ttu-id="3c9b5-116">RuleSet サービスから RuleSet を要求し、その RuleSet をワークフローに対して実行する `ExternalPolicy` アクティビティ。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-116">An `ExternalPolicy` activity that requests a RuleSet from the RuleSet service and runs the RuleSet against the workflow.</span></span>

<span data-ttu-id="3c9b5-117">次の図は、コンポーネントの相互作用を示しています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-117">The interaction of the components is shown in the following image.</span></span> <span data-ttu-id="3c9b5-118">図の後で各コンポーネントについて説明します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-118">The sections that follow describe each component.</span></span>

![外部のルールセットツールキットのサンプルの概要を示す図](./media/external-ruleset-toolkit/ruleset-toolkit-overview.gif)

> [!IMPORTANT]
> <span data-ttu-id="3c9b5-120">サンプルは、既にコンピューターにインストールされている場合があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-120">The samples may already be installed on your machine.</span></span> <span data-ttu-id="3c9b5-121">続行する前に、次の (既定の) ディレクトリを確認してください。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-121">Check for the following (default) directory before continuing.</span></span>
>
> `<InstallDrive>:\WF_WCF_Samples`
>
> <span data-ttu-id="3c9b5-122">このディレクトリが存在しない場合は、 [Windows Communication Foundation (wcf) および Windows Workflow Foundation (WF) のサンプルの .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459)にアクセスして、すべての WINDOWS COMMUNICATION FOUNDATION (wcf) と [!INCLUDE[wf1](../../../../includes/wf1-md.md)] サンプルをダウンロードしてください。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-122">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://www.microsoft.com/download/details.aspx?id=21459) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="3c9b5-123">このサンプルは、次のディレクトリに格納されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-123">This sample is located in the following directory.</span></span>
>
> `<InstallDrive>:\WF_WCF_Samples\WF\Scenario\ExternalRuleSetToolKit`

## <a name="ruleset-tool"></a><span data-ttu-id="3c9b5-124">RuleSet ツール</span><span class="sxs-lookup"><span data-stu-id="3c9b5-124">RuleSet Tool</span></span>

<span data-ttu-id="3c9b5-125">次の図は、ルールセットツールのスクリーンショットです。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-125">The following image is a screenshot of the RuleSet tool.</span></span> <span data-ttu-id="3c9b5-126">**[ルールストア]** メニューから、データベースから使用可能なルールセットを読み込んで、変更されたルールセットをストアに保存し直すことができます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-126">From the **Rule Store** menu, you can load the available RuleSets from the database and save modified RuleSets back to the store.</span></span> <span data-ttu-id="3c9b5-127">RuleSet データベースのデータベース接続文字列は、アプリケーション構成ファイルで指定されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-127">An application configuration file provides a database connection string for the RuleSet database.</span></span> <span data-ttu-id="3c9b5-128">ツールを起動すると、構成済みのデータベースから自動的に RuleSet が読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-128">When you start the tool, it automatically loads the RuleSets from the configured database.</span></span>

![ルールセットブラウザーを示すスクリーンショット。](./media/external-ruleset-toolkit/ruleset-browser-dialog.gif)

<span data-ttu-id="3c9b5-130">RuleSet ツールでは、RuleSet にメジャー バージョン番号とマイナー バージョン番号を割り当てます。これにより、複数のバージョンを同時に管理および保存できます (ツールには、バージョン管理機能以外に、ロックなどの構成管理機能は用意されていません)。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-130">The RuleSet tool applies major and minor version numbers to the RuleSets, allowing you to simultaneously maintain and store multiple versions (the tool provides no locking or other configuration management features in addition to the versioning capability).</span></span> <span data-ttu-id="3c9b5-131">このツールを使用して、新しいバージョンの RuleSet を作成したり、既存のバージョンを削除したりできます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-131">Using the tool, you can create new RuleSet versions or delete existing versions.</span></span> <span data-ttu-id="3c9b5-132">**[新規]** をクリックすると、新しいルールセット名が作成され、バージョン1.0 が適用されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-132">When you click **New**, the tool creates a new RuleSet name and applies version 1.0.</span></span> <span data-ttu-id="3c9b5-133">バージョンをコピーすると、含まれているルールを含め、選択した RuleSet バージョンのコピーが作成されて、新しい一意のバージョン番号が割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-133">When you copy a version, the tool creates a copy of the selected RuleSet version, including the contained rules, and assigns new, unique version numbers.</span></span> <span data-ttu-id="3c9b5-134">これらのバージョン番号は、既存の RuleSet のバージョン番号を基に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-134">These version numbers are based on the version numbers of existing RuleSets.</span></span> <span data-ttu-id="3c9b5-135">RuleSet 名とバージョン番号は、フォーム上の対応するフィールドを使用して変更できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-135">You can change the RuleSet name and version numbers using the associated fields on the form.</span></span>

<span data-ttu-id="3c9b5-136">[ルールの**編集**] をクリックすると、次の図に示すように、ルールセットエディターが開始されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-136">When you click **Edit Rules**, the RuleSet editor starts, as shown in the following image:</span></span>

![ルールセットエディターを示すスクリーンショット。](./media/external-ruleset-toolkit/ruleset-editor-dialog.gif)

<span data-ttu-id="3c9b5-138">これは、Visual Studio アドイン Windows Workflow Foundation の一部であるエディターダイアログの再ホストです。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-138">This is a re-hosting of the editor dialog that is part of the Windows Workflow Foundation Visual Studio add-in.</span></span> <span data-ttu-id="3c9b5-139">そのため、Intellisense サポートを含めて、同等の機能が用意されています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-139">It provides the same functionality, including Intellisense support.</span></span> <span data-ttu-id="3c9b5-140">規則は、ツールのルールセットに関連付けられている対象の型 (ワークフローなど) に対して作成されます。メインツールダイアログの **[参照]** をクリックすると、図4に示すように、 **[ワークフロー/型セレクター]** ダイアログが表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-140">The rules are authored against a target type (such as a workflow) that is associated with the RuleSet in the tool; when you click **Browse** in the main tool dialog, the **Workflow/Type Selector** dialog appears, as shown in Figure 4.</span></span>

<span data-ttu-id="3c9b5-141">![ワークフロー &#47;の種類の選択](./media/71f08d57-e8f2-499e-8151-ece2cbdcabfd.gif "71f08d57-e8f2-499 e-8151-ece2cbdcabfd")</span><span class="sxs-lookup"><span data-stu-id="3c9b5-141">![Workflow &#47;Type Selection](./media/71f08d57-e8f2-499e-8151-ece2cbdcabfd.gif "71f08d57-e8f2-499e-8151-ece2cbdcabfd")</span></span>

<span data-ttu-id="3c9b5-142">図 4: UI-Workflow/Type Selector</span><span class="sxs-lookup"><span data-stu-id="3c9b5-142">Figure 4: Workflow/Type Selector</span></span>

<span data-ttu-id="3c9b5-143">**[ワークフロー/型セレクター]** ダイアログを使用して、アセンブリとそのアセンブリ内の特定の型を指定できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-143">You can use the **Workflow/Type Selector** dialog to specify an assembly and a specific type within that assembly.</span></span> <span data-ttu-id="3c9b5-144">ルールの作成 (および実行) は、この型に対して行います。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-144">This type is the target type against which the rules are authored (and run).</span></span> <span data-ttu-id="3c9b5-145">多くの場合、対象となる型は、ワークフロー型または他の任意のアクティビティ型です。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-145">In many cases, the target type is a workflow or some other activity type.</span></span> <span data-ttu-id="3c9b5-146">ただし、RuleSet は任意の .NET 型に対して実行できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-146">However, you can run a RuleSet against any .NET type.</span></span>

<span data-ttu-id="3c9b5-147">データベースでルールセットが取得されるときに、アセンブリファイルへのパスと種類 `name are stored with the` ルールセットをデータベースから取得すると、ツールは対象の型を自動的に読み込むように試みます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-147">The path to the assembly file and the type `name are stored with the` RuleSet in the database, so that when the RuleSet is retrieved from the database, the tool attempts to automatically load the target type.</span></span>

<span data-ttu-id="3c9b5-148">**[ワークフロー/種類の選択]** ダイアログで **[OK]** をクリックすると、選択した種類がルールセットに対して検証され、対象の型に規則によって参照されるすべてのメンバーが含まれるようになります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-148">When you click **OK** in the **Workflow/Type Selector** dialog, it validates the selected type against the RuleSet, to ensure that the target type has all the members referenced by the rules.</span></span> <span data-ttu-id="3c9b5-149">エラーは、 **[検証エラー]** ダイアログボックスに表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-149">Errors are shown in a **Validation Errors** dialog.</span></span> <span data-ttu-id="3c9b5-150">エラーが発生しても変更を続行するか、 **[キャンセル]** をクリックするかを選択できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-150">You can choose to continue with the change despite the errors, or click **Cancel**.</span></span> <span data-ttu-id="3c9b5-151">メインツールダイアログの **[ツール]** メニューから **[検証]** をクリックして、対象アクティビティに対してルールセットのバージョンを再検証することができます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-151">From the **Tools** menu in the main tool dialog, you can click **Validate** to re-validate the RuleSet version against the target activity.</span></span>

![[検証エラー] ダイアログボックスが表示されているスクリーンショット。](./media/external-ruleset-toolkit/validation-errors-dialog.png)

<span data-ttu-id="3c9b5-153">ツールの **[データ]** メニューから、ルールセットをインポートおよびエクスポートできます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-153">From the **Data** menu in the tool, you can import and export RuleSets.</span></span> <span data-ttu-id="3c9b5-154">**インポート** をクリックすると、ファイルの選択 ダイアログボックスが表示されます。このダイアログで、ルールファイルを選択できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-154">When you click **Import**, a file-chooser dialog appears, from which you can select a .rules file.</span></span> <span data-ttu-id="3c9b5-155">これは、Visual Studio で最初に作成されたファイルである場合もあれば、存在しない場合もあります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-155">This may or may not be a file initially created in Visual Studio.</span></span> <span data-ttu-id="3c9b5-156">.rules ファイルは、条件のコレクションと RuleSet のコレクションを含む、シリアル化された `RuleDefinitions` インスタンスを保持します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-156">The .rules file should contain a serialized `RuleDefinitions` instance that contains a collection of conditions and a collection of RuleSets.</span></span> <span data-ttu-id="3c9b5-157">このツールでは、condition コレクションは使用されませんが、Visual Studio 環境との対話を可能にするために `RuleDefinitions` の形式が使用されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-157">The tool does not use the conditions collection, but it does use the `RuleDefinitions` .rules format to allow interaction with the Visual Studio environment.</span></span>

<span data-ttu-id="3c9b5-158">ルールファイルを選択すると、 **[ルールセットの選択]** ダイアログボックスが表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-158">After selecting a .rules file, a **RuleSet Selector** dialog appears.</span></span> <span data-ttu-id="3c9b5-159">このダイアログ ボックスを使用して、インポートするファイルから RuleSet を選択できます (既定では、すべての RuleSet が指定されます)。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-159">You can use the dialog to select the RuleSets from the file that you want to import (the default specifies all RuleSets).</span></span> <span data-ttu-id="3c9b5-160">WF プロジェクト内の RuleSet のバージョンはアセンブリのバージョンと同じであるため、.rules ファイル内の RuleSet にはバージョン番号がありません。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-160">RuleSets in the .rules file do not have version numbers, because their versioning within a WF project is the same as the version of the assembly.</span></span> <span data-ttu-id="3c9b5-161">インポート処理中に、ツールによって、次に使用可能なメジャーバージョン番号が自動的に割り当てられます (インポート後に変更できます)。割り当てられたバージョン番号は、 **[ルールセットの選択]** ボックスの一覧に表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-161">During the importing process, the tool automatically assigns the next available major version number (which you can change after importing); you can see the assigned version numbers in the **RuleSet Selector** list.</span></span>

<span data-ttu-id="3c9b5-162">ツールでは、インポートする RuleSet ごとに、RuleSet で使用されるメンバに基づいて、.rules ファイルの場所の下に bin\Debug フォルダー (存在する場合) から関連付けられている型が検索されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-162">For each RuleSet it imports, the tool attempts to locate the associated type from the bin\Debug folder under the location of the .rules file (if it exists), based on the members used in the RuleSet.</span></span> <span data-ttu-id="3c9b5-163">一致する型が複数見つかった場合は、.rules ファイル名と型名の対応関係に基づいて型が選択されます (たとえば、`Workflow1` 型は Workflow1.rules に対応します)。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-163">If the tool finds multiple matching types, it attempts to choose a type based on a match between the .rules file name and the type name (for example, the `Workflow1` type corresponds to Workflow1.rules).</span></span> <span data-ttu-id="3c9b5-164">対応関係が複数存在する場合は、型を選択するように求められます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-164">If multiple matches exist, you are prompted to select the type.</span></span> <span data-ttu-id="3c9b5-165">この自動識別機構が一致するアセンブリまたは型を見つけることができない場合は、メインツールダイアログの **[参照]** をクリックして、関連付けられている型に移動します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-165">If this auto-identification mechanism fails to locate a matching assembly or type, then after importing you can click **Browse** on the main tool dialog to navigate to the associated type.</span></span> <span data-ttu-id="3c9b5-166">次の図は、ルールセットセレクターを示しています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-166">The following image shows the RuleSet Selector:</span></span>

![[ルールセットの選択] ダイアログボックスが表示されているスクリーンショット。](./media/external-ruleset-toolkit/ruleset-selector-dialog.gif)

<span data-ttu-id="3c9b5-168">メインツールメニューの **[データエクスポート]** をクリックすると、 **[ルールセットの選択]** ダイアログボックスが再び表示され、エクスポートするデータベースのルールセットを確認できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-168">When you click **Data-Export** from the main tool menu, the **RuleSet Selector** dialog appears again, from which you can determine the RuleSets from the database that should be exported.</span></span> <span data-ttu-id="3c9b5-169">**[OK]** をクリックすると、 **[ファイルの保存]** ダイアログボックスが表示され、結果として生成されるルールファイルの名前と場所を指定できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-169">When you click **OK**, a **Save File** dialog appears, in which you can specify the name and location of the resulting .rules file.</span></span> <span data-ttu-id="3c9b5-170">.rules ファイルではバージョン情報が保持されないため、特定の RuleSet 名を持つ RuleSet バージョンを 1 つだけ選択することができます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-170">Because the .rules file does not contain version information, you can only select one RuleSet version with a given RuleSet name.</span></span>

## <a name="policyfromservice-activity"></a><span data-ttu-id="3c9b5-171">PolicyFromService アクティビティ</span><span class="sxs-lookup"><span data-stu-id="3c9b5-171">PolicyFromService Activity</span></span>

<span data-ttu-id="3c9b5-172">`PolicyFromService` アクティビティのコードは単純です。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-172">The code for the `PolicyFromService` activity is straightforward.</span></span> <span data-ttu-id="3c9b5-173">このコードの動作は、WF で提供される `Policy` アクティビティによく似ていますが、.rules ファイルから対象の RuleSet を取得するのではなく、ホスト サービスを呼び出して RuleSet のインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-173">It works much like the `Policy` activity provided with WF, but instead of retrieving the target RuleSet from the .rules file, it calls a host service to obtain the RuleSet instance.</span></span> <span data-ttu-id="3c9b5-174">その後、ルートのワークフロー アクティビティ インスタンスに対して RuleSet を実行します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-174">It then runs the RuleSet against the root workflow activity instance.</span></span>

<span data-ttu-id="3c9b5-175">ワークフロー内でこのアクティビティを使用するには、ワークフロー プロジェクトから `PolicyActivities` アセンブリおよび `RuleSetService` アセンブリへの参照を追加します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-175">To use the activity in a workflow, add a reference to the `PolicyActivities` and `RuleSetService` assemblies from your workflow project.</span></span> <span data-ttu-id="3c9b5-176">ツールボックスにアクティビティを追加する方法については、このトピックの最後にある手順を参照してください。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-176">See the procedure at the end of this topic for a discussion of how to add the activity to the toolbox.</span></span>

<span data-ttu-id="3c9b5-177">ワークフロー内にアクティビティを配置したら、実行する RuleSet の名前を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-177">After placing the activity in your workflow, you must provide the name of the RuleSet to be run.</span></span> <span data-ttu-id="3c9b5-178">この名前は、リテラル値として入力することも、他のアクティビティのワークフロー変数やプロパティにバインドすることもできます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-178">You can enter the name as a literal value, or bind to a workflow variable or property of another activity.</span></span> <span data-ttu-id="3c9b5-179">必要に応じて、実行する特定の RuleSet のバージョン番号を入力できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-179">Optionally, you can enter version numbers for the specific RuleSet that should be run.</span></span> <span data-ttu-id="3c9b5-180">メジャー バージョン番号とマイナー バージョン番号を既定値の 0 のままにしておくと、データベース内の最新のバージョン番号が自動的にアクティビティに指定されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-180">If you leave the default value of 0 for the major and minor version numbers, the latest version number in the database is automatically provided for the activity.</span></span>

## <a name="ruleset-service"></a><span data-ttu-id="3c9b5-181">ルールセット サービス</span><span class="sxs-lookup"><span data-stu-id="3c9b5-181">RuleSet Service</span></span>

<span data-ttu-id="3c9b5-182">このサービスには、指定された RuleSet のバージョンをデータベースから取得し、呼び出し元のアクティビティに返す役割があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-182">The service is responsible for retrieving the specified RuleSet version from the database and returning it to the calling activity.</span></span> <span data-ttu-id="3c9b5-183">既に説明したように、`GetRuleSet` の呼び出しで渡されるメジャー バージョンとマイナー バージョンの値がどちらも 0 の場合は、最新のバージョンが取得されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-183">As previously discussed, if the major and minor version values passed in the `GetRuleSet` call are both 0, the service retrieves the latest version.</span></span> <span data-ttu-id="3c9b5-184">現時点では、RuleSet の定義と RuleSet インスタンスはキャッシュされず、RuleSet のバージョンに "配置済み" というマークを付けて実行中の RuleSet と区別する機能もありません。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-184">At this point, there is no caching of RuleSet definitions or instances; similarly, there are no features for marking RuleSet versions as "deployed" to differentiate them from in-progress RuleSets.</span></span>

<span data-ttu-id="3c9b5-185">サービスからアクセスされるデータベースは、アプリケーション構成ファイルを使用してホストで構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-185">The database to be accessed by the service should be configured on the host using an application configuration file.</span></span>

#### <a name="to-run-the-tool"></a><span data-ttu-id="3c9b5-186">ツールを実行するには</span><span class="sxs-lookup"><span data-stu-id="3c9b5-186">To run the tool</span></span>

1. <span data-ttu-id="3c9b5-187">ツールとサービスで使用される RuleSet テーブルを設定するフォルダには Setup.sql ファイルがあります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-187">The folder that sets up the RuleSet table used by the tool and the service contains a Setup.sql file.</span></span> <span data-ttu-id="3c9b5-188">Setup.cmd バッチ ファイルを実行して SQL Express 上に Rules データベースを作成して RuleSet テーブルを設定します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-188">You can run the Setup.cmd batch file to create the Rules database on SQL Express and to set up the RuleSet table.</span></span>

2. <span data-ttu-id="3c9b5-189">このバッチ ファイルまたは Setup.sql を編集して、SQL Express を使用しないように指定した場合、または `Rules` 以外の名前のデータベースにテーブルを配置するように指定した場合は、RuleSet ツールのアプリケーション構成ファイルと `UsageSample` プロジェクトを同じ情報で編集する必要があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-189">If you edit the batch file or Setup.sql and specify not to use SQL Express or to place the table in a database named something other than `Rules`, the application configuration files in the RuleSet tool and `UsageSample` projects should be edited with the same information.</span></span>

3. <span data-ttu-id="3c9b5-190">Setup.sql スクリプトを実行したら、`ExternalRuleSetToolkit` ソリューションをビルドし、その後 ExternalRuleSetTool プロジェクトから RuleSet ツールを起動できます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-190">After you run the Setup.sql script, you can build the `ExternalRuleSetToolkit` solution and then launch the RuleSet tool from the ExternalRuleSetTool project.</span></span>

4. <span data-ttu-id="3c9b5-191">`RuleSetToolkitUsageSample` のシーケンシャル ワークフロー コンソール アプリケーション ソリューションにはサンプル ワークフローが含まれています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-191">The `RuleSetToolkitUsageSample` Sequential Workflow Console Application solution includes a sample workflow.</span></span> <span data-ttu-id="3c9b5-192">このワークフローは、`PolicyFromService` アクティビティ、および `orderValue` と `discount` の 2 つの変数で構成されており、対象の RuleSet はこれらに対して実行されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-192">The workflow consists of a `PolicyFromService` activity and two variables, `orderValue` and `discount`, against which the target RuleSet runs.</span></span>

5. <span data-ttu-id="3c9b5-193">サンプルを使用するには `RuleSetToolkitUsageSample` ソリューションをビルドします。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-193">To use the sample, build the `RuleSetToolkitUsageSample` solution.</span></span> <span data-ttu-id="3c9b5-194">次に、ルールセットツールのメインメニューから、 **[データのインポート]** をクリックし、RuleSetToolkitUsageSample フォルダー内の discountruleset.rules ファイルをポイントします。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-194">Then from the RuleSet tool main menu, click **Data-Import** and point to the DiscountRuleSet.rules file in the RuleSetToolkitUsageSample folder.</span></span> <span data-ttu-id="3c9b5-195">**[ルールストア-保存]** メニューオプションをクリックして、インポートしたルールセットをデータベースに保存します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-195">Click the **Rule Store-Save** menu option to save the imported RuleSet to the database.</span></span>

6. <span data-ttu-id="3c9b5-196">`PolicyActivities` アセンブリがサンプル ワークフロー プロジェクトから参照されているため、`PolicyFromService` アクティビティがワークフロー内に表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-196">Because the `PolicyActivities` assembly is referenced from the sample workflow project, the `PolicyFromService` activity appears in the workflow.</span></span> <span data-ttu-id="3c9b5-197">ただし、既定ではツールボックスに表示されません。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-197">It does not, however, appear in the toolbox by default.</span></span> <span data-ttu-id="3c9b5-198">ツールボックスに追加するには、次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-198">To add it to the toolbox, do the following:</span></span>

    - <span data-ttu-id="3c9b5-199">ツールボックス を右クリックし、**項目の選択** を選択します (これには時間がかかる場合があります)。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-199">Right-click the toolbox and select **Choose Items** (this may take a while).</span></span>

    - <span data-ttu-id="3c9b5-200">**[ツールボックスアイテムの選択]** ダイアログボックスが表示されたら、 **[活動]** タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-200">When the **Choose Toolbox Items** dialog appears, click the **Activities** tab.</span></span>

    - <span data-ttu-id="3c9b5-201">`ExternalRuleSetToolkit` ソリューションで `PolicyActivities` アセンブリを参照し、 **[開く]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-201">Browse to the `PolicyActivities` assembly in the `ExternalRuleSetToolkit` solution and click **Open**.</span></span>

    - <span data-ttu-id="3c9b5-202">**[ツールボックスアイテムの選択]** ダイアログで `PolicyFromService` アクティビティが選択されていることを確認し、 **[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-202">Ensure that the `PolicyFromService` activity is selected in the **Choose Toolbox Items** dialog and then click **OK**.</span></span>

    - <span data-ttu-id="3c9b5-203">これで、 **[RuleSetToolkitUsageSample Components]** カテゴリの [ツールボックス] にアクティビティが表示されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-203">The activity should now appear in the toolbox in the **RuleSetToolkitUsageSample Components** category.</span></span>

7. <span data-ttu-id="3c9b5-204">RuleSet サービスは、Program.cs 内の次のステートメントを使用して既にコンソール アプリケーション ホストで構成されています。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-204">The RuleSet service is already configured on the console application host using the following statement in Program.cs.</span></span>

    ```csharp
    workflowRuntime.AddService(new RuleSetService());
    ```

8. <span data-ttu-id="3c9b5-205">構成ファイルを使用して、ホストでこのサービスを構成することもできます。詳細については、SDK のドキュメントを参照してください。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-205">You can also configure the service on the host using a configuration file; see the SDK documentation for details.</span></span>

9. <span data-ttu-id="3c9b5-206">アプリケーション構成ファイルがワークフロー プロジェクトに追加され、サービスが使用するデータベース接続文字列が指定されます。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-206">An application configuration file is added to the workflow project to specify the connection string for the database to be used by the service.</span></span> <span data-ttu-id="3c9b5-207">この接続文字列は、RuleSet テーブルを含むデータベースを指す、RuleSet ツールが使用する接続文字列と同一である必要があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-207">This should be the same connection string used by the RuleSet tool, which points to the database that contains the RuleSet table.</span></span>

10. <span data-ttu-id="3c9b5-208">これで、`RuleSetToolkitUsageSample` プロジェクトを他のワークフロー コンソール アプリケーションと同様に実行できるようになります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-208">You can now run the `RuleSetToolkitUsageSample` project as you would any other workflow console application.</span></span> <span data-ttu-id="3c9b5-209">Visual Studio 内で F5 キーまたは Ctrl + F5 キーを押すか、RuleSetToolkitUsageSample ファイルを直接実行します。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-209">Press F5 or Ctrl+F5 within Visual Studio or run the RuleSetToolkitUsageSample.exe file directly.</span></span>

    > [!NOTE]
    > <span data-ttu-id="3c9b5-210">RuleSet ツールは使用方法サンプルのアセンブリを読み込んでいるため、使用方法サンプルを再コンパイルするには RuleSet ツールを閉じる必要があります。</span><span class="sxs-lookup"><span data-stu-id="3c9b5-210">You must close the RuleSet tool to recompile the usage sample, because the tool loads the usage sample assembly.</span></span>
