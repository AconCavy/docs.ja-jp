---
title: 高可用性障害復旧のための SqlClient サポート
ms.date: 03/30/2017
ms.assetid: 61e0b396-09d7-4e13-9711-7dcbcbd103a0
ms.openlocfilehash: b51c3cb1eb3c8726b7de007a1c1519eae0733392
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/07/2019
ms.locfileid: "70791615"
---
# <a name="sqlclient-support-for-high-availability-disaster-recovery"></a><span data-ttu-id="09611-102">高可用性障害復旧のための SqlClient サポート</span><span class="sxs-lookup"><span data-stu-id="09611-102">SqlClient Support for High Availability, Disaster Recovery</span></span>
<span data-ttu-id="09611-103">このトピックでは、高可用性、ディザスター リカバリーのための SqlClient サポート (.NET Framework 4.5 で追加) である AlwaysOn 可用性グループについて説明します。</span><span class="sxs-lookup"><span data-stu-id="09611-103">This topic discusses SqlClient support (added in .NET Framework 4.5) for high-availability, disaster recovery -- AlwaysOn Availability Groups.</span></span>  <span data-ttu-id="09611-104">AlwaysOn 可用性グループの機能は SQL Server 2012 に追加されています。</span><span class="sxs-lookup"><span data-stu-id="09611-104">AlwaysOn Availability Groups feature was added to SQL Server 2012.</span></span> <span data-ttu-id="09611-105">AlwaysOn 可用性グループの詳細については、SQL Server オンライン ブックを参照してください。</span><span class="sxs-lookup"><span data-stu-id="09611-105">For more information about AlwaysOn Availability Groups, see SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="09611-106">現在は、接続プロパティで、(高可用性、障害回復) 可用性グループ (AG) の高可用性グループ リスナーまたは SQL Server 2012 フェールオーバー クラスター インスタンスを指定できます。</span><span class="sxs-lookup"><span data-stu-id="09611-106">You can now specify the availability group listener of a (high-availability, disaster-recovery) availability group (AG) or SQL Server 2012 Failover Cluster Instance in the connection property.</span></span> <span data-ttu-id="09611-107">フェールオーバーが発生した AlwaysOn データベースに SqlClient アプリケーションが接続される場合、元の接続が途切れるため、アプリケーションがフェールオーバーの後に処理を続行するには、新しい接続を開く必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-107">If a SqlClient application is connected to an AlwaysOn database that fails over, the original connection is broken and the application must open a new connection to continue work after the failover.</span></span>  
  
 <span data-ttu-id="09611-108">可用性グループ リスナーまたは SQL Server 2012 フェールオーバー クラスター インスタンスに接続していない場合、複数の IP アドレスがホスト名に関連付けられていると、SqlClient は、DNS エントリに関連付けられたすべての IP アドレスを順に反復処理します。</span><span class="sxs-lookup"><span data-stu-id="09611-108">If you are not connecting to an availability group listener or SQL Server 2012 Failover Cluster Instance, and if multiple IP addresses are associated with a hostname, SqlClient will iterate sequentially through all IP addresses associated with DNS entry.</span></span> <span data-ttu-id="09611-109">これは、DNS サーバーによって返された最初の IP アドレスがネットワーク インターフェイス カード (NIC) にバインドされていない場合、時間がかかります。</span><span class="sxs-lookup"><span data-stu-id="09611-109">This can be time consuming if the first IP address returned by DNS server is not bound to any network interface card (NIC).</span></span> <span data-ttu-id="09611-110">可用性グループ リスナーまたは SQL Server 2012 フェールオーバー クラスター インスタンスに接続する場合、SqlClient ですべての IP アドレスへの接続確立を並列実行しようとして、接続試行が成功すると、ドライバーは保留状態の接続試行を破棄します。</span><span class="sxs-lookup"><span data-stu-id="09611-110">When connecting to an availability group listener or SQL Server 2012 Failover Cluster Instance, SqlClient attempts to establish connections to all IP addresses in parallel and if a connection attempt succeeds, the driver will discard any pending connection attempts.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="09611-111">接続タイムアウトの増加および接続の再試行ロジックの実装により、アプリケーションが可用性グループに接続する可能性は向上します。</span><span class="sxs-lookup"><span data-stu-id="09611-111">Increasing connection timeout and implementing connection retry logic will increase the probability that an application will connect to an availability group.</span></span> <span data-ttu-id="09611-112">また、接続がフェールオーバーによって失敗する可能性があるので、接続の再試行ロジックの実装は、失敗した接続が再接続するまで試行されるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-112">Also, because a connection can fail because of a failover, you should implement connection retry logic, retrying a failed connection until it reconnects.</span></span>  
  
 <span data-ttu-id="09611-113">次の接続プロパティが、.NET Framework 4.5 の SqlClient に追加されました。</span><span class="sxs-lookup"><span data-stu-id="09611-113">The following connection properties were added to SqlClient in .NET Framework 4.5:</span></span>  
  
- `ApplicationIntent`  
  
- `MultiSubnetFailover`  
  
 <span data-ttu-id="09611-114">プログラムによって、これらの接続文字列キーワードを次のとおりに変更できます。</span><span class="sxs-lookup"><span data-stu-id="09611-114">You can programmatically modify these connection string keywords with:</span></span>  
  
1. <xref:System.Data.SqlClient.SqlConnectionStringBuilder.ApplicationIntent%2A>  
  
2. <xref:System.Data.SqlClient.SqlConnectionStringBuilder.MultiSubnetFailover%2A>  

> [!NOTE]
> <span data-ttu-id="09611-115">.NET Framework 4.6.1 以降のバージョンでは、`MultiSubnetFailover` を `true` に設定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="09611-115">Setting `MultiSubnetFailover` to `true` isn't required with .NET Framework 4.6.1 or later versions.</span></span>
  
## <a name="connecting-with-multisubnetfailover"></a><span data-ttu-id="09611-116">MultiSubnetFailover を使用した接続</span><span class="sxs-lookup"><span data-stu-id="09611-116">Connecting With MultiSubnetFailover</span></span>  
 <span data-ttu-id="09611-117">SQL Server 2012 可用性グループ リスナーまたは SQL Server 2012 フェールオーバー クラスター インスタンスに接続する際には、必ず `MultiSubnetFailover=True` を指定してください。</span><span class="sxs-lookup"><span data-stu-id="09611-117">Always specify `MultiSubnetFailover=True` when connecting to a SQL Server 2012 availability group listener or SQL Server 2012 Failover Cluster Instance.</span></span> <span data-ttu-id="09611-118">`MultiSubnetFailover` を指定することで、SQL Server 2012 のすべての可用性グループとフェールオーバー クラスター インスタンスに対して高速フェールオーバーが有効化され、単一サブネットおよびマルチサブネットの AlwaysOn トポロジにおけるフェールオーバー時間が大幅に短縮されます。</span><span class="sxs-lookup"><span data-stu-id="09611-118">`MultiSubnetFailover` enables faster failover for all Availability Groups and or Failover Cluster Instance in SQL Server 2012 and will significantly reduce failover time for single and multi-subnet AlwaysOn topologies.</span></span> <span data-ttu-id="09611-119">複数のサブネットのフェールオーバーでは、クライアントは並列接続を試みます。</span><span class="sxs-lookup"><span data-stu-id="09611-119">During a multi-subnet failover, the client will attempt connections in parallel.</span></span> <span data-ttu-id="09611-120">サブネットのフェールオーバー中に、積極的に TCP 接続を再試行します。</span><span class="sxs-lookup"><span data-stu-id="09611-120">During a subnet failover, will aggressively retry the TCP connection.</span></span>  
  
 <span data-ttu-id="09611-121">`MultiSubnetFailover` 接続プロパティは、アプリケーションが可用性グループまたは SQL Server 2012 フェールオーバー クラスター インスタンスで展開されていること、およびすべての IP アドレスへの接続を試行することで SqlClient がプライマリ SQL Server インスタンスのデータベースに接続を試行することを示します。</span><span class="sxs-lookup"><span data-stu-id="09611-121">The `MultiSubnetFailover` connection property indicates that the application is being deployed in an availability group or SQL Server 2012 Failover Cluster Instance and that SqlClient will try to connect to the database on the primary SQL Server instance by trying to connect to all the IP addresses.</span></span> <span data-ttu-id="09611-122">`MultiSubnetFailover=True` を接続に指定すると、クライアントは、オペレーティング システムの既定の TCP 再転送間隔よりも高速に接続試行を再試行します。</span><span class="sxs-lookup"><span data-stu-id="09611-122">When `MultiSubnetFailover=True` is specified for a connection, the client retries TCP connection attempts faster than the operating system’s default TCP retransmit intervals.</span></span> <span data-ttu-id="09611-123">これは、AlwaysOn 可用性グループまたは AlwaysOn フェールオーバー クラスター インスタンスのフェールオーバー後のより高速な再接続を可能にし、単一および複数のサブネットの可用性グループおよびフェールオーバー クラスター インスタンスの両方に適用可能です。</span><span class="sxs-lookup"><span data-stu-id="09611-123">This enables faster reconnection after failover of either an AlwaysOn Availability Group or an AlwaysOn Failover Cluster Instance, and is applicable to both single- and multi-subnet Availability Groups and Failover Cluster Instances.</span></span>  
  
 <span data-ttu-id="09611-124">SqlClient の接続文字列キーワードの詳細については、<xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A> を参照してください。</span><span class="sxs-lookup"><span data-stu-id="09611-124">For more information about connection string keywords in SqlClient, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
 <span data-ttu-id="09611-125">可用性グループ リスナーまたは SQL Server 2012 フェールオーバー クラスター インスタンス以外の何かに接続する場合に `MultiSubnetFailover=True` を指定すると、パフォーマンスに負の影響が及ぶ可能性があるため、サポートされていません。</span><span class="sxs-lookup"><span data-stu-id="09611-125">Specifying `MultiSubnetFailover=True` when connecting to something other than a availability group listener or SQL Server 2012 Failover Cluster Instance may result in a negative performance impact, and is not supported.</span></span>  
  
 <span data-ttu-id="09611-126">可用性グループまたは SQL Server 2012 フェールオーバー クラスター インスタンス内のサーバーに接続する際には、次のガイドラインに従います。</span><span class="sxs-lookup"><span data-stu-id="09611-126">Use the following guidelines to connect to a server in an availability group or SQL Server 2012 Failover Cluster Instance:</span></span>  
  
- <span data-ttu-id="09611-127">単一のサブネットまたは複数のサブネットへの接続時には、`MultiSubnetFailover` 接続プロパティを使用します。これにより、両方の場合でパフォーマンスが向上します。</span><span class="sxs-lookup"><span data-stu-id="09611-127">Use the `MultiSubnetFailover` connection property when connecting to a single subnet or multi-subnet; it will improve performance for both.</span></span>  
  
- <span data-ttu-id="09611-128">可用性グループに接続するには、使用する接続文字列でサーバーとして可用性グループの可用性グループ リスナーを指定します。</span><span class="sxs-lookup"><span data-stu-id="09611-128">To connect to an availability group, specify the availability group listener of the availability group as the server in your connection string.</span></span>  
  
- <span data-ttu-id="09611-129">64 個を超える数の IP アドレスが構成された SQL Server インスタンスに接続すると、接続エラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="09611-129">Connecting to a SQL Server instance configured with more than 64 IP addresses will cause a connection failure.</span></span>  
  
- <span data-ttu-id="09611-130">`MultiSubnetFailover` 接続プロパティを使用するアプリケーションの動作は、認証の種類 (SQL Server 認証、Kerberos 認証、または Windows 認証) によって影響を受けません。</span><span class="sxs-lookup"><span data-stu-id="09611-130">Behavior of an application that uses the `MultiSubnetFailover` connection property is not affected based on the type of authentication: SQL Server Authentication, Kerberos Authentication, or Windows Authentication.</span></span>  
  
- <span data-ttu-id="09611-131">フェールオーバー時に対応し、アプリケーションの接続の再試行を減らすには、`Connect Timeout` の値を増やします。</span><span class="sxs-lookup"><span data-stu-id="09611-131">Increase the value of `Connect Timeout` to accommodate for failover time and reduce application connection retry attempts.</span></span>  
  
- <span data-ttu-id="09611-132">分散トランザクションはサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="09611-132">Distributed transactions are not supported.</span></span>  
  
 <span data-ttu-id="09611-133">読み取り専用のルーティングが有効でない場合は、セカンダリ レプリカの場所への接続は、次の場合に失敗します。</span><span class="sxs-lookup"><span data-stu-id="09611-133">If read-only routing is not in effect, connecting to a secondary replica location will fail in the following situations:</span></span>  
  
1. <span data-ttu-id="09611-134">セカンダリ レプリカの場所が接続を受け入れないように構成されている場合。</span><span class="sxs-lookup"><span data-stu-id="09611-134">If the secondary replica location is not configured to accept connections.</span></span>  
  
2. <span data-ttu-id="09611-135">アプリケーションが `ApplicationIntent=ReadWrite` (後で説明) を使用している場合、セカンダリ レプリカの場所は読み取り専用アクセスとして構成されます。</span><span class="sxs-lookup"><span data-stu-id="09611-135">If an application uses `ApplicationIntent=ReadWrite` (discussed below) and the secondary replica location is configured for read-only access.</span></span>  
  
 <span data-ttu-id="09611-136"><xref:System.Data.SqlClient.SqlDependency> は、読み取り専用セカンダリ レプリカではサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="09611-136"><xref:System.Data.SqlClient.SqlDependency> is not supported on read-only secondary replicas.</span></span>  
  
 <span data-ttu-id="09611-137">プライマリ レプリカが読み取り専用のワークロードを拒否するように設定され、接続文字列が  `ApplicationIntent=ReadOnly` を含んでいる場合、接続は失敗します。</span><span class="sxs-lookup"><span data-stu-id="09611-137">A connection will fail if a primary replica is configured to reject read-only workloads and the connection string contains `ApplicationIntent=ReadOnly`.</span></span>  
  
## <a name="upgrading-to-use-multi-subnet-clusters-from-database-mirroring"></a><span data-ttu-id="09611-138">データベース ミラーリングから複数のサブネット クラスターを使用するためのアップグレード</span><span class="sxs-lookup"><span data-stu-id="09611-138">Upgrading to Use Multi-Subnet Clusters from Database Mirroring</span></span>  
 <span data-ttu-id="09611-139">接続エラー (<xref:System.ArgumentException>) は、`MultiSubnetFailover` および `Failover Partner` 接続のキーワードが接続文字列内に存在する場合や、`MultiSubnetFailover=True` および TCP 以外のプロトコルが使用された場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="09611-139">A connection error (<xref:System.ArgumentException>) will occur if the `MultiSubnetFailover` and `Failover Partner` connection keywords are present in the connection string, or if `MultiSubnetFailover=True` and a protocol other than TCP is used.</span></span> <span data-ttu-id="09611-140">また、`MultiSubnetFailover` が使用されているとき、SQL Server から、データベース ミラーリング ペアに属していることを示すフェールオーバー パートナー応答が返された場合にも、エラー (<xref:System.Data.SqlClient.SqlException>) が発生します。</span><span class="sxs-lookup"><span data-stu-id="09611-140">An error (<xref:System.Data.SqlClient.SqlException>) will also occur if `MultiSubnetFailover` is used and the SQL Server returns a failover partner response indicating it is part of a database mirroring pair.</span></span>  
  
 <span data-ttu-id="09611-141">現在データベース ミラーリングを使用している SqlClient アプリケーションを複数のサブネットのシナリオへとアップグレードする場合、`Failover Partner` 接続プロパティを削除し、`MultiSubnetFailover` に設定した `True` で置き換え、接続文字列のサーバー名を可用性グループ リスナーと置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-141">If you upgrade a SqlClient application that currently uses database mirroring to a multi-subnet scenario, you should remove the `Failover Partner` connection property and replace it with `MultiSubnetFailover` set to `True` and replace the server name in the connection string with an availability group listener.</span></span> <span data-ttu-id="09611-142">接続文字列が `Failover Partner` および `MultiSubnetFailover=True` を使用していると、ドライバーがエラーを生成します。</span><span class="sxs-lookup"><span data-stu-id="09611-142">If a connection string uses `Failover Partner` and `MultiSubnetFailover=True`, the driver will generate an error.</span></span> <span data-ttu-id="09611-143">ただし、接続文字列が `Failover Partner` および `MultiSubnetFailover=False` (または  `ApplicationIntent=ReadWrite`) を使用している場合、アプリケーションはデータベース ミラーリングを使用します。</span><span class="sxs-lookup"><span data-stu-id="09611-143">However, if a connection string uses `Failover Partner` and `MultiSubnetFailover=False` (or `ApplicationIntent=ReadWrite`), the application will use database mirroring.</span></span>  
  
 <span data-ttu-id="09611-144">データベース ミラーリングが AG のプライマリ データベースで使用される場合、および  `MultiSubnetFailover=True` が可用性グループ リスナーではなくプライマリ データベースに接続する接続文字列で使用される場合、ドライバーはエラーを返します。</span><span class="sxs-lookup"><span data-stu-id="09611-144">The driver will return an error if database mirroring is used on the primary database in the AG, and if `MultiSubnetFailover=True` is used in the connection string that connects to a primary database instead of to an availability group listener.</span></span>  
  
## <a name="specifying-application-intent"></a><span data-ttu-id="09611-145">アプリケーションの目的の指定</span><span class="sxs-lookup"><span data-stu-id="09611-145">Specifying Application Intent</span></span>  
 <span data-ttu-id="09611-146">`ApplicationIntent=ReadOnly` の場合、クライアントは AlwaysOn が有効になったデータベースに接続する場合に、読み取られたワークロードを要求します。</span><span class="sxs-lookup"><span data-stu-id="09611-146">When `ApplicationIntent=ReadOnly`, the client requests a read workload when connecting to an AlwaysOn enabled database.</span></span> <span data-ttu-id="09611-147">サーバーは、接続時および USE データベース ステートメントの間、その目的を強制しますが、AlwaysOn が有効になったデータベースに対してのみ、これを行います。</span><span class="sxs-lookup"><span data-stu-id="09611-147">The server will enforce the intent at connection time and during a USE database statement but only to an Always On enabled database.</span></span>  
  
 <span data-ttu-id="09611-148">`ApplicationIntent` キーワードは従来の読み取り専用のデータベースでは機能しません。</span><span class="sxs-lookup"><span data-stu-id="09611-148">The `ApplicationIntent` keyword does not work with legacy, read-only databases.</span></span>  
  
 <span data-ttu-id="09611-149">データベースは、対象となる AlwaysOn データベースのワークロードの読み取りを許可または拒否できます。</span><span class="sxs-lookup"><span data-stu-id="09611-149">A database can allow or disallow read workloads on the targeted AlwaysOn database.</span></span> <span data-ttu-id="09611-150">(これは、`PRIMARY_ROLE` および `SECONDARY_ROLE` Transact-SQL ステートメントの `ALLOW_CONNECTIONS` 句を使用して実行されます。)</span><span class="sxs-lookup"><span data-stu-id="09611-150">(This is done with the `ALLOW_CONNECTIONS` clause of the `PRIMARY_ROLE` and `SECONDARY_ROLE`Transact-SQL statements.)</span></span>  
  
 <span data-ttu-id="09611-151">`ApplicationIntent` キーワードは、読み取り専用のルーティングを有効にするために使用されます。</span><span class="sxs-lookup"><span data-stu-id="09611-151">The `ApplicationIntent` keyword is used to enable read-only routing.</span></span>  
  
## <a name="read-only-routing"></a><span data-ttu-id="09611-152">読み取り専用ルーティング</span><span class="sxs-lookup"><span data-stu-id="09611-152">Read-Only Routing</span></span>  
 <span data-ttu-id="09611-153">読み取り専用のルーティングはデータベースの読み取り専用のレプリカの可用性を確保できる機能です。</span><span class="sxs-lookup"><span data-stu-id="09611-153">Read-only routing is a feature that can ensure the availability of a read only replica of a database.</span></span> <span data-ttu-id="09611-154">読み取り専用のルーティングを有効にするには次のことが必要です。</span><span class="sxs-lookup"><span data-stu-id="09611-154">To enable read-only routing:</span></span>  
  
1. <span data-ttu-id="09611-155">AlwaysOn 可用性グループの可用性グループ リスナーに接続する必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-155">You must connect to an Always On Availability Group availability group listener.</span></span>  
  
2. <span data-ttu-id="09611-156">`ApplicationIntent` 接続文字列キーワードを `ReadOnly` に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-156">The `ApplicationIntent` connection string keyword must be set to `ReadOnly`.</span></span>  
  
3. <span data-ttu-id="09611-157">可用性グループは、データベース管理者によって、読み取り専用のルーティングを有効にするように構成される必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-157">The Availability Group must be configured by the database administrator to enable read-only routing.</span></span>  
  
 <span data-ttu-id="09611-158">読み取り専用のルーティングを使用する複数の接続のすべてが、同じ読み取り専用のレプリカに接続しないようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="09611-158">It is possible that multiple connections using read-only routing will not all connect to the same read-only replica.</span></span> <span data-ttu-id="09611-159">データベースの同期変更またはサーバーのルーティング構成の変更は、異なる読み取り専用のレプリカに対するクライアントの接続につながることがあります。</span><span class="sxs-lookup"><span data-stu-id="09611-159">Changes in database synchronization or changes in the server's routing configuration can result in client connections to different read-only replicas.</span></span> <span data-ttu-id="09611-160">すべての読み取り専用の要求が、確実に同じ読み取り専用のレプリカに接続するようにするには、`Data Source` 接続文字列キーワードに可用性グループ リスナーを渡さないでください。</span><span class="sxs-lookup"><span data-stu-id="09611-160">To ensure that all read-only requests connect to the same read-only replica, do not pass an availability group listener to the `Data Source` connection string keyword.</span></span> <span data-ttu-id="09611-161">代わりに、読み取り専用のインスタンスの名前を指定します。</span><span class="sxs-lookup"><span data-stu-id="09611-161">Instead, specify the name of the read-only instance.</span></span>  
  
 <span data-ttu-id="09611-162">読み取り専用のルーティングでは、最初にプライマリに接続し、最適な可用性の読み取り可能なセカンダリを検索するため、プライマリに接続するよりも時間がかかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="09611-162">Read-only routing may take longer than connecting to the primary because read only routing first connects to the primary and then looks for the best available readable secondary.</span></span> <span data-ttu-id="09611-163">そのため、ログインのタイムアウトを増やす必要があります。</span><span class="sxs-lookup"><span data-stu-id="09611-163">Because of this, you should increase your login timeout.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="09611-164">関連項目</span><span class="sxs-lookup"><span data-stu-id="09611-164">See also</span></span>

- [<span data-ttu-id="09611-165">SQL Server の機能と ADO.NET</span><span class="sxs-lookup"><span data-stu-id="09611-165">SQL Server Features and ADO.NET</span></span>](sql-server-features-and-adonet.md)
- [<span data-ttu-id="09611-166">ADO.NET の概要</span><span class="sxs-lookup"><span data-stu-id="09611-166">ADO.NET Overview</span></span>](../ado-net-overview.md)
