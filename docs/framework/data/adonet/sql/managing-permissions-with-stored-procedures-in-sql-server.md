---
title: SQL Server でのストアド プロシージャを使用した権限の管理
description: ストアド プロシージャまたはユーザー定義関数を使ってアクセスを実装することにより、データやデータベース オブジェクトへのアクセスを制限する方法について説明します。
ms.date: 03/30/2017
ms.assetid: 08fa34e8-2ffa-470d-ba62-e511a5f8558e
ms.openlocfilehash: 890c1c6dd7003f3abd684d6c827b6a77a3a019c1
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/02/2020
ms.locfileid: "84286289"
---
# <a name="managing-permissions-with-stored-procedures-in-sql-server"></a><span data-ttu-id="85c54-103">SQL Server でのストアド プロシージャを使用した権限の管理</span><span class="sxs-lookup"><span data-stu-id="85c54-103">Managing Permissions with Stored Procedures in SQL Server</span></span>
<span data-ttu-id="85c54-104">データベースを多層的に防御する 1 つの方法として、あらゆるデータ アクセスをストアド プロシージャまたはユーザー定義関数を使って実装することが考えられます。</span><span class="sxs-lookup"><span data-stu-id="85c54-104">One method of creating multiple lines of defense around your database is to implement all data access using stored procedures or user-defined functions.</span></span> <span data-ttu-id="85c54-105">テーブルなど、基になるオブジェクトに対する権限をすべて取り消すか拒否し、ストアド プロシージャに対して EXECUTE 権限を付与するようにします。</span><span class="sxs-lookup"><span data-stu-id="85c54-105">You revoke or deny all permissions to underlying objects, such as tables, and grant EXECUTE permissions on stored procedures.</span></span> <span data-ttu-id="85c54-106">こうすることで、データやデータベース オブジェクトの周囲にセキュリティの境界を設けることができます。</span><span class="sxs-lookup"><span data-stu-id="85c54-106">This effectively creates a security perimeter around your data and database objects.</span></span>  
  
## <a name="stored-procedure-benefits"></a><span data-ttu-id="85c54-107">ストアド プロシージャの利点</span><span class="sxs-lookup"><span data-stu-id="85c54-107">Stored Procedure Benefits</span></span>  
 <span data-ttu-id="85c54-108">ストアド プロシージャには、次の利点があります。</span><span class="sxs-lookup"><span data-stu-id="85c54-108">Stored procedures have the following benefits:</span></span>  
  
- <span data-ttu-id="85c54-109">データ ロジックとビジネス ルールがカプセル化されるため、ユーザーが、開発者およびデータベース管理者の想定外の方法でデータやオブジェクトにアクセスするのを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="85c54-109">Data logic and business rules can be encapsulated so that users can access data and objects only in ways that developers and database administrators intend.</span></span>  
  
- <span data-ttu-id="85c54-110">すべてのユーザー入力を検証するパラメーター化されたストアド プロシージャを使用することで、SQL インジェクション攻撃を阻止できます。</span><span class="sxs-lookup"><span data-stu-id="85c54-110">Parameterized stored procedures that validate all user input can be used to thwart SQL injection attacks.</span></span> <span data-ttu-id="85c54-111">動的 SQL を使用する場合は、必ずコマンドをパラメーター化するようにし、パラメーター値を直接クエリ文字列に追加することは避けてください。</span><span class="sxs-lookup"><span data-stu-id="85c54-111">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into a query string.</span></span>  
  
- <span data-ttu-id="85c54-112">アドホック クエリおよびデータ変更を禁止できます。</span><span class="sxs-lookup"><span data-stu-id="85c54-112">Ad hoc queries and data modifications can be disallowed.</span></span> <span data-ttu-id="85c54-113">悪意からまたは不注意によってデータが破壊されたり、サーバーやネットワークのパフォーマンスを損ねるようなクエリが実行されるのを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="85c54-113">This prevents users from maliciously or inadvertently destroying data or executing queries that impair performance on the server or the network.</span></span>  
  
- <span data-ttu-id="85c54-114">エラーをクライアント アプリケーションに直接渡すことなく、プロシージャ コード内で処理できます。</span><span class="sxs-lookup"><span data-stu-id="85c54-114">Errors can be handled in procedure code without being passed directly to client applications.</span></span> <span data-ttu-id="85c54-115">これにより、返されたエラー メッセージがプローブ攻撃に利用されるのを防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="85c54-115">This prevents error messages from being returned that could aid in a probing attack.</span></span> <span data-ttu-id="85c54-116">エラーはログに記録しサーバー上で処理するようにします。</span><span class="sxs-lookup"><span data-stu-id="85c54-116">Log errors and handle them on the server.</span></span>  
  
- <span data-ttu-id="85c54-117">ストアド プロシージャは 1 度作成すれば、さまざまなアプリケーションからアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="85c54-117">Stored procedures can be written once, and accessed by many applications.</span></span>  
  
- <span data-ttu-id="85c54-118">クライアント アプリケーションは基になるデータの構造を意識する必要がありません。</span><span class="sxs-lookup"><span data-stu-id="85c54-118">Client applications do not need to know anything about the underlying data structures.</span></span> <span data-ttu-id="85c54-119">パラメーター リストや返されるデータ型に影響が及ばない限り、ストアド プロシージャのコードを変更しても、クライアント アプリケーション側に変更を加える必要はありません。</span><span class="sxs-lookup"><span data-stu-id="85c54-119">Stored procedure code can be changed without requiring changes in client applications as long as the changes do not affect parameter lists or returned data types.</span></span>  
  
- <span data-ttu-id="85c54-120">ストアド プロシージャによって、複数の操作を 1 回のプロシージャ呼び出しにまとめることができるため、ネットワーク トラフィックを削減できます。</span><span class="sxs-lookup"><span data-stu-id="85c54-120">Stored procedures can reduce network traffic by combining multiple operations into one procedure call.</span></span>  
  
## <a name="stored-procedure-execution"></a><span data-ttu-id="85c54-121">ストアド プロシージャの実行</span><span class="sxs-lookup"><span data-stu-id="85c54-121">Stored Procedure Execution</span></span>  
 <span data-ttu-id="85c54-122">ストアド プロシージャを使用すると、所有権の継承によるデータ アクセスを利用できるため、データベース オブジェクトにアクセスするための権限をユーザーに明示的に付与する必要がありません。</span><span class="sxs-lookup"><span data-stu-id="85c54-122">Stored procedures take advantage of ownership chaining to provide access to data so that users do not need to have explicit permission to access database objects.</span></span> <span data-ttu-id="85c54-123">所有権の継承は、連鎖的にアクセスされる複数のオブジェクトが同じユーザーによって所有されている場合に適用されます。</span><span class="sxs-lookup"><span data-stu-id="85c54-123">An ownership chain exists when objects that access each other sequentially are owned by the same user.</span></span> <span data-ttu-id="85c54-124">たとえば、あるストアド プロシージャが別のストアド プロシージャを呼び出したり、特定のストアド プロシージャが複数のテーブルにアクセスしたりすることができます。</span><span class="sxs-lookup"><span data-stu-id="85c54-124">For example, a stored procedure can call other stored procedures, or a stored procedure can access multiple tables.</span></span> <span data-ttu-id="85c54-125">実行の連鎖に含まれるすべてのオブジェクトが同じ所有者を共有していた場合、SQL Server は呼び出し元の EXECUTE 権限だけをチェックします。つまり、他のオブジェクトの呼び出し元の権限はチェックされません。</span><span class="sxs-lookup"><span data-stu-id="85c54-125">If all objects in the chain of execution have the same owner, then SQL Server only checks the EXECUTE permission for the caller, not the caller's permissions on other objects.</span></span> <span data-ttu-id="85c54-126">したがって、EXECUTE 権限はストアド プロシージャにのみ付与すればよく、基になるテーブルの権限はすべて取り消すか拒否できます。</span><span class="sxs-lookup"><span data-stu-id="85c54-126">Therefore you need to grant only EXECUTE permissions on stored procedures; you can revoke or deny all permissions on the underlying tables.</span></span>  
  
## <a name="best-practices"></a><span data-ttu-id="85c54-127">ベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="85c54-127">Best Practices</span></span>  
 <span data-ttu-id="85c54-128">単にストアド プロシージャを作成するだけでは、アプリケーションを適切に保護することはできません。</span><span class="sxs-lookup"><span data-stu-id="85c54-128">Simply writing stored procedures isn't enough to adequately secure your application.</span></span> <span data-ttu-id="85c54-129">同時に、次の点を考慮してセキュリティ ホールを防ぐ必要があります。</span><span class="sxs-lookup"><span data-stu-id="85c54-129">You should also consider the following potential security holes.</span></span>  
  
- <span data-ttu-id="85c54-130">データ アクセスを許可するデータベース ロールに、ストアド プロシージャの EXECUTE 権限を付与する。</span><span class="sxs-lookup"><span data-stu-id="85c54-130">Grant EXECUTE permissions on the stored procedures for database roles you want to be able to access the data.</span></span>  
  
- <span data-ttu-id="85c54-131">基になるテーブルのすべての権限を取り消すか拒否する。`public` ロールを含め、データベース内のすべてのロールおよびユーザーが対象になります。</span><span class="sxs-lookup"><span data-stu-id="85c54-131">Revoke or deny all permissions to the underlying tables for all roles and users in the database, including the `public` role.</span></span> <span data-ttu-id="85c54-132">すべてのユーザーは public から権限を継承します。</span><span class="sxs-lookup"><span data-stu-id="85c54-132">All users inherit permissions from public.</span></span> <span data-ttu-id="85c54-133">したがって、`public` の権限を拒否することは、所有者と `sysadmin` メンバーだけがアクセス権を持つことを意味します。それ以外のすべてのユーザーは、他のロールのメンバーになっても権限を継承することはできなくなります。</span><span class="sxs-lookup"><span data-stu-id="85c54-133">Therefore denying permissions to `public` means that only owners and `sysadmin` members have access; all other users will be unable to inherit permissions from membership in other roles.</span></span>  
  
- <span data-ttu-id="85c54-134">`sysadmin` ロールまたは `db_owner` ロールに対してユーザーまたはロールを追加することは避ける。</span><span class="sxs-lookup"><span data-stu-id="85c54-134">Do not add users or roles to the `sysadmin` or `db_owner` roles.</span></span> <span data-ttu-id="85c54-135">システム管理者およびデータベース所有者は、すべてのデータベース オブジェクトにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="85c54-135">System administrators and database owners can access all database objects.</span></span>  
  
- <span data-ttu-id="85c54-136">`guest` アカウントを無効にする。</span><span class="sxs-lookup"><span data-stu-id="85c54-136">Disable the `guest` account.</span></span> <span data-ttu-id="85c54-137">こうすることで、匿名ユーザーがデータベースに接続することはできなくなります。</span><span class="sxs-lookup"><span data-stu-id="85c54-137">This will prevent anonymous users from connecting to the database.</span></span> <span data-ttu-id="85c54-138">新しいデータベースの guest アカウントは既定で無効化されています。</span><span class="sxs-lookup"><span data-stu-id="85c54-138">The guest account is disabled by default in new databases.</span></span>  
  
- <span data-ttu-id="85c54-139">エラー処理を実装し、エラーのログを記録する。</span><span class="sxs-lookup"><span data-stu-id="85c54-139">Implement error handling and log errors.</span></span>  
  
- <span data-ttu-id="85c54-140">すべてのユーザー入力を検証するパラメーター化されたストアド プロシージャを作成する。</span><span class="sxs-lookup"><span data-stu-id="85c54-140">Create parameterized stored procedures that validate all user input.</span></span> <span data-ttu-id="85c54-141">どのようなユーザー入力も "信頼できないもの" として扱うようにします。</span><span class="sxs-lookup"><span data-stu-id="85c54-141">Treat all user input as untrusted.</span></span>  
  
- <span data-ttu-id="85c54-142">どうしても必要な場合を除き、動的 SQL は使用しない。</span><span class="sxs-lookup"><span data-stu-id="85c54-142">Avoid dynamic SQL unless absolutely necessary.</span></span> <span data-ttu-id="85c54-143">文字列値を Transact-SQL の QUOTENAME() 関数に渡すことで、入力文字列に含まれている可能性のある区切り記号をエスケープできます。</span><span class="sxs-lookup"><span data-stu-id="85c54-143">Use the Transact-SQL QUOTENAME() function to delimit a string value and escape any occurrence of the delimiter in the input string.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="85c54-144">外部リソース</span><span class="sxs-lookup"><span data-stu-id="85c54-144">External Resources</span></span>  
 <span data-ttu-id="85c54-145">詳細については、次のリソースを参照してください。</span><span class="sxs-lookup"><span data-stu-id="85c54-145">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="85c54-146">リソース</span><span class="sxs-lookup"><span data-stu-id="85c54-146">Resource</span></span>|<span data-ttu-id="85c54-147">説明</span><span class="sxs-lookup"><span data-stu-id="85c54-147">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="85c54-148">「[ストアド プロシージャ](/sql/relational-databases/stored-procedures/stored-procedures-database-engine)」および「[SQL インジェクション](/sql/relational-databases/security/sql-injection)」</span><span class="sxs-lookup"><span data-stu-id="85c54-148">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection)</span></span>|<span data-ttu-id="85c54-149">ストアド プロシージャの作成方法と SQL インジェクションのしくみについて説明します。</span><span class="sxs-lookup"><span data-stu-id="85c54-149">Articles describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="85c54-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="85c54-150">See also</span></span>

- [<span data-ttu-id="85c54-151">ADO.NET アプリケーションのセキュリティ保護</span><span class="sxs-lookup"><span data-stu-id="85c54-151">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="85c54-152">SQL Server セキュリティの概要</span><span class="sxs-lookup"><span data-stu-id="85c54-152">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="85c54-153">SQL Server におけるアプリケーション セキュリティのシナリオ</span><span class="sxs-lookup"><span data-stu-id="85c54-153">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="85c54-154">SQL Server での安全な動的 SQL の作成</span><span class="sxs-lookup"><span data-stu-id="85c54-154">Writing Secure Dynamic SQL in SQL Server</span></span>](writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="85c54-155">SQL Server でのストアド プロシージャの署名</span><span class="sxs-lookup"><span data-stu-id="85c54-155">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="85c54-156">SQL Server での借用を使用したアクセス許可のカスタマイズ</span><span class="sxs-lookup"><span data-stu-id="85c54-156">Customizing Permissions with Impersonation in SQL Server</span></span>](customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="85c54-157">ストアド プロシージャでのデータの変更</span><span class="sxs-lookup"><span data-stu-id="85c54-157">Modifying Data with Stored Procedures</span></span>](../modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="85c54-158">ADO.NET の概要</span><span class="sxs-lookup"><span data-stu-id="85c54-158">ADO.NET Overview</span></span>](../ado-net-overview.md)
