---
title: トランザクション管理のエスカレーション
description: トランザクション マネージャーのいずれかのコンポーネントから別のコンポーネントにトランザクションを移行するプロセスである、.NET のトランザクション管理エスカレーションについて説明します。
ms.date: 03/30/2017
ms.assetid: 1e96331e-31b6-4272-bbbd-29ed1e110460
ms.openlocfilehash: a0b70f4be0f041be95b02537e06f9ec19a9b6183
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141658"
---
# <a name="transaction-management-escalation"></a><span data-ttu-id="c6fec-103">トランザクション管理のエスカレーション</span><span class="sxs-lookup"><span data-stu-id="c6fec-103">Transaction Management Escalation</span></span>
<span data-ttu-id="c6fec-104">Windows は、トランザクション マネージャーを構成する一連のサービスとモジュールをホストします。</span><span class="sxs-lookup"><span data-stu-id="c6fec-104">Windows hosts a set of services and modules that together constitute a transaction manager.</span></span> <span data-ttu-id="c6fec-105">トランザクション管理のエスカレーションとは、トランザクション マネージャーのいずれかのコンポーネントから別のコンポーネントにトランザクションを移行するプロセスを表します。</span><span class="sxs-lookup"><span data-stu-id="c6fec-105">Transaction management escalation describes the process of migrating a transaction from one of the transaction manager's components to another.</span></span>  
  
 <span data-ttu-id="c6fec-106"><xref:System.Transactions> には、最大で 1 つの永続的なリソースまたは複数の揮発性リソースに関連するトランザクションを調整するトランザクション マネージャー コンポーネントが含まれています。</span><span class="sxs-lookup"><span data-stu-id="c6fec-106"><xref:System.Transactions> includes a transaction manager component that coordinates a transaction involving at most, a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="c6fec-107">トランザクション マネージャーは、アプリケーション内ドメインの呼び出しのみを使用するため、最良のパフォーマンスを得られます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-107">Because the transaction manager uses only intra-application domain calls, it yields the best performance.</span></span> <span data-ttu-id="c6fec-108">開発者は、トランザクション マネージャーを直接操作する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="c6fec-108">Developers need not interact with the transaction manager directly.</span></span> <span data-ttu-id="c6fec-109">その代わり、インターフェイス、共通する動作、およびヘルパー クラスを定義する共通インフラストラクチャが、<xref:System.Transactions> 名前空間によって用意されています。</span><span class="sxs-lookup"><span data-stu-id="c6fec-109">Instead, a common infrastructure that defines interfaces, common behavior, and helper classes is provided by the <xref:System.Transactions> namespace.</span></span>  
  
 <span data-ttu-id="c6fec-110">同じコンピューターにある別のアプリケーション ドメイン (プロセスやマシンの境界をまたぐドメインを含む) 内のオブジェクトにトランザクションを提供する場合は、<xref:System.Transactions> インフラストラクチャは、トランザクションを自動的にエスカレートして、Microsoft 分散トランザクション コーディネーター (MSDTC) によって管理されるようにします。</span><span class="sxs-lookup"><span data-stu-id="c6fec-110">When you want to provide the transaction to an object in another application domain (including across process and machine boundaries) on the same computer, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="c6fec-111">エスカレーションは、別の永続的なリソース マネージャーに参加する際にも発生します。</span><span class="sxs-lookup"><span data-stu-id="c6fec-111">The escalation also occurs if you enlist another durable resource manager.</span></span> <span data-ttu-id="c6fec-112">エスカレートされると、トランザクションは完了するまで昇格した状態で管理され続けます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-112">When escalated, the transaction remains managed in its elevated state until its completion.</span></span>  
  
 <span data-ttu-id="c6fec-113"><xref:System.Transactions> トランザクションと MSDTC トランザクションの間には、PSPE (Promotable Single Phase Enlistment) を介して利用できる中間タイプのトランザクションがあります。</span><span class="sxs-lookup"><span data-stu-id="c6fec-113">Between the <xref:System.Transactions> transaction and MSDTC transaction, there is an intermediary type of transaction that is made available through the Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="c6fec-114">PSPE は、<xref:System.Transactions> でパフォーマンスを最適化するための重要なメカニズムです。</span><span class="sxs-lookup"><span data-stu-id="c6fec-114">PSPE is another important mechanism in <xref:System.Transactions> for performance optimization.</span></span> <span data-ttu-id="c6fec-115">PSPE を使用すると、異なるアプリケーション ドメイン、プロセス、コンピューターにあるリモート永続リソースが、MSDTC トランザクションにエスカレートされることなく、<xref:System.Transactions> トランザクションに参加できるようになります。</span><span class="sxs-lookup"><span data-stu-id="c6fec-115">It allows a remote durable resource, located in a different application domain, process or computer, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="c6fec-116">PSPE の詳細については、「[トランザクションの参加要素としてのリソースの参加](enlisting-resources-as-participants-in-a-transaction.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c6fec-116">For more information about PSPE, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md).</span></span>  
  
## <a name="how-escalation-is-initiated"></a><span data-ttu-id="c6fec-117">エスカレーションの開始方法</span><span class="sxs-lookup"><span data-stu-id="c6fec-117">How Escalation is Initiated</span></span>  
 <span data-ttu-id="c6fec-118">トランザクションのエスカレーションが行われると、パフォーマンスが低下します。MSDTC は別のプロセスにあるため、トランザクションを MSDTC にエスカレートすると、プロセス間でメッセージが送信されることになるからです。</span><span class="sxs-lookup"><span data-stu-id="c6fec-118">Transaction escalation reduces performance because the MSDTC resides in a separate process, and escalating a transaction to the MSDTC results in messages being sent across process.</span></span> <span data-ttu-id="c6fec-119">パフォーマンスを向上させるには、MSDTC へのエスカレーションを遅延または回避します。このため、エスカレーションが開始される方法とその条件を知る必要があります。</span><span class="sxs-lookup"><span data-stu-id="c6fec-119">To improve performance, you should delay or avoid escalation to MSDTC; thus, you need to know how and when the escalation is initiated.</span></span>  
  
 <span data-ttu-id="c6fec-120"><xref:System.Transactions> インフラストラクチャが揮発性リソースと、単一フェーズの通知をサポートする最大 1 つの永続リソースを処理している限り、トランザクションは、<xref:System.Transactions> インフラストラクチャが所有し続けます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-120">As long as the <xref:System.Transactions> infrastructure handles volatile resources and at most one durable resource that supports single-phase notifications, the transaction remains in the ownership of the <xref:System.Transactions> infrastructure.</span></span> <span data-ttu-id="c6fec-121">トランザクション マネージャーが有効であるのは、同じアプリケーション ドメインに存在し、ログ (トランザクション結果のディスクへの書き込み) が必要ないリソースに対してのみです。</span><span class="sxs-lookup"><span data-stu-id="c6fec-121">The transaction manager avails itself only to those resources that live in the same application domain and for which logging (writing the transaction outcome to disk) is not required.</span></span> <span data-ttu-id="c6fec-122">次の場合には、<xref:System.Transactions> インフラストラクチャにより、トランザクションの所有権が MSDTC に移されます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-122">An escalation that results in the <xref:System.Transactions> infrastructure transferring the ownership of the transaction to MSDTC happens when:</span></span>  
  
- <span data-ttu-id="c6fec-123">単一フェーズ通知をサポートしない永続リソースが少なくとも 1 つトランザクションに参加している場合。</span><span class="sxs-lookup"><span data-stu-id="c6fec-123">At least one durable resource that does not support single-phase notifications is enlisted in the transaction.</span></span>  
  
- <span data-ttu-id="c6fec-124">単一フェーズ通知をサポートする永続リソースが少なくとも 2 つトランザクションに参加している場合。</span><span class="sxs-lookup"><span data-stu-id="c6fec-124">At least two durable resources that support single-phase notifications are enlisted in the transaction.</span></span> <span data-ttu-id="c6fec-125">たとえば、SQL Server 2005 との単一の接続の参加では、トランザクションの昇格は発生しません。</span><span class="sxs-lookup"><span data-stu-id="c6fec-125">For example, enlisting a single connection with SQL Server 2005 does not cause a transaction to be promoted.</span></span> <span data-ttu-id="c6fec-126">一方、SQL Server 2005 データベースへの別の接続を開いてデータベースが参加したときには、<xref:System.Transactions> インフラストラクチャは、このトランザクションの 2 つ目の永続リソースであることを検出し、MSDTC トランザクションにエスカレートします。</span><span class="sxs-lookup"><span data-stu-id="c6fec-126">However, whenever you open a second connection to a SQL Server 2005 database causing the database to enlist, the <xref:System.Transactions> infrastructure detects that it is the second durable resource in the transaction, and escalates it to an MSDTC transaction.</span></span>  
  
- <span data-ttu-id="c6fec-127">別のアプリケーション ドメインまたはプロセスにトランザクションを "マーシャリング" する要求が呼び出された場合。</span><span class="sxs-lookup"><span data-stu-id="c6fec-127">A request to "marshal" the transaction to a different application domain or different process is invoked.</span></span> <span data-ttu-id="c6fec-128">たとえば、アプリケーション ドメイン境界をまたぐトランザクション オブジェクトのシリアル化などです。</span><span class="sxs-lookup"><span data-stu-id="c6fec-128">For example, the serialization of the transaction object across an application domain boundary.</span></span> <span data-ttu-id="c6fec-129">トランザクション オブジェクトは、値によってマーシャリングされます。つまり、アプリケーション ドメイン境界を越えてトランザクション オブジェクトを渡そうとすると (同じプロセス内でも)、トランザクション オブジェクトのシリアル化が発生します。</span><span class="sxs-lookup"><span data-stu-id="c6fec-129">The transaction object is marshaled-by-value, meaning that any attempt to pass it across an application domain boundary (even in the same process) results in serialization of the transaction object.</span></span> <span data-ttu-id="c6fec-130"><xref:System.Transactions.Transaction> をパラメーターとして受け取るリモート メソッドを呼び出すことで、トランザクション オブジェクトを渡すことができます。または、リモートのトランザクション サービス コンポーネントにアクセスすることもできます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-130">You can pass the transaction objects by making a call on a remote method that takes a <xref:System.Transactions.Transaction> as a parameter or you can try to access a remote transactional-serviced component.</span></span> <span data-ttu-id="c6fec-131">この場合、トランザクション オブジェクトがシリアル化され、エスカレーションが発生します。アプリケーション ドメインをまたいでトランザクションがシリアル化される場合と同様です。</span><span class="sxs-lookup"><span data-stu-id="c6fec-131">This serializes the transaction object and results in an escalation, as when a transaction is serialized across an application domain.</span></span> <span data-ttu-id="c6fec-132">トランザクションが分散されるので、ローカルのトランザクション マネージャーでは不十分になります。</span><span class="sxs-lookup"><span data-stu-id="c6fec-132">It is being distributed and the local transaction manager is no longer adequate.</span></span>  
  
 <span data-ttu-id="c6fec-133">エスカレーション中にスローされる可能性のある例外をすべて次の表に示します。</span><span class="sxs-lookup"><span data-stu-id="c6fec-133">The following table lists all the possible exceptions that can be thrown during escalation.</span></span>  
  
|<span data-ttu-id="c6fec-134">例外の種類</span><span class="sxs-lookup"><span data-stu-id="c6fec-134">Exception type</span></span>|<span data-ttu-id="c6fec-135">条件</span><span class="sxs-lookup"><span data-stu-id="c6fec-135">Condition</span></span>|  
|--------------------|---------------|  
|<xref:System.InvalidOperationException>|<span data-ttu-id="c6fec-136">分離レベルが <xref:System.Transactions.IsolationLevel.Snapshot> のトランザクションをエスカレートしようとしました。</span><span class="sxs-lookup"><span data-stu-id="c6fec-136">An attempt to escalate a transaction with isolation level equal to <xref:System.Transactions.IsolationLevel.Snapshot>.</span></span>|  
|<xref:System.Transactions.TransactionAbortedException>|<span data-ttu-id="c6fec-137">トランザクション マネージャーがダウンしています。</span><span class="sxs-lookup"><span data-stu-id="c6fec-137">The transaction manager is down.</span></span>|  
|<xref:System.Transactions.TransactionException>|<span data-ttu-id="c6fec-138">エスカレーションが失敗し、アプリケーションが中止されます。</span><span class="sxs-lookup"><span data-stu-id="c6fec-138">The escalation fails and the application is aborted.</span></span>|
