---
title: トランザクション管理のエスカレーション
ms.date: 03/30/2017
ms.assetid: 1e96331e-31b6-4272-bbbd-29ed1e110460
ms.openlocfilehash: df2597d6fcce7fbd51f6f17bd42469cb7fcf3fdf
ms.sourcegitcommit: d6e27023aeaffc4b5a3cb4b88685018d6284ada4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/09/2019
ms.locfileid: "67662456"
---
# <a name="transaction-management-escalation"></a>トランザクション管理のエスカレーション
Windows は、トランザクション マネージャーを構成する一連のサービスとモジュールをホストします。 トランザクション管理のエスカレーションとは、トランザクション マネージャーのいずれかのコンポーネントから別のコンポーネントにトランザクションを移行するプロセスを表します。  
  
 <xref:System.Transactions> 最大で 1 つの持続性のあるリソースまたは複数の揮発性リソースに関連するトランザクションを調整するトランザクション マネージャー コンポーネントが含まれています。 トランザクション マネージャーは、アプリケーション内ドメインの呼び出しのみを使用するため、最良のパフォーマンスを得られます。 開発者は、トランザクション マネージャーを直接操作する必要はありません。 その代わり、インターフェイス、共通する動作、およびヘルパー クラスを定義する共通インフラストラクチャが、<xref:System.Transactions> 名前空間によって用意されています。  
  
 同じコンピューターでは、(プロセスやコンピューターの境界を越えてなど) 別のアプリケーション ドメイン内のオブジェクトにトランザクションを提供する場合に、<xref:System.Transactions>インフラストラクチャが自動的に Microsoft によって管理されるトランザクションをエスカレート分散トランザクション コーディネーター (MSDTC)。 エスカレーションは、別の永続的なリソース マネージャーに参加する際にも発生します。 エスカレートされると、トランザクションは完了するまで昇格した状態で管理され続けます。  
  
 <xref:System.Transactions> トランザクションと MSDTC トランザクションの間には、PSPE (Promotable Single Phase Enlistment) を介して利用できる中間タイプのトランザクションがあります。 PSPE は、<xref:System.Transactions> でパフォーマンスを最適化するための重要なメカニズムです。 PSPE を使用すると、異なるアプリケーション ドメイン、プロセス、コンピューターにあるリモート永続リソースが、MSDTC トランザクションにエスカレートされることなく、<xref:System.Transactions> トランザクションに参加できるようになります。 PSPE の詳細については、次を参照してください。[トランザクションの参加者として参加リソース](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md)します。  
  
## <a name="how-escalation-is-initiated"></a>エスカレーションの開始方法  
 トランザクションのエスカレーションが行われると、パフォーマンスが低下します。MSDTC は別のプロセスにあるため、トランザクションを MSDTC にエスカレートすると、プロセス間でメッセージが送信されることになるからです。 パフォーマンスを向上させるには、遅延または MSDTC; へのエスカレーションを回避する必要があります。そのため、エスカレーションが開始された方法とタイミングを把握する必要があります。  
  
 <xref:System.Transactions> インフラストラクチャが揮発性リソースと、単一フェーズの通知をサポートする最大 1 つの永続リソースを処理している限り、トランザクションは、<xref:System.Transactions> インフラストラクチャが所有し続けます。 トランザクション マネージャーが有効であるのは、同じアプリケーション ドメインに存在し、ログ (トランザクション結果のディスクへの書き込み) が必要ないリソースに対してのみです。 次の場合には、<xref:System.Transactions> インフラストラクチャにより、トランザクションの所有権が MSDTC に移されます。  
  
- 単一フェーズ通知をサポートしない永続リソースが少なくとも 1 つトランザクションに参加している場合。  
  
- 単一フェーズ通知をサポートする永続リソースが少なくとも 2 つトランザクションに参加している場合。 たとえば、SQL Server 2005 での 1 つの接続に参加しても、トランザクションを昇格させるは発生しません。 ただし、2 番目の原因で、データベースが参加するには、SQL Server 2005 データベースに接続を開くたびに、<xref:System.Transactions>インフラストラクチャは、トランザクションの持続性のある 2 番目のリソースと、MSDTC トランザクションにエスカレートを検出します。  
  
- 別のアプリケーション ドメインまたはプロセスにトランザクションを "マーシャリング" する要求が呼び出された場合。 たとえば、アプリケーション ドメイン境界をまたぐトランザクション オブジェクトのシリアル化などです。 トランザクション オブジェクトは、値によってマーシャリングされます。つまり、アプリケーション ドメイン境界を越えてトランザクション オブジェクトを渡そうとすると (同じプロセス内でも)、トランザクション オブジェクトのシリアル化が発生します。 <xref:System.Transactions.Transaction> をパラメーターとして受け取るリモート メソッドを呼び出すことで、トランザクション オブジェクトを渡すことができます。または、リモートのトランザクション サービス コンポーネントにアクセスすることもできます。 この場合、トランザクション オブジェクトがシリアル化され、エスカレーションが発生します。アプリケーション ドメインをまたいでトランザクションがシリアル化される場合と同様です。 トランザクションが分散されるので、ローカルのトランザクション マネージャーでは不十分になります。  
  
 エスカレーション中にスローされる可能性のある例外をすべて次の表に示します。  
  
|例外の種類|条件|  
|--------------------|---------------|  
|<xref:System.InvalidOperationException>|分離レベルが <xref:System.Transactions.IsolationLevel.Snapshot> のトランザクションをエスカレートしようとしました。|  
|<xref:System.Transactions.TransactionAbortedException>|トランザクション マネージャーがダウンしています。|  
|<xref:System.Transactions.TransactionException>|エスカレーションが失敗し、アプリケーションが中止されます。|
