---
title: トランザクション管理のエスカレーション
ms.date: 03/30/2017
ms.assetid: 1e96331e-31b6-4272-bbbd-29ed1e110460
ms.openlocfilehash: d2f027f8a94ee8f0cd23d0f0909ecc9137873bc2
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205845"
---
# <a name="transaction-management-escalation"></a>トランザクション管理のエスカレーション
Windows は、トランザクション マネージャーを構成する一連のサービスとモジュールをホストします。 トランザクション管理のエスカレーションとは、トランザクション マネージャーのいずれかのコンポーネントから別のコンポーネントにトランザクションを移行するプロセスを表します。  
  
 <xref:System.Transactions>には、1つの永続的なリソースまたは複数の揮発性リソースに関連するトランザクションを調整するトランザクションマネージャーコンポーネントが含まれています。 トランザクション マネージャーは、アプリケーション内ドメインの呼び出しのみを使用するため、最良のパフォーマンスを得られます。 開発者は、トランザクション マネージャーを直接操作する必要はありません。 その代わり、インターフェイス、共通する動作、およびヘルパー クラスを定義する共通インフラストラクチャが、<xref:System.Transactions> 名前空間によって用意されています。  
  
 同じコンピューター上の別のアプリケーションドメイン (プロセスやコンピューターの境界を越えたものを含む) 内のオブジェクトにトランザクションを提供<xref:System.Transactions>する場合、インフラストラクチャは、Microsoft によって管理されるようにトランザクションを自動的にエスカレートします。分散トランザクションコーディネーター (MSDTC)。 エスカレーションは、別の永続的なリソース マネージャーに参加する際にも発生します。 エスカレートされると、トランザクションは完了するまで昇格した状態で管理され続けます。  
  
 <xref:System.Transactions> トランザクションと MSDTC トランザクションの間には、PSPE (Promotable Single Phase Enlistment) を介して利用できる中間タイプのトランザクションがあります。 PSPE は、<xref:System.Transactions> でパフォーマンスを最適化するための重要なメカニズムです。 PSPE を使用すると、異なるアプリケーション ドメイン、プロセス、コンピューターにあるリモート永続リソースが、MSDTC トランザクションにエスカレートされることなく、<xref:System.Transactions> トランザクションに参加できるようになります。 PSPE の詳細については、「[トランザクションの参加要素としてのリソースの参加](enlisting-resources-as-participants-in-a-transaction.md)」を参照してください。  
  
## <a name="how-escalation-is-initiated"></a>エスカレーションの開始方法  
 トランザクションのエスカレーションが行われると、パフォーマンスが低下します。MSDTC は別のプロセスにあるため、トランザクションを MSDTC にエスカレートすると、プロセス間でメッセージが送信されることになるからです。 パフォーマンスを向上させるには、MSDTC へのエスカレーションを遅延または回避する必要があります。そのため、エスカレーションがどのように開始されたかを把握しておく必要があります。  
  
 <xref:System.Transactions> インフラストラクチャが揮発性リソースと、単一フェーズの通知をサポートする最大 1 つの永続リソースを処理している限り、トランザクションは、<xref:System.Transactions> インフラストラクチャが所有し続けます。 トランザクション マネージャーが有効であるのは、同じアプリケーション ドメインに存在し、ログ (トランザクション結果のディスクへの書き込み) が必要ないリソースに対してのみです。 次の場合には、<xref:System.Transactions> インフラストラクチャにより、トランザクションの所有権が MSDTC に移されます。  
  
- 単一フェーズ通知をサポートしない永続リソースが少なくとも 1 つトランザクションに参加している場合。  
  
- 単一フェーズ通知をサポートする永続リソースが少なくとも 2 つトランザクションに参加している場合。 たとえば、SQL Server 2005 に1つの接続を参加させても、トランザクションは昇格されません。 ただし、データベースが参加する原因となった SQL Server 2005 データベースへの2番目の接続<xref:System.Transactions>を開くたびに、インフラストラクチャは、そのデータベースがトランザクション内の2番目の持続性のあるリソースであることを検出し、MSDTC トランザクションにエスカレートします。  
  
- 別のアプリケーション ドメインまたはプロセスにトランザクションを "マーシャリング" する要求が呼び出された場合。 たとえば、アプリケーション ドメイン境界をまたぐトランザクション オブジェクトのシリアル化などです。 トランザクション オブジェクトは、値によってマーシャリングされます。つまり、アプリケーション ドメイン境界を越えてトランザクション オブジェクトを渡そうとすると (同じプロセス内でも)、トランザクション オブジェクトのシリアル化が発生します。 <xref:System.Transactions.Transaction> をパラメーターとして受け取るリモート メソッドを呼び出すことで、トランザクション オブジェクトを渡すことができます。または、リモートのトランザクション サービス コンポーネントにアクセスすることもできます。 この場合、トランザクション オブジェクトがシリアル化され、エスカレーションが発生します。アプリケーション ドメインをまたいでトランザクションがシリアル化される場合と同様です。 トランザクションが分散されるので、ローカルのトランザクション マネージャーでは不十分になります。  
  
 エスカレーション中にスローされる可能性のある例外をすべて次の表に示します。  
  
|例外の型|条件|  
|--------------------|---------------|  
|<xref:System.InvalidOperationException>|分離レベルが <xref:System.Transactions.IsolationLevel.Snapshot> のトランザクションをエスカレートしようとしました。|  
|<xref:System.Transactions.TransactionAbortedException>|トランザクション マネージャーがダウンしています。|  
|<xref:System.Transactions.TransactionException>|エスカレーションが失敗し、アプリケーションが中止されます。|
