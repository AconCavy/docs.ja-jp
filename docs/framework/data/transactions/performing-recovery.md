---
title: 回復の実行
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: fe0e096c31b2ef62a1bc50d40c87f2e12c87343f
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205886"
---
# <a name="performing-recovery"></a><span data-ttu-id="d8c2f-102">回復の実行</span><span class="sxs-lookup"><span data-stu-id="d8c2f-102">Performing Recovery</span></span>
<span data-ttu-id="d8c2f-103">リソース マネージャーは、リソース障害の後にトランザクション参加要素を再参加させることにより、トランザクションの永続参加リストの解決を容易にします。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-103">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="d8c2f-104">回復プロセス</span><span class="sxs-lookup"><span data-stu-id="d8c2f-104">The Recovery Process</span></span>  
 <span data-ttu-id="d8c2f-105">後で回復できるリソースを永続的に参加させるには (<xref:System.Transactions.IEnlistmentNotification> インターフェイスの実装により記述)、<xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-105">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="d8c2f-106">さらに、リソース障害発生時にトランザクションの参加要素に一貫したラベル付けを行うためのリソース マネージャー識別子 (<xref:System.Transactions.Transaction.EnlistDurable%2A>) を <xref:System.Guid> メソッドに提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-106">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="d8c2f-107">このため、最初の Enlist 呼び出し時に提供される <xref:System.Guid> は、回復中の <xref:System.Transactions.TransactionManager.Reenlist%2A> 呼び出しの *resourceManagerIdentifier* パラメーターと同じである必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-107">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="d8c2f-108">そうでない場合、<xref:System.Transactions.TransactionException> がスローされます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-108">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="d8c2f-109">永続参加リストの詳細については、「[トランザクションの参加要素としてのリソースの参加](enlisting-resources-as-participants-in-a-transaction.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-109">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="d8c2f-110">2PC プロトコルの準備フェーズ (フェーズ 1) で、永続的リソース マネージャーの実装が <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> 通知を受け取った場合、このフェーズ中にその準備レコードをログに記録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-110">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="d8c2f-111">このレコードには、コミット時にトランザクションを完了するために必要なすべての情報を含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-111">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="d8c2f-112">*preparingEnlistment* コールバックの <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> プロパティを取得することにより、後で回復中に準備レコードにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-112">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="d8c2f-113"><xref:System.Transactions.IEnlistmentNotification.Prepare%2A> メソッド内でレコードのログ記録を実行する必要はありません。RM がワーカー スレッド上でこの処理を実行できるためです。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-113">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="d8c2f-114">回復プロセスは、次の 2 つの手順から構成されます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-114">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="d8c2f-115">手順 1 - 再参加</span><span class="sxs-lookup"><span data-stu-id="d8c2f-115">Step 1 - ReEnlist</span></span>  
 <span data-ttu-id="d8c2f-116">リソース マネージャーは、不明な各参加の準備情報レコードについて調べます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-116">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="d8c2f-117">そのためには、フェーズ 1 の <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> 通知でリソース マネージャーに渡された <xref:System.Transactions.PreparingEnlistment> コールバックの <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> プロパティを調べます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-117">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="d8c2f-118">対象の各参加について、トランザクション マネージャーで <xref:System.Transactions.TransactionManager.Reenlist%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-118">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="d8c2f-119">このメソッドは、リソース マネージャーを識別する一意の <xref:System.Guid> と、バイト配列の参加情報を渡します。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-119">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="d8c2f-120">新しい <xref:System.Transactions.Enlistment> オブジェクトが返されます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-120">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="d8c2f-121">再参加が失敗して例外がスローされた場合、リソース マネージャーは後で再試行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-121">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="d8c2f-122">失敗後にリソース マネージャーを再起動するときは、<xref:System.Transactions.TransactionManager.Reenlist%2A> メソッドのみを呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-122">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="d8c2f-123">また、2 フェーズ コミットの最初の準備フェーズ中に、リソース マネージャーによってログ記録された未解決トランザクションのみを再参加させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-123">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="d8c2f-124">無効な時間にこのメソッドを呼び出した場合、間違った結果が生成される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-124">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="d8c2f-125">参加要素がこのメソッドを使用して再参加すると、トランザクションの結果に対応した <xref:System.Transactions.IEnlistmentNotification> のフェーズ 2 のメソッド (つまり、<xref:System.Transactions.IEnlistmentNotification.Commit%2A>、<xref:System.Transactions.IEnlistmentNotification.Rollback%2A>、または <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A>) が必要に応じて呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-125">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="d8c2f-126">手順 2 - 回復の完了</span><span class="sxs-lookup"><span data-stu-id="d8c2f-126">Step 2 - Completing the recovery</span></span>  
 <span data-ttu-id="d8c2f-127">すべての再参加が完了すると、リソース マネージャーは <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-127">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="d8c2f-128">このメソッドは回復を完了し、リソース マネージャーに不明なトランザクションがもう存在しないことをトランザクション マネージャーに通知します。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-128">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="d8c2f-129">これによりリソース マネージャーは、再び <xref:System.Transactions.TransactionManager.Reenlist%2A> メソッドを呼び出さないことを保証します。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-129">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="d8c2f-130">リソース マネージャーは、新しいトランザクションに参加する前に、不明なトランザクションをすべて解決する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-130">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="d8c2f-131">リソース マネージャーは、トランザクション マネージャーとの関係を確立した後、いつでも最初の手順を実行できますが、<xref:System.Transactions.TransactionManager.RecoveryComplete%2A> が呼び出された (手順 2) 後で、手順 1 を再実行することはできません。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-131">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="d8c2f-132">手順 2 は、トランザクションの結果に影響を与えることなく、複数回繰り返すことができます。</span><span class="sxs-lookup"><span data-stu-id="d8c2f-132">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
