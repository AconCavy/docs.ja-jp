---
title: 単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化
description: 単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用したパフォーマンスを最適化します。 .NET の System.Transactions インフラストラクチャについて説明します。
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141979"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="d635c-104">単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化</span><span class="sxs-lookup"><span data-stu-id="d635c-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="d635c-105">ここでは、パフォーマンスを最適化するために <xref:System.Transactions> インフラストラクチャに用意されているメカニズムについて説明します。</span><span class="sxs-lookup"><span data-stu-id="d635c-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="d635c-106">PSPE (Promotable Single Phase Enlistment)</span><span class="sxs-lookup"><span data-stu-id="d635c-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="d635c-107"><xref:System.Transactions> インフラストラクチャは、単一の永続性リソースまたは複数の揮発性リソースを含む単一のアプリケーション ドメイン内のトランザクションを管理します。</span><span class="sxs-lookup"><span data-stu-id="d635c-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="d635c-108"><xref:System.Transactions> インフラストラクチャは、アプリケーション内ドメインの呼び出しのみを使用するため、最良のスループットおよびパフォーマンスを得られます。</span><span class="sxs-lookup"><span data-stu-id="d635c-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="d635c-109">ただし、トランザクションが同じコンピューター上の別のアプリケーション ドメインにある別のオブジェクト (プロセスやコンピューターの境界にまたがるものを含む) に供給される場合や、別の永続的リソース マネージャーを参加させる場合、<xref:System.Transactions> インフラストラクチャは、MSDTC によって管理されるトランザクションを自動的にエスカレートします。</span><span class="sxs-lookup"><span data-stu-id="d635c-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="d635c-110">MSDTC によって管理されるトランザクションは、<xref:System.Transactions> インフラストラクチャによって管理されるトランザクションに比べて、パフォーマンスが落ちます。</span><span class="sxs-lookup"><span data-stu-id="d635c-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="d635c-111">パフォーマンスを最適化するため、<xref:System.Transactions> インフラストラクチャには PSPE (Promotable Single Phase Enlistment) が用意されており、異なるアプリケーション ドメイン、プロセス、またはコンピューターにある単一のリモート永続性リソースが、MSDTC トランザクションにエスカレートされることなく <xref:System.Transactions> トランザクションに参加できるようになります。</span><span class="sxs-lookup"><span data-stu-id="d635c-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="d635c-112">このリソース マネージャー (RM) は、必要に応じて後で分散トランザクション (または MSDTC トランザクション) にエスカレートできるトランザクションをホストおよび "所有" できます。</span><span class="sxs-lookup"><span data-stu-id="d635c-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="d635c-113">これにより、MSDTC の使用頻度が少なくなります。</span><span class="sxs-lookup"><span data-stu-id="d635c-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="d635c-114">この特別なリソース マネージャーは通常、内部に独自の非分散トランザクションを所有しており、実行時にこれらのトランザクションを分散トランザクションに変換する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="d635c-115">たとえば、SQL Server 2005 はこのようなリソース マネージャーです。</span><span class="sxs-lookup"><span data-stu-id="d635c-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="d635c-116">この場合、<xref:System.Transactions> インフラストラクチャは、トランザクションのエスカレーションが必要かどうかを監視するだけという受動的な管理役割を担います。</span><span class="sxs-lookup"><span data-stu-id="d635c-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="d635c-117"><xref:System.Transactions> インフラストラクチャとリソース マネージャー間の相互動作をサポートするため、リソース マネージャーは、<xref:System.Transactions.IPromotableSinglePhaseNotification> インターフェイスを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="d635c-118"><xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> メソッドは、後でエスカレートできる単一の永続性リソースを参加させるのに使用されます。</span><span class="sxs-lookup"><span data-stu-id="d635c-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="d635c-119">このメソッドにより、必要に応じて参加リストをエスカレートできます。</span><span class="sxs-lookup"><span data-stu-id="d635c-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="d635c-120">参加が成功すると、RM は内部トランザクションを作成し、<xref:System.Transactions> トランザクションに関連付けます。</span><span class="sxs-lookup"><span data-stu-id="d635c-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="d635c-121">PSPE の参加が失敗すると、RM は代わりに <xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドを使用して参加を行います。</span><span class="sxs-lookup"><span data-stu-id="d635c-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="d635c-122">トランザクションが既に分散トランザクションである場合や、別の RM が既に PSPE の参加を実行している場合、PSPE の参加は失敗します。</span><span class="sxs-lookup"><span data-stu-id="d635c-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="d635c-123">参加すると、<xref:System.Transactions> トランザクションをコミットまたは中止するクライアントからの呼び出しがリソース マネージャーでの呼び出しに変換されます。これは、それぞれ <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> メソッドまたは <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> を呼び出すことで行われます。</span><span class="sxs-lookup"><span data-stu-id="d635c-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="d635c-124"><xref:System.Transactions> トランザクションのエスカレーションが必要ない場合、トランザクションがコミットされると、RM が <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 通知を受信します。</span><span class="sxs-lookup"><span data-stu-id="d635c-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="d635c-125">次に、最初に作成された内部トランザクションがコミットされます。</span><span class="sxs-lookup"><span data-stu-id="d635c-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="d635c-126"><xref:System.Transactions> トランザクションのエスカレートが必要な場合 (複数の RM をサポートする場合など) は、<xref:System.Transactions> がリソース マネージャーに通知します。この通知は、<xref:System.Transactions.ITransactionPromoter.Promote%2A> インターフェイスの派生元である <xref:System.Transactions.ITransactionPromoter> インターフェイス上の <xref:System.Transactions.IPromotableSinglePhaseNotification> メソッドを呼び出すことで行われます。</span><span class="sxs-lookup"><span data-stu-id="d635c-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="d635c-127">次に、リソース マネージャーは、ローカル トランザクション (ログが不要) から DTC トランザクションに参加できるトランザクション オブジェクトへ、トランザクションを内部的に変換し、既に実行済みの作業に関連付けます。</span><span class="sxs-lookup"><span data-stu-id="d635c-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="d635c-128">トランザクションのコミットが要求されると、トランザクション マネージャーが <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> 通知をリソース マネージャーに送信し、リソース マネージャーがエスカレーション中に作成される分散トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="d635c-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="d635c-129">エスカレートされたトランザクションでコミットが呼び出されたときに生成される **TransactionCommitted** トレースは、DTC トランザクションのアクティビティ ID を含んでいます。</span><span class="sxs-lookup"><span data-stu-id="d635c-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="d635c-130">管理エスカレーションの詳細については、「[トランザクション管理のエスカレーション](transaction-management-escalation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="d635c-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="d635c-131">トランザクション管理エスカレーションのシナリオ</span><span class="sxs-lookup"><span data-stu-id="d635c-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="d635c-132">次のシナリオは、<xref:System.Data>名前空間をリソース マネージャーの "プロキシ" として使用して、分散トランザクションにエスカレートする操作を示しています。</span><span class="sxs-lookup"><span data-stu-id="d635c-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="d635c-133">このシナリオでは、トランザクションで呼び出されたデータベースへの <xref:System.Data><xref:System.Data>接続 (CN1) が既に存在し、アプリケーションが別の  接続 (CN2) を呼び出そうとしている場合を想定しています。</span><span class="sxs-lookup"><span data-stu-id="d635c-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="d635c-134">トランザクションは、完全な分散 2 フェーズ コミット トランザクションとして、DTC にエスカレートする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="d635c-135">このシナリオの内容</span><span class="sxs-lookup"><span data-stu-id="d635c-135">In this scenario,</span></span>

1. <span data-ttu-id="d635c-136">CN1 は、トランザクションに参加するため、<xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d635c-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="d635c-137">ここで、トランザクションはまだローカルであり、トランザクションには他に昇格可能参加リストがないため、<xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> 呼び出しは成功します。</span><span class="sxs-lookup"><span data-stu-id="d635c-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="d635c-138">2 番目の接続 (CN2) が <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> を呼び出すと、関連する別の昇格可能参加リストがあるため、呼び出しが失敗します。</span><span class="sxs-lookup"><span data-stu-id="d635c-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="d635c-139">このため、CN2 は、DTC トランザクションを取得して、SQL に渡す必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="d635c-140">これには、<xref:System.Transactions.TransactionInterop> クラスで提供されるメソッドの 1 つを使用して、SQL に渡すことができるトランザクションの形式を生成します。</span><span class="sxs-lookup"><span data-stu-id="d635c-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="d635c-141"><xref:System.Transactions> は、CN1 によって実装された <xref:System.Transactions.ITransactionPromoter.Promote%2A> インターフェイス上で、<xref:System.Transactions.ITransactionPromoter> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d635c-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="d635c-142">この時点で CN1 は、SQL 2005 固有のメカニズムと <xref:System.Data> を使用して、トランザクションをエスカレートします。</span><span class="sxs-lookup"><span data-stu-id="d635c-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="d635c-143"><xref:System.Transactions.ITransactionPromoter.Promote%2A> メソッドからの戻り値は、トランザクションの反映トークンを含むバイト配列です。</span><span class="sxs-lookup"><span data-stu-id="d635c-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="d635c-144"><xref:System.Transactions> では、この反映トークンを使用して、ローカル トランザクションに組み込むことができる DTC トランザクションが作成されます。</span><span class="sxs-lookup"><span data-stu-id="d635c-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="d635c-145">この時点で CN2 は、<xref:System.Transactions.TransactionInterop> によるメソッドの 1 つを呼び出すことで受信したデータを使用して、SQL にトランザクションを渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="d635c-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="d635c-146">ここで、両方が DTC 分散トランザクションに参加します。</span><span class="sxs-lookup"><span data-stu-id="d635c-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="d635c-147">単一フェーズ コミットの最適化</span><span class="sxs-lookup"><span data-stu-id="d635c-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="d635c-148">単一フェーズ コミット プロトコルは、すべての更新が明示的な調整なしに行われるため、実行時に、より効率的です。</span><span class="sxs-lookup"><span data-stu-id="d635c-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="d635c-149">この最適化を活用するには、リソースの <xref:System.Transactions.ISinglePhaseNotification> インターフェイスを使用してリソース マネージャーを実装し、<xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドまたは <xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッドを使用してトランザクションに参加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="d635c-150">特に、単一フェーズ コミットを確実に実行するには、*EnlistmentOptions* パラメーターを <xref:System.Transactions.EnlistmentOptions.None> と同じにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="d635c-151"><xref:System.Transactions.ISinglePhaseNotification> インターフェイスは <xref:System.Transactions.IEnlistmentNotification> インターフェイスから派生するため、RM が単一フェーズ コミットを実行できない場合でも、2 フェーズ コミット通知を受信できます。</span><span class="sxs-lookup"><span data-stu-id="d635c-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="d635c-152">RM が TM から <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> 通知を受信した場合は、コミットするために必要な作業を実行する必要があります。そして、それに応じて <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A> パラメーター上の <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>、<xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A>、または <xref:System.Transactions.SinglePhaseEnlistment> メソッドを呼び出すことにより、トランザクションのコミットまたはロールバックのどちらが実行されるかを、トランザクション マネージャーに通知する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d635c-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="d635c-153">この段階で、参加リストの <xref:System.Transactions.Enlistment.Done%2A> の応答は、ReadOnly セマンティクスを意味します。</span><span class="sxs-lookup"><span data-stu-id="d635c-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="d635c-154">したがって、他のメソッドに加えて、<xref:System.Transactions.Enlistment.Done%2A> を応答しないでください。</span><span class="sxs-lookup"><span data-stu-id="d635c-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="d635c-155">揮発性の参加リストが 1 つしかなく、永続参加リストがない場合、揮発性の参加リストは SPC 通知を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="d635c-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="d635c-156">揮発性の参加リストがあり、永続参加リストが 1 つしかない場合、揮発性の参加リストは 2PC を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="d635c-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="d635c-157">完了すると、永続参加リストが SPC を受信します。</span><span class="sxs-lookup"><span data-stu-id="d635c-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="d635c-158">関連項目</span><span class="sxs-lookup"><span data-stu-id="d635c-158">See also</span></span>

- [<span data-ttu-id="d635c-159">トランザクションの参加要素としてのリソースの参加</span><span class="sxs-lookup"><span data-stu-id="d635c-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="d635c-160">単一フェースおよび複数フェーズでのトランザクションのコミット</span><span class="sxs-lookup"><span data-stu-id="d635c-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
