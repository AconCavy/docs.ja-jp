---
title: リソース マネージャーの実装
description: .NET でリソース マネージャーを実装する リソース マネージャーにより、トランザクションで使用されるリソースが管理されます。 トランザクション マネージャーにより、リソース マネージャー アクションが調整されます。
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: bf40c6eaee35a5a548c6de4a286e46c4d4a66aca
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141850"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="5a443-105">リソース マネージャーの実装</span><span class="sxs-lookup"><span data-stu-id="5a443-105">Implementing a Resource Manager</span></span>
<span data-ttu-id="5a443-106">トランザクションで使用される各リソースはリソース マネージャーによって管理され、その動作はトランザクション マネージャーによって調整されます。</span><span class="sxs-lookup"><span data-stu-id="5a443-106">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="5a443-107">リソース マネージャーは、トランザクション マネージャーと連携してアプリケーションに原子性と分離を保証します。</span><span class="sxs-lookup"><span data-stu-id="5a443-107">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="5a443-108">Microsoft SQL Server、永続的なメッセージ キュー、メモリ内ハッシュ テーブルはすべて、リソース マネージャーの例です。</span><span class="sxs-lookup"><span data-stu-id="5a443-108">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="5a443-109">リソース マネージャーは、永続性データまたは揮発性データを管理します。</span><span class="sxs-lookup"><span data-stu-id="5a443-109">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="5a443-110">リソース マネージャーの永続性または揮発性とは、リソース マネージャーがエラーの回復をサポートするかどうかを意味します。</span><span class="sxs-lookup"><span data-stu-id="5a443-110">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="5a443-111">リソース マネージャーがエラーの回復をサポートする場合、フェーズ 1 (準備) 中にデータが永続ストレージに保存されます。したがって、リソース マネージャーがダウンした場合でも、回復時にトランザクションへの再参加を行い、トランザクション マネージャーから受信した通知に基づいて適切な動作を実行できます。</span><span class="sxs-lookup"><span data-stu-id="5a443-111">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="5a443-112">一般に、揮発性リソース マネージャーは、メモリ内のデータ構造 (たとえば、メモリ内のトランザクション ハッシュ テーブル) などの揮発性リソースを管理し、永続的リソース マネージャーは、より永続的なバッキング ストアを持つリソース (たとえば、バッキング ストアがディスクであるデータベース) を管理します。</span><span class="sxs-lookup"><span data-stu-id="5a443-112">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="5a443-113">リソースをトランザクションに参加させるには、リソースをトランザクションに登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5a443-113">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="5a443-114"><xref:System.Transactions.Transaction> クラスは、この機能を提供する一連のメソッドを定義しています。これらのメソッドの名前は **Enlist** で始まります。</span><span class="sxs-lookup"><span data-stu-id="5a443-114">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="5a443-115">さまざまな **Enlist** メソッドは、リソース マネージャーが持つ各種の参加リストにそれぞれ対応しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-115">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="5a443-116">具体的には、揮発性リソースには <xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッド、永続性リソースには <xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="5a443-116">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="5a443-117">簡単に説明すると、リソースが永続性をサポートするかどうかに応じて、<xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドまたは <xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッドのどちらを使用するかを決定した後、リソース マネージャーに <xref:System.Transactions.IEnlistmentNotification> インターフェイスを実装して、2 フェーズ コミット (2PC) に参加するようにリソースを登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5a443-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="5a443-118">2PC の詳細については、「[単一フェーズおよび複数フェーズでのトランザクションのコミット](committing-a-transaction-in-single-phase-and-multi-phase.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="5a443-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="5a443-119">参加により、リソース マネージャーは、トランザクションがコミットまたは中止したときに、トランザクション マネージャーからのコールバックを取得することを保証します。</span><span class="sxs-lookup"><span data-stu-id="5a443-119">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="5a443-120">各参加リストについて、<xref:System.Transactions.IEnlistmentNotification> のインスタンスが 1 つ存在します。</span><span class="sxs-lookup"><span data-stu-id="5a443-120">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="5a443-121">通常、トランザクションごとに 1 つの参加リストが存在しますが、リソース マネージャーは、同じトランザクションへの複数回の参加を選択できます。</span><span class="sxs-lookup"><span data-stu-id="5a443-121">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="5a443-122">参加後、リソース マネージャーはトランザクションの要求に応答します。</span><span class="sxs-lookup"><span data-stu-id="5a443-122">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="5a443-123">永続的リソース マネージャーは、管理するリソースに対するトランザクションの処理を元に戻したり、やり直したりするための十分な情報を格納しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-123">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="5a443-124">このためには、さまざまな方法があります。データのバージョン保持と変更ログの保持という 2 つの手法が一般的に使用されます。</span><span class="sxs-lookup"><span data-stu-id="5a443-124">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="5a443-125">アプリケーションがトランザクションをコミットすると、トランザクション マネージャーが 2 フェーズ コミット プロトコルを開始します。</span><span class="sxs-lookup"><span data-stu-id="5a443-125">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="5a443-126">トランザクション マネージャーはまず、参加している各リソース マネージャーに、トランザクションをコミットする準備が整っているかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="5a443-126">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="5a443-127">リソース マネージャーは、コミットの準備、つまりトランザクションをコミットまたは中止できる状態を整える必要があります。</span><span class="sxs-lookup"><span data-stu-id="5a443-127">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="5a443-128">準備フェーズ中に、永続的リソース マネージャーは安定したストレージに新旧のデータを記録します。したがって、システム障害が発生してもリソース マネージャーはデータを回復できます。</span><span class="sxs-lookup"><span data-stu-id="5a443-128">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="5a443-129">リソース マネージャーは準備が整うと、トランザクションをコミットまたは中止するかどうかの決定をトランザクション マネージャーに通知します。</span><span class="sxs-lookup"><span data-stu-id="5a443-129">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="5a443-130">いずれかのリソース マネージャーが準備の失敗を報告すると、トランザクション マネージャーは各リソース マネージャーにロールバック コマンドを送信し、アプリケーションにコミットの失敗を通知します。</span><span class="sxs-lookup"><span data-stu-id="5a443-130">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="5a443-131">準備が整うと、リソース マネージャーは、フェーズ 2 でトランザクション マネージャーからコミットまたは中止のコールバックを取得するまで待機する必要があります。</span><span class="sxs-lookup"><span data-stu-id="5a443-131">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="5a443-132">通常、準備とコミット プロトコルの全体は瞬時に完了します。</span><span class="sxs-lookup"><span data-stu-id="5a443-132">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="5a443-133">システムまたは通信に障害が発生した場合、コミットまたは中止の通知が数分または数時間経っても到着しないことがあります。</span><span class="sxs-lookup"><span data-stu-id="5a443-133">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="5a443-134">この間、リソース マネージャーはトランザクションの結果について判断できず、</span><span class="sxs-lookup"><span data-stu-id="5a443-134">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="5a443-135">トランザクションがコミットまたは中止されたかどうかを認識できません。</span><span class="sxs-lookup"><span data-stu-id="5a443-135">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="5a443-136">トランザクションについて判断できない間、リソース マネージャーはトランザクションをロックし続けてデータの変更を維持し、これらの変更部分を他のトランザクションから分離した状態にします。</span><span class="sxs-lookup"><span data-stu-id="5a443-136">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="5a443-137">リソース マネージャーが失敗すると、そのすべての参加トランザクションは、失敗前に準備またはコミットされたものを除いて中止されます。</span><span class="sxs-lookup"><span data-stu-id="5a443-137">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="5a443-138">永続的リソース マネージャーは再起動時に、準備フェーズで書き込まれた準備情報を取得することにより、管理するリソースのコミット状態を再構築し、それに応じてトランザクションをコミットまたは中止します。</span><span class="sxs-lookup"><span data-stu-id="5a443-138">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="5a443-139">要約すると、2 フェーズ コミット プロトコルとリソース マネージャーの組み合わせにより、トランザクションの原子性と永続性が実現されます。</span><span class="sxs-lookup"><span data-stu-id="5a443-139">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="5a443-140"><xref:System.Transactions.Transaction> クラスは、PSPE (Promotable Single Phase Enlistment) を参加させるための <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> メソッドも提供しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-140">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="5a443-141">これにより、永続的リソース マネージャー (RM) は、MSDTC による管理のために後で必要に応じてエスカレートできるトランザクションをホストおよび "所有" できます。</span><span class="sxs-lookup"><span data-stu-id="5a443-141">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="5a443-142">詳細については、「[単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化](optimization-spc-and-promotable-spn.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="5a443-142">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="5a443-143">このセクションの内容</span><span class="sxs-lookup"><span data-stu-id="5a443-143">In This Section</span></span>  
 <span data-ttu-id="5a443-144">リソース マネージャーが通常実行する手順の概要については、次のトピックを参照してください。</span><span class="sxs-lookup"><span data-stu-id="5a443-144">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="5a443-145">トランザクションの参加要素としてのリソースの参加</span><span class="sxs-lookup"><span data-stu-id="5a443-145">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="5a443-146">永続性リソースまたは揮発性リソースがトランザクションに参加する方法について説明しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-146">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="5a443-147">単一フェースおよび複数フェーズでのトランザクションのコミット</span><span class="sxs-lookup"><span data-stu-id="5a443-147">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="5a443-148">リソース マネージャーがコミット通知に応答し、コミットの準備を行うしくみについて説明しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-148">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="5a443-149">回復の実行</span><span class="sxs-lookup"><span data-stu-id="5a443-149">Performing Recovery</span></span>](performing-recovery.md)  
  
 <span data-ttu-id="5a443-150">永続的リソース マネージャーが、どのようにエラーから回復するかについて説明しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-150">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="5a443-151">リソースへのアクセス時のセキュリティ信頼レベル</span><span class="sxs-lookup"><span data-stu-id="5a443-151">Security Trust Levels in Accessing Resources</span></span>](security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="5a443-152">System.Transactions の 3 つの信頼レベルで、<xref:System.Transactions> が公開するリソースの種類に対するアクセスがどのように制限されるかについて説明しています。</span><span class="sxs-lookup"><span data-stu-id="5a443-152">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="5a443-153">単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化</span><span class="sxs-lookup"><span data-stu-id="5a443-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="5a443-154">リソース マネージャーの実装に使用できる最適化の技法について説明します。</span><span class="sxs-lookup"><span data-stu-id="5a443-154">Describes optimization practices available to implementations of resource managers.</span></span>
