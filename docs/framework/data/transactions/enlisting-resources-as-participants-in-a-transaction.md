---
title: トランザクションの参加要素としてのリソースの参加
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: 83d83df0f747198e93dd64308b904cad5c7439ec
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205981"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a><span data-ttu-id="ebf77-102">トランザクションの参加要素としてのリソースの参加</span><span class="sxs-lookup"><span data-stu-id="ebf77-102">Enlisting Resources as Participants in a Transaction</span></span>

<span data-ttu-id="ebf77-103">トランザクションに参加する各リソースは、リソース マネージャーによって管理され、その動作はトランザクション マネージャーによって調整されます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-103">Each resource participating in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="ebf77-104">この調整は、トランザクション マネージャーを介してトランザクションに参加したサブスクライバーへの通知によって行われます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-104">The coordination is done through notifications given to subscribers who have enlisted in a transaction through the transaction manager.</span></span>

<span data-ttu-id="ebf77-105">ここでは、単一または複数のリソースがトランザクションに参加する方法と、さまざまな種類の参加について説明します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-105">This topic covers how a resource (or multiple resources) can be enlisted in a transaction, as well as the different types of enlistment.</span></span> <span data-ttu-id="ebf77-106">「[フェーズおよび複数フェーズでのトランザクションのコミット](committing-a-transaction-in-single-phase-and-multi-phase.md)」のトピックでは、参加リソース間でトランザクションのコミットメントを調整する方法について説明しています。</span><span class="sxs-lookup"><span data-stu-id="ebf77-106">The [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) topic covers how transaction commitment can be coordinated among enlisted resources.</span></span>

## <a name="enlisting-resources-in-a-transaction"></a><span data-ttu-id="ebf77-107">トランザクションへのリソースの参加</span><span class="sxs-lookup"><span data-stu-id="ebf77-107">Enlisting Resources in a Transaction</span></span>

<span data-ttu-id="ebf77-108">リソースをトランザクションに参加させるには、リソースをトランザクションに登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-108">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="ebf77-109"><xref:System.Transactions.Transaction> クラスは、この機能を提供する一連のメソッドを定義しています。これらのメソッドの名前は **Enlist** で始まります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-109">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="ebf77-110">さまざまな **Enlist** メソッドは、リソース マネージャーが持つ各種の参加リストにそれぞれ対応しています。</span><span class="sxs-lookup"><span data-stu-id="ebf77-110">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="ebf77-111">具体的には、揮発性リソースには <xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッド、永続性リソースには <xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-111">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="ebf77-112">リソース マネージャーの永続性または揮発性とは、リソース マネージャーがエラーの回復をサポートするかどうかを意味します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-112">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="ebf77-113">リソース マネージャーがエラーの回復をサポートする場合、フェーズ 1 (準備) 中にデータが永続ストレージに保存されます。したがって、リソース マネージャーがダウンした場合でも、回復時にトランザクションへの再参加を行い、TM から受信した通知に基づいて適切な動作を実行できます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-113">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the TM.</span></span> <span data-ttu-id="ebf77-114">一般に、揮発性リソース マネージャーは、メモリ内のデータ構造 (たとえば、メモリ内のトランザクション ハッシュ テーブル) などの揮発性リソースを管理し、永続的リソース マネージャーは、より永続的なバッキング ストアを持つリソース (たとえば、バッキング ストアがディスクであるデータベース) を管理します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-114">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>

<span data-ttu-id="ebf77-115">簡単に説明すると、リソースが永続性をサポートするかどうかに応じて、<xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドまたは <xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッドのどちらを使用するかを決定した後、リソース マネージャーに <xref:System.Transactions.IEnlistmentNotification> インターフェイスを実装して、2 フェーズ コミット (2PC) に参加するようにリソースを登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-115">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="ebf77-116">2PC の詳細については、「[単一フェーズおよび複数フェーズでのトランザクションのコミット](committing-a-transaction-in-single-phase-and-multi-phase.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-116">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>

<span data-ttu-id="ebf77-117"><xref:System.Transactions.Transaction.EnlistDurable%2A> および <xref:System.Transactions.Transaction.EnlistVolatile%2A> を複数回呼び出すことにより、これらのプロトコルのうち、複数のプロトコルに単一の参加要素を参加させることができます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-117">A single participant can enlist for more than one of these protocols by calling <xref:System.Transactions.Transaction.EnlistDurable%2A> and <xref:System.Transactions.Transaction.EnlistVolatile%2A> multiple times.</span></span>

### <a name="durable-enlistment"></a><span data-ttu-id="ebf77-118">永続的参加リスト</span><span class="sxs-lookup"><span data-stu-id="ebf77-118">Durable Enlistment</span></span>

<span data-ttu-id="ebf77-119"><xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドは、リソース マネージャーを永続性リソースとしてトランザクションに参加させるために使用します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-119">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods are used to enlist a resource manager for participation in the transaction as a durable resource.</span></span>  <span data-ttu-id="ebf77-120">永続的リソース マネージャーがトランザクション中にダウンした場合、リソース マネージャーはオンラインに戻った後、フェーズ 2 が完了していない参加要素を <xref:System.Transactions.TransactionManager.Reenlist%2A> メソッドを使用してすべてのトランザクションに再参加させ、回復を実行します。回復プロセスが完了したら、<xref:System.Transactions.TransactionManager.RecoveryComplete%2A> を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-120">It is expected that if a durable resource manager is brought down in the middle of a transaction, it can perform recovery once it is brought back online by reenlisting (using the <xref:System.Transactions.TransactionManager.Reenlist%2A> method) in all transactions in which it was a participant and did not complete phase 2, and call <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> once it finishes recovery processing.</span></span> <span data-ttu-id="ebf77-121">回復の詳細については、「[回復の実行](performing-recovery.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-121">For more information on recovery, see [Performing Recovery](performing-recovery.md).</span></span>

<span data-ttu-id="ebf77-122">すべての <xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドは、最初のパラメーターとして <xref:System.Guid> オブジェクトを使用します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-122">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods all take a <xref:System.Guid> object as their first parameter.</span></span> <span data-ttu-id="ebf77-123">トランザクション マネージャーは、この <xref:System.Guid> を使用して、永続参加リストと特定のリソース マネージャーを関連付けます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-123">The <xref:System.Guid> is used by the transaction manager to associate a durable enlistment with a particular resource manager.</span></span> <span data-ttu-id="ebf77-124">そのため、リソース マネージャーが再起動時に自身を他のリソース マネージャーと識別できるように、一貫して同じ <xref:System.Guid> を使用することが不可欠です。そうでない場合、回復が失敗する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-124">As such, it is imperative that a resource manager consistently uses the same <xref:System.Guid> to identify itself even across different resource managers upon restarting, otherwise the recovery can fail.</span></span>

<span data-ttu-id="ebf77-125"><xref:System.Transactions.Transaction.EnlistDurable%2A> メソッドの第 2 パラメーターは、トランザクション通知を受信するためにリソース マネージャーが実装するオブジェクトへの参照です。</span><span class="sxs-lookup"><span data-stu-id="ebf77-125">The second parameter of the <xref:System.Transactions.Transaction.EnlistDurable%2A> method is a reference to the object that the resource manager implements to receive transaction notifications.</span></span> <span data-ttu-id="ebf77-126">使用するオーバーロードにより、リソース マネージャーが単一フェーズ コミット (SPC) の最適化をサポートするかどうかがトランザクション マネージャーに通知されます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-126">The overload you use informs the transaction manager whether your resource manager supports the Single Phase Commit (SPC) optimization.</span></span> <span data-ttu-id="ebf77-127">ほとんどの場合、2 フェーズ コミット (2PC) に参加するために <xref:System.Transactions.IEnlistmentNotification> インターフェイスを実装します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-127">Most of the time you would implement the <xref:System.Transactions.IEnlistmentNotification> interface to take part in Two-Phase Commit (2PC).</span></span> <span data-ttu-id="ebf77-128">ただし、コミット プロセスを最適化する場合は、SPC 用の <xref:System.Transactions.ISinglePhaseNotification> インターフェイスの実装を検討することもできます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-128">However, if you want to optimize the commit process, you can consider implementing the <xref:System.Transactions.ISinglePhaseNotification> interface for SPC.</span></span> <span data-ttu-id="ebf77-129">SPC の詳細については、「[フェーズおよび複数フェーズでのトランザクションのコミット](committing-a-transaction-in-single-phase-and-multi-phase.md)」および「[単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化](optimization-spc-and-promotable-spn.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-129">For more information on SPC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) and [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

<span data-ttu-id="ebf77-130">第 3 パラメーターは <xref:System.Transactions.EnlistmentOptions> 列挙体であり、その値は <xref:System.Transactions.EnlistmentOptions.None> または <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired> のいずれかです。</span><span class="sxs-lookup"><span data-stu-id="ebf77-130">The third parameter is an <xref:System.Transactions.EnlistmentOptions> enumeration, whose value can be either <xref:System.Transactions.EnlistmentOptions.None> or <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span></span> <span data-ttu-id="ebf77-131">この値が <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired> に設定されている場合、トランザクション マネージャーから Prepare 通知を受信したときに、参加リストが追加リソース マネージャーを参加させる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-131">If the value is set to <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, the enlistment may enlist additional resource managers upon receiving the Prepare notification from the transaction manager.</span></span> <span data-ttu-id="ebf77-132">ただし、この種類の参加リストは単一フェーズ コミットの最適化の条件を満たさないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-132">However, you should be aware that this type of enlistment is not eligible for the Single Phase Commit optimization.</span></span>

### <a name="volatile-enlistment"></a><span data-ttu-id="ebf77-133">揮発性参加リスト</span><span class="sxs-lookup"><span data-stu-id="ebf77-133">Volatile Enlistment</span></span>

<span data-ttu-id="ebf77-134">キャッシュなどの揮発性リソースを管理する参加要素は、<xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッドを使用して参加させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-134">Participants managing volatile resources such as a cache should enlist using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods.</span></span> <span data-ttu-id="ebf77-135">このようなオブジェクトは、トランザクションの結果を取得したり、システム障害の後で、参加しているトランザクションの状態を回復したりできない場合があります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-135">Such objects might not be able to obtain the outcome of a transaction or recover the state of any transaction they participate in after a system failure.</span></span>

<span data-ttu-id="ebf77-136">前に述べたように、リソース マネージャーはメモリ内の揮発性リソースを管理する場合、揮発性参加リストを作成します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-136">As stated previously, a resource manager would make a volatile enlistment if it manages an in-memory, volatile resource.</span></span> <span data-ttu-id="ebf77-137"><xref:System.Transactions.Transaction.EnlistVolatile%2A> を使用する利点の 1 つに、トランザクションの不要なエスカレーションを強制しないことがあります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-137">One of the benefits of using <xref:System.Transactions.Transaction.EnlistVolatile%2A> is that it does not force an unnecessary escalation of the transaction.</span></span> <span data-ttu-id="ebf77-138">トランザクションのエスカレーションの詳細については、「[トランザクション管理のエスカレーション](transaction-management-escalation.md)」のトピックを参照してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-138">For more information on transaction escalation, see [Transaction Management Escalation](transaction-management-escalation.md) topic.</span></span> <span data-ttu-id="ebf77-139">揮発的な参加を行うことは、トランザクション マネージャーによる参加リストの処理方法、およびトランザクション マネージャーがリソース マネージャーに期待することの両方に相違が生じることを意味します。</span><span class="sxs-lookup"><span data-stu-id="ebf77-139">Enlisting volatility implies both a difference in how the enlistment is handled by the transaction manager, as well as what is expected of the resource manager by the transaction manager.</span></span> <span data-ttu-id="ebf77-140">これは、揮発性リソース マネージャーが回復を実行しないためです。</span><span class="sxs-lookup"><span data-stu-id="ebf77-140">This is because a volatile resource manager does not perform recovery.</span></span> <span data-ttu-id="ebf77-141">揮発性リソース マネージャーが回復を実行せず、<xref:System.Transactions.Transaction.EnlistVolatile%2A> を必要とする <xref:System.Guid> メソッドを呼び出さないため、<xref:System.Transactions.TransactionManager.Reenlist%2A> メソッドは <xref:System.Guid> パラメーターを取得しません。</span><span class="sxs-lookup"><span data-stu-id="ebf77-141">The <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods do not take a <xref:System.Guid> parameter, because a volatile resource manager does not perform recovery and would not call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method which needs a <xref:System.Guid>.</span></span>

<span data-ttu-id="ebf77-142">永続的参加リストの場合と同様に、どのオーバーロード メソッドを使用して参加する場合でも、リソース マネージャーが単一フェーズ コミットの最適化をサポートするかどうかがトランザクション マネージャーに示されます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-142">As with durable enlistments, whichever overload method you use to enlist denotes to the transaction manager whether your resource manager supports the Single Phase Commit optimization.</span></span> <span data-ttu-id="ebf77-143">揮発性リソース マネージャーが回復を実行できないため、準備フェーズ中、回復情報は揮発性参加リストに書き込まれません。</span><span class="sxs-lookup"><span data-stu-id="ebf77-143">Since a volatile resource manager cannot perform recovery, no recovery information is written for a volatile enlistment during the Prepare phase.</span></span> <span data-ttu-id="ebf77-144">したがって、<xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> メソッドを呼び出すと、<xref:System.InvalidOperationException> になります。</span><span class="sxs-lookup"><span data-stu-id="ebf77-144">Therefore, calling the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> method results in an <xref:System.InvalidOperationException>.</span></span>

<span data-ttu-id="ebf77-145">次の例は、<xref:System.Transactions.Transaction.EnlistVolatile%2A> メソッドを使用して、このようなオブジェクトを参加要素としてトランザクションに参加させる方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="ebf77-145">The following example shows how to enlist such an object as a participant in a transaction using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span>

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a><span data-ttu-id="ebf77-146">パフォーマンスの最適化</span><span class="sxs-lookup"><span data-stu-id="ebf77-146">Optimizing Performance</span></span>

<span data-ttu-id="ebf77-147"><xref:System.Transactions.Transaction> クラスは、PSPE (Promotable Single Phase Enlistment) を参加させるための <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> メソッドも提供しています。</span><span class="sxs-lookup"><span data-stu-id="ebf77-147">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="ebf77-148">これにより、永続的リソース マネージャー (RM) は、MSDTC による管理のために後で必要に応じてエスカレートできるトランザクションをホストおよび "所有" できます。</span><span class="sxs-lookup"><span data-stu-id="ebf77-148">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="ebf77-149">詳細については、「[単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化](optimization-spc-and-promotable-spn.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="ebf77-149">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="ebf77-150">関連項目</span><span class="sxs-lookup"><span data-stu-id="ebf77-150">See also</span></span>

- [<span data-ttu-id="ebf77-151">単一フェーズ コミットおよび昇格可能単一フェーズ通知を使用した最適化</span><span class="sxs-lookup"><span data-stu-id="ebf77-151">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)
- [<span data-ttu-id="ebf77-152">単一フェースおよび複数フェーズでのトランザクションのコミット</span><span class="sxs-lookup"><span data-stu-id="ebf77-152">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
