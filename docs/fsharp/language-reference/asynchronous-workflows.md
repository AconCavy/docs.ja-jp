---
title: 非同期ワークフロー
description: 'F # プログラミング言語でのサポートについて説明します。これは、他の作業の実行をブロックすることなく実行される計算を非同期に実行します。'
ms.date: 05/16/2016
ms.openlocfilehash: 3bc24639b329401a8f944488e974f0739d4680df
ms.sourcegitcommit: c37e8d4642fef647ebab0e1c618ecc29ddfe2a0f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/06/2020
ms.locfileid: "87855466"
---
# <a name="asynchronous-workflows"></a><span data-ttu-id="c1ab7-103">非同期ワークフロー</span><span class="sxs-lookup"><span data-stu-id="c1ab7-103">Asynchronous workflows</span></span>

<span data-ttu-id="c1ab7-104">この記事では、計算を非同期的に実行する F # のサポートについて説明します。つまり、他の作業の実行をブロックすることはありません。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-104">This article describes support in F# for performing computations asynchronously, that is, without blocking execution of other work.</span></span> <span data-ttu-id="c1ab7-105">たとえば、非同期計算を使用して、アプリケーションが他の作業を実行するときにユーザーに応答し続ける Ui を持つアプリケーションを作成できます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-105">For example, asynchronous computations can be used to write applications that have UIs that remain responsive to users as the application performs other work.</span></span>

> [!NOTE]
> <span data-ttu-id="c1ab7-106">F # の docs.microsoft.com API リファレンスが完全ではありません。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-106">The docs.microsoft.com API reference for F# is not complete.</span></span> <span data-ttu-id="c1ab7-107">壊れたリンクが見つかった場合は、代わりに[F # コアライブラリのドキュメント](https://fsharp.github.io/fsharp-core-docs/)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-107">If you encounter any broken links, reference [F# Core Library Documentation](https://fsharp.github.io/fsharp-core-docs/) instead.</span></span>

## <a name="syntax"></a><span data-ttu-id="c1ab7-108">構文</span><span class="sxs-lookup"><span data-stu-id="c1ab7-108">Syntax</span></span>

```fsharp
async { expression }
```

## <a name="remarks"></a><span data-ttu-id="c1ab7-109">Remarks</span><span class="sxs-lookup"><span data-stu-id="c1ab7-109">Remarks</span></span>

<span data-ttu-id="c1ab7-110">前の構文では、によって表される計算 `expression` が非同期的に実行されるように設定されています。つまり、非同期スリープ操作、i/o、およびその他の非同期操作が実行されるときに、現在の計算スレッドをブロックしません。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-110">In the previous syntax, the computation represented by `expression` is set up to run asynchronously, that is, without blocking the current computation thread when asynchronous sleep operations, I/O, and other asynchronous operations are performed.</span></span> <span data-ttu-id="c1ab7-111">非同期計算は、多くの場合、現在のスレッドで実行を継続しながらバックグラウンドスレッドで開始されます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-111">Asynchronous computations are often started on a background thread while execution continues on the current thread.</span></span> <span data-ttu-id="c1ab7-112">式の型はです `Async<'T>` 。ここで、 `'T` は、 `return` キーワードが使用されている場合に、式によって返される型です。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-112">The type of the expression is `Async<'T>`, where `'T` is the type returned by the expression when the `return` keyword is used.</span></span> <span data-ttu-id="c1ab7-113">このような式のコードは、*非同期ブロック*または非同期*ブロック*と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-113">The code in such an expression is referred to as an *asynchronous block*, or *async block*.</span></span>

<span data-ttu-id="c1ab7-114">非同期プログラミングにはさまざまな方法があり、クラスには [`Async`](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7) いくつかのシナリオをサポートするメソッドが用意されています。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-114">There are a variety of ways of programming asynchronously, and the [`Async`](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7) class provides methods that support several scenarios.</span></span> <span data-ttu-id="c1ab7-115">一般的な方法では、 `Async` 非同期的に実行する計算または計算を表すオブジェクトを作成し、トリガー関数のいずれかを使用して、これらの計算を開始します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-115">The general approach is to create `Async` objects that represent the computation or computations that you want to run asynchronously, and then start these computations by using one of the triggering functions.</span></span> <span data-ttu-id="c1ab7-116">さまざまなトリガー関数は、非同期計算を実行するさまざまな方法を提供します。どちらを使用するかは、現在のスレッド、バックグラウンドスレッド、.NET Framework タスクオブジェクトを使用するかどうか、および計算が終了したときに実行する必要のある継続関数があるかどうかによって異なります。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-116">The various triggering functions provide different ways of running asynchronous computations, and which one you use depends on whether you want to use the current thread, a background thread, or a .NET Framework task object, and whether there are continuation functions that should run when the computation finishes.</span></span> <span data-ttu-id="c1ab7-117">たとえば、現在のスレッドで非同期計算を開始するには、を使用し [`Async.StartImmediate`](https://msdn.microsoft.com/library/2f71d1cc-187f-48cf-ac66-e7fda41c46e3) ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-117">For example, to start an asynchronous computation on the current thread, you can use [`Async.StartImmediate`](https://msdn.microsoft.com/library/2f71d1cc-187f-48cf-ac66-e7fda41c46e3).</span></span> <span data-ttu-id="c1ab7-118">UI スレッドから非同期計算を開始する場合は、キーストロークやマウスアクティビティなどのユーザー操作を処理するメインイベントループをブロックしないため、アプリケーションの応答性が維持されます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-118">When you start an asynchronous computation from the UI thread, you do not block the main event loop that processes user actions such as keystrokes and mouse activity, so your application remains responsive.</span></span>

## <a name="asynchronous-binding-by-using-let"></a><span data-ttu-id="c1ab7-119">Let を使用した非同期バインド</span><span class="sxs-lookup"><span data-stu-id="c1ab7-119">Asynchronous Binding by Using let!</span></span>

<span data-ttu-id="c1ab7-120">非同期ワークフローでは、一部の式と操作は同期的であり、一部の式と操作は、非同期的に結果を返すように設計された、より長い計算です。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-120">In an asynchronous workflow, some expressions and operations are synchronous, and some are longer computations that are designed to return a result asynchronously.</span></span> <span data-ttu-id="c1ab7-121">通常のバインディングではなく、メソッドを非同期的に呼び出す場合は、を `let` 使用し `let!` ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-121">When you call a method asynchronously, instead of an ordinary `let` binding, you use `let!`.</span></span> <span data-ttu-id="c1ab7-122">の効果は、 `let!` 計算の実行中に、他の計算やスレッドで実行を継続できるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-122">The effect of `let!` is to enable execution to continue on other computations or threads as the computation is being performed.</span></span> <span data-ttu-id="c1ab7-123">バインディングの右側から制御が戻った後、 `let!` 非同期ワークフローの残りの部分は実行を再開します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-123">After the right side of the `let!` binding returns, the rest of the asynchronous workflow resumes execution.</span></span>

<span data-ttu-id="c1ab7-124">次のコードは、との違いを示して `let` `let!` います。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-124">The following code shows the difference between `let` and `let!`.</span></span> <span data-ttu-id="c1ab7-125">を使用するコード行で `let` は、またはなどを使用して後で実行できるオブジェクトとして非同期計算を作成し `Async.StartImmediate` [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b) ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-125">The line of code that uses `let` just creates an asynchronous computation as an object that you can run later by using, for example, `Async.StartImmediate` or [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b).</span></span> <span data-ttu-id="c1ab7-126">を使用するコード行によって計算が開始され、その `let!` 後、結果が使用可能になるまでスレッドが中断されます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-126">The line of code that uses `let!` starts the computation, and then the thread is suspended until the result is available, at which point execution continues.</span></span>

```fsharp
// let just stores the result as an asynchronous operation.
let (result1 : Async<byte[]>) = stream.AsyncRead(bufferSize)
// let! completes the asynchronous operation and returns the data.
let! (result2 : byte[])  = stream.AsyncRead(bufferSize)
```

<span data-ttu-id="c1ab7-127">に加えて `let!` 、を使用して非同期バインディングを実行することもでき `use!` ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-127">In addition to `let!`, you can use `use!` to perform asynchronous bindings.</span></span> <span data-ttu-id="c1ab7-128">との違い `let!` は、との違い `use!` と同じです `let` `use` 。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-128">The difference between `let!` and `use!` is the same as the difference between `let` and `use`.</span></span> <span data-ttu-id="c1ab7-129">の場合 `use!` 、オブジェクトは現在のスコープの終了時に破棄されます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-129">For `use!`, the object is disposed of at the close of the current scope.</span></span> <span data-ttu-id="c1ab7-130">現在のリリースの F # 言語では、がの場合でも、値を null に初期化することはできないことに注意して `use!` `use` ください。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-130">Note that in the current release of the F# language, `use!` does not allow a value to be initialized to null, even though `use` does.</span></span>

## <a name="asynchronous-primitives"></a><span data-ttu-id="c1ab7-131">非同期プリミティブ</span><span class="sxs-lookup"><span data-stu-id="c1ab7-131">Asynchronous Primitives</span></span>

<span data-ttu-id="c1ab7-132">1つの非同期タスクを実行し、その結果を返すメソッドは、*非同期プリミティブ*と呼ばれ、専用に設計されてい `let!` ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-132">A method that performs a single asynchronous task and returns the result is called an *asynchronous primitive*, and these are designed specifically for use with `let!`.</span></span> <span data-ttu-id="c1ab7-133">いくつかの非同期プリミティブは、F # コアライブラリで定義されています。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-133">Several asynchronous primitives are defined in the F# core library.</span></span> <span data-ttu-id="c1ab7-134">このような Web アプリケーションの2つのメソッドは、モジュールで定義されて [`Microsoft.FSharp.Control.WebExtensions`](https://msdn.microsoft.com/library/95ef17bc-ee3f-44ba-8a11-c90fcf4cf003) [`WebRequest.AsyncGetResponse`](https://msdn.microsoft.com/library/09a60c31-e6e2-4b5c-ad23-92a86e50060c) [`WebClient.AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a) います。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-134">Two such methods for Web applications are defined in the module [`Microsoft.FSharp.Control.WebExtensions`](https://msdn.microsoft.com/library/95ef17bc-ee3f-44ba-8a11-c90fcf4cf003): [`WebRequest.AsyncGetResponse`](https://msdn.microsoft.com/library/09a60c31-e6e2-4b5c-ad23-92a86e50060c) and [`WebClient.AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a).</span></span> <span data-ttu-id="c1ab7-135">どちらのプリミティブも、URL を指定して Web ページからデータをダウンロードします。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-135">Both primitives download data from a Web page, given a URL.</span></span> <span data-ttu-id="c1ab7-136">`AsyncGetResponse`オブジェクトを生成 `System.Net.WebResponse` し、 `AsyncDownloadString` Web ページの HTML を表す文字列を生成します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-136">`AsyncGetResponse` produces a `System.Net.WebResponse` object, and `AsyncDownloadString` produces a string that represents the HTML for a Web page.</span></span>

<span data-ttu-id="c1ab7-137">非同期 i/o 操作のためのいくつかのプリミティブは、モジュールに含まれてい [`Microsoft.FSharp.Control.CommonExtensions`](https://msdn.microsoft.com/library/2edb67cb-6814-4a30-849f-b6dbdd042396) ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-137">Several primitives for asynchronous I/O operations are included in the [`Microsoft.FSharp.Control.CommonExtensions`](https://msdn.microsoft.com/library/2edb67cb-6814-4a30-849f-b6dbdd042396) module.</span></span> <span data-ttu-id="c1ab7-138">クラスの拡張メソッド `System.IO.Stream` は [`Stream.AsyncRead`](https://msdn.microsoft.com/library/85698aaa-bdda-47e6-abed-3730f59fda5e) 、と [`Stream.AsyncWrite`](https://msdn.microsoft.com/library/1b0a2751-e42a-47e1-bd27-020224adc618) です。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-138">These extension methods of the `System.IO.Stream` class are [`Stream.AsyncRead`](https://msdn.microsoft.com/library/85698aaa-bdda-47e6-abed-3730f59fda5e) and [`Stream.AsyncWrite`](https://msdn.microsoft.com/library/1b0a2751-e42a-47e1-bd27-020224adc618).</span></span>

<span data-ttu-id="c1ab7-139">また、完全な本文が非同期ブロックで囲まれた関数を定義することで、独自の非同期プリミティブを作成することもできます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-139">You can also write your own asynchronous primitives by defining a function whose complete body is enclosed in an async block.</span></span>

<span data-ttu-id="c1ab7-140">F # の非同期プログラミングモデルを使用して他の非同期モデル用にデザインされた .NET Framework で非同期メソッドを使用するには、F # オブジェクトを返す関数を作成し `Async` ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-140">To use asynchronous methods in the .NET Framework that are designed for other asynchronous models with the F# asynchronous programming model, you create a function that returns an F# `Async` object.</span></span> <span data-ttu-id="c1ab7-141">F # ライブラリには、これを簡単に実行できる関数が用意されています。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-141">The F# library has functions that make this easy to do.</span></span>

<span data-ttu-id="c1ab7-142">非同期ワークフローの使用例を次に示します。[非同期クラス](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7)のメソッドに関するドキュメントには、他にも多くのものがあります。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-142">One example of using asynchronous workflows is included here; there are many others in the documentation for the methods of the [Async class](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7).</span></span>

<span data-ttu-id="c1ab7-143">この例では、非同期ワークフローを使用して並列で計算を実行する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-143">This example shows how to use asynchronous workflows to perform computations in parallel.</span></span>

<span data-ttu-id="c1ab7-144">次のコード例では、関数は `fetchAsync` Web 要求から返された HTML テキストを取得します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-144">In the following code example, a function `fetchAsync` gets the HTML text returned from a Web request.</span></span> <span data-ttu-id="c1ab7-145">関数には、 `fetchAsync` 非同期のコードブロックが含まれています。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-145">The `fetchAsync` function contains an asynchronous block of code.</span></span> <span data-ttu-id="c1ab7-146">非同期プリミティブの結果にバインドする場合は、次のようにし [`AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a) ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-146">When a binding is made to the result of an asynchronous primitive, in this case [`AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a), let!</span></span> <span data-ttu-id="c1ab7-147">let ではなくを使用します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-147">is used instead of let.</span></span>

<span data-ttu-id="c1ab7-148">関数を使用し [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b) て非同期操作を実行し、その結果を待機します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-148">You use the function [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b) to execute an asynchronous operation and wait for its result.</span></span> <span data-ttu-id="c1ab7-149">例として、関数を関数と共に使用することで、複数の非同期操作を並列で実行でき [`Async.Parallel`](https://msdn.microsoft.com/library/aa9b0355-2d55-4858-b943-cbe428de9dc4) `Async.RunSynchronously` ます。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-149">As an example, you can execute multiple asynchronous operations in parallel by using the [`Async.Parallel`](https://msdn.microsoft.com/library/aa9b0355-2d55-4858-b943-cbe428de9dc4) function together with the `Async.RunSynchronously` function.</span></span> <span data-ttu-id="c1ab7-150">関数は、 `Async.Parallel` オブジェクトの一覧を取得し `Async` 、各タスクオブジェクトのコードを `Async` 並列で実行するように設定し、 `Async` 並列計算を表すオブジェクトを返します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-150">The `Async.Parallel` function takes a list of the `Async` objects, sets up the code for each `Async` task object to run in parallel, and returns an `Async` object that represents the parallel computation.</span></span> <span data-ttu-id="c1ab7-151">1回の操作と同じように、を呼び出して `Async.RunSynchronously` 実行を開始します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-151">Just as for a single operation, you call `Async.RunSynchronously` to start the execution.</span></span>

<span data-ttu-id="c1ab7-152">関数は、 `runAll` 3 つの非同期ワークフローを並列で起動し、すべてが完了するまで待機します。</span><span class="sxs-lookup"><span data-stu-id="c1ab7-152">The `runAll` function launches three asynchronous workflows in parallel and waits until they have all completed.</span></span>

[!code-fsharp[Main](~/samples/snippets/fsharp/lang-ref-2/snippet8003.fs)]

## <a name="see-also"></a><span data-ttu-id="c1ab7-153">関連項目</span><span class="sxs-lookup"><span data-stu-id="c1ab7-153">See also</span></span>

- [<span data-ttu-id="c1ab7-154">F# 言語リファレンス</span><span class="sxs-lookup"><span data-stu-id="c1ab7-154">F# Language Reference</span></span>](index.md)
- [<span data-ttu-id="c1ab7-155">コンピュテーション式</span><span class="sxs-lookup"><span data-stu-id="c1ab7-155">Computation Expressions</span></span>](computation-expressions.md)
- [<span data-ttu-id="c1ab7-156">Control. Async クラス</span><span class="sxs-lookup"><span data-stu-id="c1ab7-156">Control.Async Class</span></span>](https://msdn.microsoft.com/visualfsharpdocs/conceptual/control.async-class-%5bfsharp%5d)
